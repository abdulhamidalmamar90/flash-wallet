
--- START: /src/hooks/use-mobile.tsx ---
import * as React from "react"

const MOBILE_BREAKPOINT = 768

export function useIsMobile() {
  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)

  React.useEffect(() => {
    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)
    const onChange = () => {
      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    }
    mql.addEventListener("change", onChange)
    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    return () => mql.removeEventListener("change", onChange)
  }, [])

  return !!isMobile
}


--- START: /src/firebase/provider.tsx ---
'use client';

import React, { createContext, useContext, ReactNode } from 'react';
import { FirebaseApp } from 'firebase/app';
import { Firestore } from 'firebase/firestore';
import { Auth } from 'firebase/auth';
import { FirebaseErrorListener } from '@/components/FirebaseErrorListener';

interface FirebaseContextType {
  app: FirebaseApp;
  firestore: Firestore;
  auth: Auth;
}

const FirebaseContext = createContext<FirebaseContextType | undefined>(undefined);

export function FirebaseProvider({
  children,
  app,
  firestore,
  auth,
}: {
  children: ReactNode;
  app: FirebaseApp;
  firestore: Firestore;
  auth: Auth;
}) {
  return (
    <FirebaseContext.Provider value={{ app, firestore, auth }}>
      <FirebaseErrorListener />
      {children}
    </FirebaseContext.Provider>
  );
}

export function useFirebase() {
  const context = useContext(FirebaseContext);
  if (!context) throw new Error('useFirebase must be used within a FirebaseProvider');
  return context;
}

export function useFirebaseApp() {
  return useFirebase().app;
}

export function useFirestore() {
  return useFirebase().firestore;
}

export function useAuth() {
  return useFirebase().auth;
}


--- START: /src/firebase/client-provider.tsx ---
'use client';

import React, { useMemo } from 'react';
import { initializeFirebase } from './index';
import { FirebaseProvider } from './provider';

export function FirebaseClientProvider({ children }: { children: React.ReactNode }) {
  const { app, firestore, auth } = useMemo(() => initializeFirebase(), []);

  return (
    <FirebaseProvider app={app} firestore={firestore} auth={auth}>
      {children}
    </FirebaseProvider>
  );
}


--- START: /src/firebase/firestore/use-collection.tsx ---
'use client';

import { useEffect, useState } from 'react';
import {
  Query,
  onSnapshot,
  QuerySnapshot,
  DocumentData,
  FirestoreError,
} from 'firebase/firestore';

export function useCollection<T = DocumentData>(query: Query<T> | null) {
  const [data, setData] = useState<T[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<FirestoreError | null>(null);

  useEffect(() => {
    if (!query) {
      setLoading(false);
      return;
    }

    setLoading(true);
    const unsubscribe = onSnapshot(
      query,
      (snapshot: QuerySnapshot<T>) => {
        const docs = snapshot.docs.map((doc) => ({
          ...doc.data(),
          id: doc.id,
        }));
        setData(docs);
        setLoading(false);
      },
      (err) => {
        setError(err);
        setLoading(false);
      }
    );

    return () => unsubscribe();
  }, [query]);

  return { data, loading, error };
}


--- START: /src/firebase/firestore/use-doc.tsx ---
'use client';

import { useEffect, useState } from 'react';
import {
  DocumentReference,
  onSnapshot,
  DocumentSnapshot,
  DocumentData,
  FirestoreError,
} from 'firebase/firestore';

export function useDoc<T = DocumentData>(docRef: DocumentReference<T> | null) {
  const [data, setData] = useState<T | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<FirestoreError | null>(null);

  useEffect(() => {
    if (!docRef) {
      setLoading(false);
      return;
    }

    setLoading(true);
    const unsubscribe = onSnapshot(
      docRef,
      (snapshot: DocumentSnapshot<T>) => {
        setData(snapshot.exists() ? { ...snapshot.data(), id: snapshot.id } as T : null);
        setLoading(false);
      },
      (err) => {
        setError(err);
        setLoading(false);
      }
    );

    return () => unsubscribe();
  }, [docRef]);

  return { data, loading, error };
}


--- START: /src/firebase/auth/use-user.tsx ---
'use client';

import { useEffect, useState } from 'react';
import { onAuthStateChanged, User } from 'firebase/auth';
import { useAuth } from '../provider';

export function useUser() {
  const auth = useAuth();
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    return onAuthStateChanged(auth, (user) => {
      setUser(user);
      setLoading(false);
    });
  }, [auth]);

  return { user, loading };
}


--- START: /src/app/globals.css ---
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    --background: 53 71% 92%; /* #F5F0CD - Creamy Yellow Background */
    --foreground: 240 10% 4%;
    --card: 0 0% 100%; /* #FFFFFF - Pure White Card */
    --card-foreground: 240 10% 10%;
    --popover: 0 0% 100%;
    --popover-foreground: 240 10% 4%;
    --primary: 45 94% 73%; /* #FADA7A - Vibrant Gold */
    --primary-foreground: 240 10% 10%;
    --secondary: 199 53% 68%; /* #81BFDA - Sky Blue */
    --secondary-foreground: 240 10% 10%;
    --muted: 0 0% 100%;
    --muted-foreground: 240 5% 40%;
    --accent: 45 94% 73%;
    --accent-foreground: 240 10% 10%;
    --destructive: 0 84% 60%;
    --destructive-foreground: 0 0% 98%;
    --border: 199 53% 68%;
    --input: 199 53% 68%;
    --ring: 45 94% 73%;
    --radius: 1.5rem;
  }

  .dark {
    --background: 240 10% 4%;
    --foreground: 0 0% 90%;
    --card: 240 10% 6%;
    --card-foreground: 0 0% 90%;
    --popover: 240 10% 6%;
    --popover-foreground: 0 0% 90%;
    --primary: 46 65% 52%;
    --primary-foreground: 0 0% 4%;
    --secondary: 184 100% 50%;
    --secondary-foreground: 0 0% 4%;
    --muted: 240 10% 12%;
    --muted-foreground: 240 5% 50%;
    --accent: 240 10% 12%;
    --accent-foreground: 0 0% 90%;
    --destructive: 0 84% 60%;
    --destructive-foreground: 0 0% 98%;
    --border: 240 10% 15%;
    --input: 240 10% 15%;
    --ring: 46 65% 52%;
  }
}

@layer base {
  * {
    @apply border-border;
  }
  body {
    @apply bg-background text-foreground font-body overflow-x-hidden antialiased transition-colors duration-300;
    background-image: radial-gradient(circle at 50% 0%, hsl(var(--primary) / 0.05), transparent 50%),
                      radial-gradient(circle at 0% 100%, hsl(var(--secondary) / 0.03), transparent 40%);
    background-attachment: fixed;
  }

  .font-headline {
    font-family: 'Orbitron', sans-serif;
  }

  .font-financial {
    font-family: 'Inter', sans-serif;
    font-variant-numeric: tabular-nums;
  }
}

@layer utilities {
  .glass-card {
    @apply bg-card/60 backdrop-blur-xl border border-border/40;
  }

  .gold-glow {
    box-shadow: 0 0 20px hsl(var(--primary) / 0.3);
  }

  .cyan-glow {
    box-shadow: 0 0 20px hsl(var(--secondary) / 0.3);
  }

  .dark .gold-glow {
    box-shadow: 0 0 25px hsl(var(--primary) / 0.4);
  }

  .dark .cyan-glow {
    box-shadow: 0 0 25px hsl(var(--secondary) / 0.4);
  }

  .gold-glow-text {
    text-shadow: 0 0 10px hsl(var(--primary) / 0.6);
  }
}

@layer components {
  .btn-primary {
    @apply bg-primary text-primary-foreground font-headline font-bold uppercase tracking-widest px-6 py-4 rounded-xl transition-all duration-300 hover:scale-[1.02] active:scale-[0.98];
  }
}

.page-fade {
  animation: fadeIn 0.5s ease-out forwards;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* --- Futuristic Input Styles (Unified Classes) --- */
.futuristic-grid-bg {
  height: 800px;
  width: 800px;
  background-image: linear-gradient(to right, #0f0f10 1px, transparent 1px),
    linear-gradient(to bottom, #0f0f10 1px, transparent 1px);
  background-size: 1rem 1rem;
  background-position: center center;
  position: absolute;
  z-index: -1;
  filter: blur(1px);
}

.futuristic-white,
.futuristic-border,
.futuristic-darkBorderBg,
.futuristic-glow {
  max-height: 70px;
  max-width: 314px;
  height: 100%;
  width: 100%;
  position: absolute;
  overflow: hidden;
  z-index: -1;
  border-radius: 12px;
  filter: blur(3px);
}

.futuristic-input {
  background-color: #010201 !important;
  border: none !important;
  width: 100%;
  max-width: 301px;
  height: 56px;
  border-radius: 10px;
  color: white !important;
  /* Fixed padding-right to accommodate icons regardless of RTL/LTR */
  padding-right: 85px !important;
  padding-left: 20px !important;
  font-size: 14px;
  font-family: inherit;
}

/* Autofill fix to prevent white background */
.futuristic-input:-webkit-autofill,
.futuristic-input:-webkit-autofill:hover,
.futuristic-input:-webkit-autofill:focus,
.futuristic-input:-webkit-autofill:active {
  -webkit-box-shadow: 0 0 0 1000px #010201 inset !important;
  -webkit-text-fill-color: white !important;
  transition: background-color 5000s ease-in-out 0s;
}

.futuristic-poda {
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  width: 100%;
}

.futuristic-input::placeholder {
  color: #c0b9c0;
  opacity: 0.5;
}

.futuristic-input:focus {
  outline: none;
}

.futuristic-main-area {
  position: relative;
  width: 100%;
  display: flex;
  justify-content: center;
}

.futuristic-main-area:focus-within > .futuristic-input-mask {
  display: none;
}

.futuristic-input-mask {
  pointer-events: none;
  width: 100px;
  height: 20px;
  position: absolute;
  background: linear-gradient(90deg, transparent, black);
  top: 18px;
  left: 20px;
}

.futuristic-cyan-mask {
  pointer-events: none;
  width: 30px;
  height: 20px;
  position: absolute;
  background: #00FFEE;
  top: 10px;
  left: 5px;
  filter: blur(20px);
  opacity: 0.8;
  transition: all 2s;
}

.futuristic-main-area:hover > .futuristic-cyan-mask {
  opacity: 0;
}

.futuristic-white {
  max-height: 63px;
  max-width: 307px;
  border-radius: 10px;
  filter: blur(2px);
}

.futuristic-white::before {
  content: "";
  z-index: -2;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(83deg);
  position: absolute;
  width: 600px;
  height: 600px;
  filter: brightness(1.4);
  background-image: conic-gradient(
    rgba(0, 0, 0, 0) 0%,
    #D4AE35,
    rgba(0, 0, 0, 0) 8%,
    rgba(0, 0, 0, 0) 50%,
    #00FFEE,
    rgba(0, 0, 0, 0) 58%
  );
  transition: all 2s;
}

.futuristic-border {
  max-height: 59px;
  max-width: 303px;
  border-radius: 11px;
  filter: blur(0.5px);
}

.futuristic-border::before {
  content: "";
  z-index: -2;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(70deg);
  position: absolute;
  width: 600px;
  height: 600px;
  filter: brightness(1.3);
  background-image: conic-gradient(
    #1c191c,
    #D4AE35 5%, 
    #1c191c 14%,
    #1c191c 50%,
    #00FFEE 60%, 
    #1c191c 64%
  );
  transition: all 2s;
}

.futuristic-darkBorderBg {
  max-height: 65px;
  max-width: 312px;
}

.futuristic-darkBorderBg::before {
  content: "";
  z-index: -2;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(82deg);
  position: absolute;
  width: 600px;
  height: 600px;
  background-image: conic-gradient(
    rgba(0, 0, 0, 0),
    #D4AE35, 
    rgba(0, 0, 0, 0) 10%,
    rgba(0, 0, 0, 0) 50%,
    #00FFEE, 
    rgba(0, 0, 0, 0) 60%
  );
  transition: all 2s;
}

.futuristic-poda:hover > .futuristic-darkBorderBg::before { transform: translate(-50%, -50%) rotate(-98deg); }
.futuristic-poda:hover > .futuristic-white::before { transform: translate(-50%, -50%) rotate(-97deg); }
.futuristic-poda:hover > .futuristic-border::before { transform: translate(-50%, -50%) rotate(-110deg); }

.futuristic-poda:focus-within > .futuristic-darkBorderBg::before { transform: translate(-50%, -50%) rotate(442deg); transition: all 4s; }
.futuristic-poda:focus-within > .futuristic-white::before { transform: translate(-50%, -50%) rotate(443deg); transition: all 4s; }
.futuristic-poda:focus-within > .futuristic-border::before { transform: translate(-50%, -50%) rotate(430deg); transition: all 4s; }

.futuristic-glow {
  overflow: hidden;
  filter: blur(30px);
  opacity: 0.4;
}

.futuristic-glow:before {
  content: "";
  z-index: -2;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(60deg);
  position: absolute;
  width: 999px;
  height: 999px;
  background-image: conic-gradient(
    #000,
    #D4AE35 5%, 
    #000 38%,
    #000 50%,
    #00FFEE 60%,
    #000 87%
  );
  transition: all 2s;
}

/* Icons are fixed to the physical right to maintain consistent UI architecture */
.futuristic-filter-icon {
  position: absolute;
  top: 8px;
  right: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2;
  max-height: 40px;
  max-width: 38px;
  height: 100%;
  width: 100%;
  border-radius: 10px;
  background: linear-gradient(180deg, #161329, black, #1d1b4b);
}

.futuristic-filterBorder {
  height: 42px;
  width: 40px;
  position: absolute;
  top: 7px;
  right: 7px;
  border-radius: 10px;
  overflow: hidden;
}

.futuristic-filterBorder::before {
  content: "";
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(90deg);
  position: absolute;
  width: 600px;
  height: 600px;
  background-image: conic-gradient(rgba(0,0,0,0), #D4AE35, rgba(0,0,0,0) 50%);
  animation: rotate-futuristic 4s linear infinite;
}

@keyframes rotate-futuristic {
  100% { transform: translate(-50%, -50%) rotate(450deg); }
}

--- START: /src/app/layout.tsx ---

import type {Metadata, Viewport} from 'next';
import './globals.css';
import { Toaster } from "@/components/ui/toaster";
import { LanguageHandler } from "@/components/layout/LanguageHandler";
import { ThemeHandler } from "@/components/layout/ThemeHandler";
import { FirebaseClientProvider } from '@/firebase/client-provider';
import { BottomNav } from '@/components/layout/BottomNav';

export const metadata: Metadata = {
  title: 'FLASH | Premium Digital Bank',
  description: 'High-authority financial ecosystem for precise digital asset management.',
  manifest: '/manifest.json',
  appleWebApp: {
    capable: true,
    statusBarStyle: 'black-translucent',
    title: 'FLASH',
  },
};

export const viewport: Viewport = {
  themeColor: '#0A0A0A',
  width: 'device-width',
  initialScale: 1,
  maximumScale: 1,
  userScalable: false,
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en" className="dark">
      <head>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossOrigin="anonymous" />
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@500;600;700;800&display=swap" rel="stylesheet" />
      </head>
      <body className="font-body antialiased bg-background selection:bg-primary/20">
        <FirebaseClientProvider>
          <LanguageHandler />
          <ThemeHandler />
          <main className="min-h-screen">
            <div className="page-fade">
              {children}
            </div>
            <BottomNav />
          </main>
          <Toaster />
        </FirebaseClientProvider>
      </body>
    </html>
  );
}


--- START: /src/app/page.tsx ---
"use client"

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { Mail, Lock, Loader2, ArrowRight, Eye, EyeOff, Fingerprint, User as UserIcon } from 'lucide-react';
import { useStore } from '@/app/lib/store';
import { useAuth, useUser, useFirestore } from '@/firebase';
import { 
  signInWithEmailAndPassword, 
  getRedirectResult,
  signOut 
} from 'firebase/auth';
import { collection, query, where, getDocs, limit } from 'firebase/firestore';
import { useToast } from '@/hooks/use-toast';
import Link from 'next/link';
import { PlaceHolderImages } from '@/app/lib/placeholder-images';
import { LanguageToggle } from '@/components/ui/LanguageToggle';
import { cn } from '@/lib/utils';
import { Capacitor } from '@capacitor/core';
import { NativeBiometric } from 'capacitor-native-biometric';
import { Preferences } from '@capacitor/preferences';

export default function LoginPage() {
  const router = useRouter();
  const auth = useAuth();
  const db = useFirestore();
  const { user, loading: authLoading } = useUser();
  const { toast } = useToast();
  const [loading, setLoading] = useState(false);
  const [identifier, setIdentifier] = useState(''); // Email or Username
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [isBiometricAvailable, setIsBiometricAvailable] = useState(false);
  const { language } = useStore();

  const backgroundImage = PlaceHolderImages.find(img => img.id === 'login-bg');

  useEffect(() => {
    const checkBiometrics = async () => {
      if (Capacitor.isNativePlatform()) {
        try {
          const result = await NativeBiometric.isAvailable();
          setIsBiometricAvailable(result.isAvailable);
        } catch (e) {
          console.warn("Biometric check failed:", e);
        }
      }
    };
    checkBiometrics();
  }, []);

  useEffect(() => {
    if (!auth || !db) return;
    const checkRedirect = async () => {
      try {
        const result = await getRedirectResult(auth);
        if (result) {
          setLoading(true);
          const q = query(collection(db, 'users'), where('email', '==', result.user.email?.toLowerCase()));
          const snap = await getDocs(q);
          if (snap.empty) {
            await signOut(auth);
            toast({ variant: "destructive", title: language === 'ar' ? "حساب غير موجود" : "Account Missing" });
          } else {
            router.push('/dashboard');
          }
        }
      } catch (error) { console.error(error); }
      finally { setLoading(false); }
    };
    checkRedirect();
  }, [auth, db, router, toast, language]);

  useEffect(() => {
    if (user && !authLoading) router.push('/dashboard');
  }, [user, authLoading, router]);

  const t = {
    title: 'AUTHORIZATION',
    identifier: language === 'ar' ? 'البريد أو اسم المستخدم' : 'EMAIL OR USERNAME',
    password: language === 'ar' ? 'كلمة المرور' : 'PASSWORD',
    login: language === 'ar' ? 'دخول' : 'VERIFY IDENTITY',
    noAccount: language === 'ar' ? 'لا تملك حساباً؟' : "NO ACCOUNT?",
    create: language === 'ar' ? 'إنشاء هوية' : 'REGISTER',
    error: language === 'ar' ? 'فشل التحقق من الهوية' : 'Authorization failed',
  };

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!auth || !db) return;
    
    const input = identifier.trim().toLowerCase();
    const cleanPassword = password; 
    if (!input || !cleanPassword) return;

    setLoading(true);
    try {
      let loginEmail = input;

      if (!input.includes('@')) {
        const q = query(collection(db, 'users'), where('username', '==', input), limit(1));
        const snap = await getDocs(q);
        if (snap.empty) {
          throw new Error(language === 'ar' ? "اسم المستخدم غير مسجل" : "Username not found");
        }
        loginEmail = snap.docs[0].data().email;
      }

      await signInWithEmailAndPassword(auth, loginEmail, cleanPassword);
    } catch (error: any) {
      let msg = language === 'ar' ? "بيانات الدخول غير صحيحة" : "Invalid credentials";
      if (error.message.includes("Username")) msg = error.message;
      toast({ variant: "destructive", title: t.error, description: msg });
      setLoading(false);
    }
  };

  const handleBiometricLogin = async () => {
    if (!isBiometricAvailable || !auth) return;
    try {
      const verified = await NativeBiometric.verifyIdentity({
        reason: language === 'ar' ? "سجل دخولك إلى فلاش" : "Authorize login to FLASH",
        title: language === 'ar' ? "تسجيل دخول بالبصمة" : "Biometric Login",
      });
      if (verified) {
        const { value: storedCreds } = await Preferences.get({ key: 'flash_biometric_auth' });
        if (storedCreds) {
          const { e, p } = JSON.parse(storedCreds);
          setLoading(true);
          await signInWithEmailAndPassword(auth, e, p);
        } else {
          toast({ variant: "destructive", title: "Biometric not enrolled" });
        }
      }
    } catch (e) { console.error(e); }
  };

  if (authLoading) return <div className="min-h-screen bg-background flex items-center justify-center"><Loader2 className="animate-spin text-primary" /></div>;

  return (
    <div className="min-h-screen flex items-center justify-center relative overflow-hidden bg-background p-6">
      <div className="absolute top-6 right-6 z-[100]"><LanguageToggle /></div>
      <div className="absolute inset-0 z-0 opacity-40 bg-cover bg-center" style={{ backgroundImage: `url('${backgroundImage?.imageUrl}')` }}><div className="absolute inset-0 bg-black/80 backdrop-blur-[10px]"></div></div>

      <div className="relative z-10 max-w-sm w-full space-y-8 animate-in fade-in zoom-in-95 duration-1000">
        <div className="text-center space-y-2 flex flex-col items-center">
          <h1 className="text-6xl font-headline font-bold text-white tracking-tighter gold-glow-text">FLASH</h1>
          <p className="text-[10px] text-primary uppercase tracking-[0.5em] font-bold">{t.title}</p>
        </div>

        <div className="glass-card p-8 sm:p-10 rounded-[3rem] border-white/10 shadow-2xl backdrop-blur-3xl gold-glow overflow-visible">
          <form onSubmit={handleLogin} className="space-y-8">
            <div className="space-y-6">
              {/* --- Futuristic Identifier Input --- */}
              <div className="futuristic-poda scale-[0.9] sm:scale-100">
                <div className="futuristic-glow"></div>
                <div className="futuristic-darkBorderBg"></div>
                <div className="futuristic-darkBorderBg"></div>
                <div className="futuristic-darkBorderBg"></div>
                <div className="white futuristic-white"></div>
                <div className="border futuristic-border"></div>

                <div className="futuristic-main-area">
                  <input 
                    placeholder={t.identifier} 
                    type="text" 
                    name="identifier" 
                    className="futuristic-input" 
                    value={identifier}
                    onChange={(e) => setIdentifier(e.target.value)}
                    required 
                    autoComplete="username"
                  />
                  <div className="futuristic-input-mask"></div>
                  <div className="futuristic-cyan-mask"></div>
                  <div className="futuristic-filterBorder"></div>
                  <div className="futuristic-filter-icon">
                    <svg
                      height="20"
                      width="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="#D4AE35"
                      strokeWidth="2"
                      strokeLinecap="round"
                      strokeLinejoin="round"
                    >
                      <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                      <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                  </div>
                </div>
              </div>

              {/* --- Futuristic Password Input --- */}
              <div className="futuristic-poda scale-[0.9] sm:scale-100">
                <div className="futuristic-glow"></div>
                <div className="futuristic-darkBorderBg"></div>
                <div className="futuristic-darkBorderBg"></div>
                <div className="futuristic-darkBorderBg"></div>
                <div className="white futuristic-white"></div>
                <div className="border futuristic-border"></div>

                <div className="futuristic-main-area">
                  <input 
                    placeholder={t.password} 
                    type={showPassword ? "text" : "password"} 
                    name="password" 
                    className="futuristic-input" 
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    required 
                    autoComplete="current-password"
                  />
                  
                  {/* Password Toggle Button - Fixed position to right to align with futuristic design logic */}
                  <button 
                    type="button" 
                    onClick={() => setShowPassword(!showPassword)}
                    className="absolute top-1/2 -translate-y-1/2 right-[52px] text-white/30 hover:text-primary transition-all z-[10]"
                  >
                    {showPassword ? <EyeOff size={16} /> : <Eye size={16} />}
                  </button>

                  <div className="futuristic-input-mask"></div>
                  <div className="futuristic-cyan-mask"></div>
                  <div className="futuristic-filterBorder"></div>
                  <div className="futuristic-filter-icon">
                    <svg
                      height="20"
                      width="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="#D4AE35"
                      strokeWidth="2"
                      strokeLinecap="round"
                      strokeLinejoin="round"
                    >
                      <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                      <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                  </div>
                </div>
              </div>
            </div>

            <div className="px-2 pt-4">
              <button type="submit" disabled={loading} className="w-full h-16 bg-primary text-primary-foreground font-headline font-bold text-xs tracking-[0.2em] flex items-center justify-center gap-2 rounded-2xl gold-glow active:scale-95 hover:scale-[1.02] transition-all">
                {loading ? <Loader2 className="animate-spin" size={18} /> : <>{t.login} <ArrowRight size={16} className={cn(language === 'ar' && "rotate-180")} /></>}
              </button>
            </div>
          </form>

          {isBiometricAvailable && (
            <div className="px-2">
              <button onClick={handleBiometricLogin} className="w-full h-16 mt-6 bg-primary/10 border border-primary/20 rounded-2xl flex items-center justify-center gap-3 hover:bg-primary/20 transition-all text-primary group">
                <Fingerprint size={24} className="group-hover:scale-110 transition-transform" />
                <span className="text-[10px] font-headline font-bold uppercase tracking-widest">Biometric Vault</span>
              </button>
            </div>
          )}
        </div>

        <p className="text-center text-[10px] font-bold uppercase tracking-[0.2em] text-white/40">
          {t.noAccount} <Link href="/register" className="text-primary hover:text-white transition-colors ml-2">{t.create}</Link>
        </p>
      </div>
    </div>
  );
}


--- START: /src/app/agent/page.tsx ---

"use client"

import { useMemo, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { Badge } from '@/components/ui/badge';
import { 
  Briefcase, 
  LayoutDashboard, 
  Loader2, 
  Users, 
  TrendingUp, 
  Wallet, 
  MessageSquare,
  ArrowRight,
  ShieldCheck,
  Zap
} from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { cn } from '@/lib/utils';
import { useFirestore, useUser, useDoc } from '@/firebase';
import { doc } from 'firebase/firestore';

export default function AgentPage() {
  const router = useRouter();
  const db = useFirestore();
  const { user, loading: authLoading } = useUser();
  const { toast } = useToast();
  
  const userDocRef = useMemo(() => (user && db) ? doc(db, 'users', user.uid) : null, [db, user]);
  const { data: profile, loading: profileLoading } = useDoc(userDocRef);

  useEffect(() => {
    if (!authLoading && !profileLoading && profile && (profile as any).role !== 'agent' && (profile as any).role !== 'admin') {
      toast({ variant: "destructive", title: "AGENT ACCESS ONLY" });
      router.push('/dashboard');
    }
  }, [profile, profileLoading, authLoading, router, toast]);

  if (authLoading || profileLoading) return <div className="min-h-screen bg-background flex items-center justify-center"><Loader2 className="h-8 w-8 text-secondary animate-spin" /></div>;

  return (
    <div className="max-w-4xl mx-auto p-4 sm:p-6 space-y-8 animate-in fade-in slide-in-from-top-4 duration-700 pb-32">
      <header className="flex justify-between items-center p-5 glass-card rounded-[2rem] border-secondary/20 cyan-glow">
        <div className="flex items-center gap-3">
          <Link href="/dashboard" className="p-2 hover:bg-secondary/10 rounded-xl transition-all text-secondary group">
            <LayoutDashboard className="h-6 w-6 group-hover:scale-110" />
          </Link>
          <div>
            <h1 className="text-xs font-headline font-bold tracking-widest uppercase">Agent Command</h1>
            <p className="text-[8px] text-muted-foreground uppercase font-black">Authorized Sub-Shell v1.0</p>
          </div>
        </div>
        <Badge variant="outline" className="text-[8px] tracking-[0.2em] font-black uppercase text-secondary border-secondary/30 py-1">Verified Agent</Badge>
      </header>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div className="glass-card p-6 rounded-[2rem] border-white/5 space-y-4">
          <div className="flex items-center justify-between">
            <div className="p-3 bg-secondary/10 rounded-xl text-secondary"><TrendingUp size={20} /></div>
            <Badge className="bg-green-500/20 text-green-500 text-[7px] uppercase">Active</Badge>
          </div>
          <div>
            <p className="text-[10px] text-muted-foreground uppercase font-headline">Portfolio Value</p>
            <p className="text-2xl font-headline font-black text-white">$0.00</p>
          </div>
        </div>

        <div className="glass-card p-6 rounded-[2rem] border-white/5 space-y-4">
          <div className="flex items-center justify-between">
            <div className="p-3 bg-primary/10 rounded-xl text-primary"><Users size={20} /></div>
            <Badge variant="outline" className="text-[7px] uppercase">Network</Badge>
          </div>
          <div>
            <p className="text-[10px] text-muted-foreground uppercase font-headline">Managed Clients</p>
            <p className="text-2xl font-headline font-black text-white">0</p>
          </div>
        </div>

        <div className="glass-card p-6 rounded-[2rem] border-white/5 space-y-4">
          <div className="flex items-center justify-between">
            <div className="p-3 bg-white/5 rounded-xl text-white"><Zap size={20} /></div>
            <Badge className="bg-secondary/20 text-secondary text-[7px] uppercase">Tier 1</Badge>
          </div>
          <div>
            <p className="text-[10px] text-muted-foreground uppercase font-headline">Protocol Status</p>
            <p className="text-2xl font-headline font-black text-white">Operational</p>
          </div>
        </div>
      </div>

      <div className="glass-card p-8 rounded-[2.5rem] border-white/5 flex flex-col items-center justify-center text-center space-y-6 py-20">
        <div className="w-20 h-20 bg-secondary/10 border border-secondary/20 rounded-full flex items-center justify-center text-secondary animate-pulse">
          <ShieldCheck size={40} />
        </div>
        <div className="space-y-2">
          <h2 className="text-lg font-headline font-bold uppercase tracking-widest text-white">Initializing Agent Sub-System</h2>
          <p className="text-[10px] text-muted-foreground uppercase max-w-xs mx-auto leading-relaxed">
            The Agent Management protocols are being calibrated. Functional modules will appear here following next deployment phase.
          </p>
        </div>
        <Button variant="outline" className="h-12 px-8 rounded-xl border-secondary/20 text-secondary hover:bg-secondary hover:text-background font-headline text-[9px] uppercase tracking-widest">
          Request Feature Access <ArrowRight size={14} className="ml-2" />
        </Button>
      </div>
    </div>
  );
}


--- START: /src/app/splash/page.tsx ---
"use client"

import { useEffect } from 'react';
import { useRouter } from 'next/navigation';

export default function SplashScreen() {
  const router = useRouter();

  useEffect(() => {
    const timer = setTimeout(() => {
      const hasOnboarded = localStorage.getItem('flash_onboarded');
      router.push(hasOnboarded ? '/' : '/onboarding');
    }, 2500);
    return () => clearTimeout(timer);
  }, [router]);

  return (
    <div className="min-h-screen bg-background flex flex-col items-center justify-center relative">
      <div className="text-center space-y-4">
        <h1 className="font-headline text-6xl font-extrabold text-white tracking-tighter">FLASH</h1>
        <div className="flex items-center justify-center gap-3">
          <div className="w-1.5 h-1.5 bg-primary animate-pulse"></div>
          <p className="text-[10px] text-primary font-headline font-bold uppercase tracking-[0.6em]">Authorized Environment</p>
        </div>
      </div>
      <div className="absolute bottom-12 text-[8px] text-muted-foreground font-headline uppercase tracking-widest opacity-40">
        Secure Financial Authority v2.5.0
      </div>
    </div>
  );
}

--- START: /src/app/transfer/page.tsx ---

"use client"

import { useState, useEffect, useMemo, Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { useStore } from '@/app/lib/store';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Label } from '@/components/ui/label';
import { Send, User, ChevronLeft, Loader2, CheckCircle2 } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { cn } from '@/lib/utils';
import { useUser, useFirestore, useDoc } from '@/firebase';
import { 
  doc, 
  collection, 
  runTransaction, 
  increment, 
  query, 
  where, 
  getDocs 
} from 'firebase/firestore';

function TransferContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const { user } = useUser();
  const db = useFirestore();
  const { toast } = useToast();
  const { language } = useStore();
  
  const [recipient, setRecipient] = useState(searchParams.get('id') || '');
  const [recipientName, setRecipientName] = useState<string | null>(null);
  const [isLookingUp, setIsLookingUp] = useState(false);
  const [amount, setAmount] = useState('');
  const [loading, setLoading] = useState(false);

  const userDocRef = useMemo(() => user ? doc(db, 'users', user.uid) : null, [db, user]);
  const { data: profile } = useDoc(userDocRef);

  // Auto-lookup recipient whenever ID changes
  useEffect(() => {
    const lookup = async () => {
      if (recipient.length >= 5 && db) {
        setIsLookingUp(true);
        try {
          const q = query(collection(db, 'users'), where('customId', '==', recipient.trim().toUpperCase()));
          const snap = await getDocs(q);
          if (!snap.empty) {
            setRecipientName(snap.docs[0].data().username);
          } else {
            setRecipientName(null);
          }
        } catch (e) {
          setRecipientName(null);
        } finally {
          setIsLookingUp(false);
        }
      } else {
        setRecipientName(null);
      }
    };
    const timer = setTimeout(lookup, 500);
    return () => clearTimeout(timer);
  }, [recipient, db]);

  const t = {
    header: language === 'ar' ? 'تحويل داخلي' : 'Internal Transfer',
    recipientLabel: language === 'ar' ? 'معرف فلاش (Flash ID)' : 'Recipient Flash ID',
    recipientPlaceholder: language === 'ar' ? 'مثال: F1234567890' : 'Ex: F1234567890',
    amountLabel: language === 'ar' ? 'المبلغ (دولار)' : 'Amount (USD)',
    availableBalance: language === 'ar' ? 'الرصيد المتاح' : 'Available balance',
    loadingBtn: language === 'ar' ? 'جاري التحقق...' : 'INITIALIZING P2P...',
    submitBtn: language === 'ar' ? 'تأكيد التحويل' : 'AUTHORIZE TRANSFER',
    successTitle: language === 'ar' ? 'تم التحويل بنجاح' : 'TRANSFER SUCCESSFUL',
    errorTitle: language === 'ar' ? 'فشلت العملية' : 'TRANSACTION FAILED',
    insufficientFunds: language === 'ar' ? 'الرصيد غير كافٍ' : 'Insufficient balance',
    notFound: language === 'ar' ? 'لم يتم العثور على الحساب' : 'Recipient Flash ID not found',
    selfTransfer: language === 'ar' ? 'لا يمكنك التحويل لنفسك' : 'Cannot transfer to yourself',
    verifying: language === 'ar' ? 'جاري التحقق من الهوية...' : 'Verifying Identity...',
    verified: language === 'ar' ? 'تم التحقق من الحساب' : 'Identity Verified'
  };

  const handleSend = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user || !recipient || !amount || !profile || !db) return;
    
    const amountNum = parseFloat(amount);
    if (amountNum <= 0) return;

    if (profile.balance < amountNum) {
      toast({ variant: "destructive", title: t.errorTitle, description: t.insufficientFunds });
      return;
    }

    if (recipient.trim().toUpperCase() === profile.customId) {
      toast({ variant: "destructive", title: t.errorTitle, description: t.selfTransfer });
      return;
    }

    setLoading(true);
    try {
      const q = query(collection(db, 'users'), where('customId', '==', recipient.trim().toUpperCase()));
      const querySnapshot = await getDocs(q);
      
      if (querySnapshot.empty) {
        toast({ variant: "destructive", title: t.errorTitle, description: t.notFound });
        setLoading(false);
        return;
      }

      const recipientDoc = querySnapshot.docs[0];
      const recipientId = recipientDoc.id;
      const recipientData = recipientDoc.data();

      await runTransaction(db, async (transaction) => {
        const senderRef = doc(db, 'users', user.uid);
        const receiverRef = doc(db, 'users', recipientId);
        
        transaction.update(senderRef, { balance: increment(-amountNum) });
        transaction.update(receiverRef, { balance: increment(amountNum) });

        const senderTxRef = doc(collection(db, 'users', user.uid, 'transactions'));
        transaction.set(senderTxRef, {
          type: 'send',
          amount: amountNum,
          recipient: recipientData.username || recipient,
          status: 'completed',
          date: new Date().toISOString()
        });

        const recipientTxRef = doc(collection(db, 'users', recipientId, 'transactions'));
        transaction.set(recipientTxRef, {
          type: 'receive',
          amount: amountNum,
          sender: profile.username,
          status: 'completed',
          date: new Date().toISOString()
        });

        const notifRef = doc(collection(db, 'users', recipientId, 'notifications'));
        transaction.set(notifRef, {
          title: "Funds Received",
          message: `Success! You received $${amountNum} from @${profile.username}`,
          type: 'transaction',
          read: false,
          date: new Date().toISOString()
        });
      });

      toast({
        title: t.successTitle,
        description: language === 'ar' 
          ? `لقد أرسلت $${amount} إلى ${recipientData.username}` 
          : `You sent $${amount} to ${recipientData.username}`,
      });
      router.push('/dashboard');
    } catch (e: any) {
      toast({ variant: "destructive", title: t.errorTitle, description: e.message });
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className={cn(
      "max-w-lg mx-auto p-6 space-y-8 animate-in fade-in duration-500",
      language === 'ar' ? "slide-in-from-left-4" : "slide-in-from-right-4"
    )}>
      <header className="flex items-center gap-4">
        <button onClick={() => router.back()} className="p-2 glass-card rounded-xl hover:text-primary transition-colors">
          <ChevronLeft className={cn("h-5 w-5", language === 'ar' && "rotate-180")} />
        </button>
        <h1 className="text-lg font-headline font-bold tracking-widest uppercase">{t.header}</h1>
      </header>

      <div className="glass-card p-8 rounded-3xl space-y-8 border-white/5 cyan-glow">
        <div className="flex justify-center">
          <div className="w-16 h-16 rounded-full bg-secondary/10 flex items-center justify-center border border-secondary/30 cyan-glow">
            <Send className="h-8 w-8 text-secondary" />
          </div>
        </div>

        <form onSubmit={handleSend} className="space-y-6">
          <div className="space-y-2">
            <Label htmlFor="recipient" className="text-[10px] tracking-[0.2em] font-headline uppercase block">
              {t.recipientLabel}
            </Label>
            <div className="relative group">
              <div className={cn(
                "absolute top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground group-focus-within:text-secondary transition-colors",
                language === 'ar' ? "right-3" : "left-3"
              )}>
                <User size={16} />
              </div>
              <Input 
                id="recipient" 
                placeholder={t.recipientPlaceholder} 
                className={cn(
                  "h-12 bg-background/50 border-white/10 rounded-xl focus:border-secondary/50 uppercase",
                  language === 'ar' ? "pr-10 pl-4 text-right" : "pl-10 pr-4 text-left"
                )}
                value={recipient}
                onChange={(e) => setRecipient(e.target.value.toUpperCase())}
                required
              />
              <div className="absolute right-3 top-1/2 -translate-y-1/2">
                {isLookingUp && <Loader2 className="h-4 w-4 animate-spin text-primary" />}
              </div>
            </div>
            
            {recipientName && (
              <div className="flex items-center gap-2 p-2 bg-primary/10 border border-primary/20 rounded-lg animate-in slide-in-from-top-2">
                <CheckCircle2 size={12} className="text-primary" />
                <span className="text-[10px] font-headline font-bold text-primary uppercase">{t.verified}: @{recipientName}</span>
              </div>
            )}
          </div>

          <div className="space-y-2">
            <Label htmlFor="amount" className="text-[10px] tracking-[0.2em] font-headline uppercase block">
              {t.amountLabel}
            </Label>
            <Input 
              id="amount" 
              type="number" 
              placeholder="0.00" 
              className="text-2xl font-headline font-bold h-16 text-center bg-background/50 border-white/10 rounded-xl text-primary focus:border-primary/50"
              value={amount}
              onChange={(e) => setAmount(e.target.value)}
              required
            />
          </div>

          <div className="pt-4">
            <Button 
              type="submit" 
              className="w-full h-14 text-md font-headline rounded-xl cyan-glow bg-secondary hover:bg-secondary/90 text-background font-black tracking-widest"
              disabled={loading || !recipientName}
            >
              {loading ? <><Loader2 className="mr-2 animate-spin" /> {t.loadingBtn}</> : t.submitBtn}
            </Button>
          </div>
        </form>

        <div className="p-4 bg-white/5 rounded-2xl border border-white/5 space-y-2">
          <p className="text-[10px] text-muted-foreground uppercase tracking-widest font-bold">{t.availableBalance}</p>
          <p className="text-xl font-headline font-black text-primary">${profile?.balance?.toLocaleString() || '0'}</p>
        </div>
      </div>
    </div>
  );
}

export default function TransferPage() {
  return (
    <Suspense fallback={<div className="min-h-screen flex items-center justify-center"><Loader2 className="animate-spin text-primary" /></div>}>
      <TransferContent />
    </Suspense>
  );
}


--- START: /src/app/withdraw/page.tsx ---
"use client"

import { useState, useMemo, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Label } from '@/components/ui/label';
import { Badge } from '@/components/ui/badge';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { 
  ChevronLeft, 
  Loader2, 
  Landmark, 
  Check, 
  Info, 
  Coins, 
  Wallet,
  ShieldCheck,
  ArrowRight,
  AlertCircle,
  Fingerprint,
  Delete
} from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { cn } from '@/lib/utils';
import { useUser, useFirestore, useDoc, useCollection } from '@/firebase';
import { collection, doc, addDoc, query, where, increment, runTransaction } from 'firebase/firestore';
import { sendTelegramNotification } from '@/lib/telegram';
import { useStore } from '@/app/lib/store';
import { Textarea } from '@/components/ui/textarea';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';

const COUNTRIES = [
  { code: 'GL', name: 'Global / Worldwide', ar: 'عالمي / دولي' },
  { code: 'CR', name: 'Crypto / Digital Assets', ar: 'عملات رقمية' },
  { code: 'SA', name: 'Saudi Arabia', ar: 'السعودية' },
  { code: 'EG', name: 'Egypt', ar: 'مصر' },
  { code: 'AE', name: 'UAE', ar: 'الإمارات' },
  { code: 'KW', name: 'Kuwait', ar: 'الكويت' },
  { code: 'QA', name: 'Qatar', ar: 'قطر' },
  { code: 'JO', name: 'Jordan', ar: 'الأردن' },
  { code: 'IQ', name: 'Iraq', ar: 'العراق' },
  { code: 'LY', name: 'Libya', ar: 'ليبيا' },
  { code: 'DZ', name: 'Algeria', ar: 'الجزائر' },
  { code: 'MA', name: 'Morocco', ar: 'المغرب' },
  { code: 'PS', name: 'Palestine', ar: 'فلسطين' },
  { code: 'LB', name: 'Lebanon', ar: 'لبنان' },
  { code: 'SY', name: 'Syria', ar: 'سوريا' },
  { code: 'OM', name: 'Oman', ar: 'عمان' },
  { code: 'YE', name: 'Yemen', ar: 'اليمن' },
  { code: 'BH', name: 'Bahrain', ar: 'البحرين' },
  { code: 'TN', name: 'Tunisia', ar: 'تونس' },
  { code: 'SD', name: 'Sudan', ar: 'السودان' },
  { code: 'US', name: 'USA', ar: 'أمريكا' },
  { code: 'GB', name: 'UK', ar: 'بريطانيا' },
  { code: 'CA', name: 'Canada', ar: 'كندا' },
];

export default function WithdrawPage() {
  const router = useRouter();
  const { user } = useUser();
  const db = useFirestore();
  const { toast } = useToast();
  const { language } = useStore();
  
  const [step, setStep] = useState(1); 
  const [selectedCountry, setSelectedCountry] = useState<string>('');
  const [selectedMethod, setSelectedMethod] = useState<any>(null);
  const [amount, setAmount] = useState('');
  const [formData, setFormData] = useState<Record<string, string>>({});
  const [loading, setLoading] = useState(false);
  const [isConfirming, setIsConfirming] = useState(false);
  const [isPinVerificationOpen, setIsPinVerificationOpen] = useState(false);
  const [pinEntry, setPinEntry] = useState('');

  const userDocRef = useMemo(() => user ? doc(db, 'users', user.uid) : null, [db, user]);
  const { data: profile } = useDoc(userDocRef);

  const allMethodsQuery = useMemo(() => {
    if (!db) return null;
    return query(collection(db, 'withdrawal_methods'), where('isActive', '==', true));
  }, [db]);
  const { data: allWithdrawMethods = [], loading: initialLoading } = useCollection(allMethodsQuery);

  const availableCountries = useMemo(() => {
    const codes = new Set(allWithdrawMethods.map((m: any) => m.country));
    codes.add('CR'); 
    return COUNTRIES.filter(c => codes.has(c.code));
  }, [allWithdrawMethods]);

  useEffect(() => {
    if (profile?.country && !selectedCountry && availableCountries.some(c => c.code === profile.country)) {
      setSelectedCountry(profile.country);
    }
  }, [profile?.country, selectedCountry, availableCountries]);

  const methodsQuery = useMemo(() => {
    if (!db) return null;
    return query(collection(db, 'withdrawal_methods'), where('isActive', '==', true));
  }, [db]);
  
  const { data: allMethodsList = [], loading: methodsLoading } = useCollection(methodsQuery);

  const filteredMethods = useMemo(() => {
    if (selectedCountry === 'GL') {
      return allMethodsList.filter((m: any) => m.country === 'GL');
    }
    return allMethodsList.filter((m: any) => m.country === selectedCountry);
  }, [allMethodsList, selectedCountry]);

  useEffect(() => {
    if (selectedCountry === 'CR' && step === 2) {
      setSelectedMethod({
        name: 'USDT',
        country: 'CR',
        currencyCode: 'USD',
        exchangeRate: 1,
        feeType: 'fixed',
        feeValue: 2.0,
        fields: [
          { 
            label: language === 'ar' ? 'نوع الشبكة' : 'Network Type', 
            type: 'select', 
            options: 'Tron (TRC20), BNB Smart Chain (BEP20)' 
          },
          { label: language === 'ar' ? 'عنوان الشبكة' : 'Network Address', type: 'text' }
        ]
      });
      setStep(3);
    }
  }, [selectedCountry, step, language]);

  const calculations = useMemo(() => {
    if (!selectedMethod || !amount) return { localAmount: 0, fee: 0, net: 0 };
    const usd = parseFloat(amount || '0');
    const local = usd * (selectedMethod.exchangeRate || 1);
    let fee = 0;
    if (selectedMethod.feeType === 'fixed') {
      fee = selectedMethod.feeValue || 0;
    } else {
      fee = (local * (selectedMethod.feeValue || 0)) / 100;
    }
    return { 
      localAmount: local, 
      fee: fee, 
      net: Math.round(Math.max(0, local - fee)) 
    };
  }, [selectedMethod, amount]);

  const t = {
    header: language === 'ar' ? 'سحب رصيد' : 'Withdraw Funds',
    selectCountry: language === 'ar' ? 'اختر الدولة' : 'Select Country',
    selectMethod: language === 'ar' ? 'اختر وسيلة السحب' : 'Select Gateway',
    noMethods: language === 'ar' ? 'لا تتوفر وسائل سحب حالياً' : 'No gateways available',
    amountLabel: language === 'ar' ? 'المبلغ المطلوب سحبه ($)' : 'Withdrawal Amount (USD)',
    submitBtn: language === 'ar' ? 'تأكيد طلب السحب' : 'AUTHORIZE WITHDRAWAL',
    nextBtn: language === 'ar' ? 'استمرار' : 'CONTINUE',
    success: language === 'ar' ? 'تم تقديم الطلب بنجاح' : 'Withdrawal request submitted',
    balance: language === 'ar' ? 'الرصيد المتاح' : 'Available Balance',
    insufficient: language === 'ar' ? 'الرصيد غير كافٍ' : 'Insufficient balance',
    fillRequired: language === 'ar' ? 'يرجى ملء جميع الحقول' : 'Please fill all fields',
    fee: language === 'ar' ? 'العمولة' : 'Commission Fee',
    willReceive: language === 'ar' ? 'المبلغ الذي سيصلك' : 'You will receive',
    cryptoNotice: language === 'ar' ? 'سيصلك المبلغ الذي أدخلته مخصوماً منه 2 دولار (عمولة الشبكة)' : 'You will receive the amount you entered minus $2.00 (Network Fee)',
    localValue: language === 'ar' ? 'القيمة بالعملة المحلية' : 'Local Currency Value',
    loadingCountries: language === 'ar' ? 'جاري تحميل الدول المتاحة...' : 'Loading available countries...',
    authTitle: language === 'ar' ? 'تأكيد الأمان' : 'Security Authorization',
    confirmText: language === 'ar' ? 'هل أنت متأكد من رغبتك في سحب هذا المبلغ؟' : 'Are you sure you want to authorize this withdrawal?',
    finalConfirm: language === 'ar' ? 'تأكيد نهائي' : 'Final Confirmation',
    abort: language === 'ar' ? 'إلغاء' : 'Abort',
    verifyVault: language === 'ar' ? "تأكيد PIN الخزنة" : "Verify Vault PIN"
  };

  const handleInputChange = (label: string, value: string) => {
    setFormData(prev => ({ ...prev, [label]: value }));
  };

  const handleBack = () => {
    if (step === 1) router.back();
    else if (step === 3 && selectedCountry === 'CR') {
      setSelectedMethod(null);
      setStep(1);
    } else setStep(step - 1);
  };

  const handleInitiateWithdrawal = (e: React.FormEvent) => {
    e.preventDefault();
    if (!user || !amount || !profile || !selectedMethod) return;

    if (!profile?.pin) {
      toast({ variant: "destructive", title: language === 'ar' ? "يرجى إعداد PIN أولاً" : "Please setup PIN first" });
      router.push('/profile/edit');
      return;
    }

    const amountUsd = parseFloat(amount);
    if (amountUsd > (profile.balance || 0)) {
      toast({ variant: "destructive", title: t.insufficient });
      return;
    }

    const allFilled = selectedMethod.fields?.every((f: any) => formData[f.label]?.trim());
    if (!allFilled) {
      toast({ variant: "destructive", title: t.fillRequired });
      return;
    }

    setIsConfirming(true);
  };

  const handlePinAuth = () => {
    setIsConfirming(false);
    setPinEntry('');
    setIsPinVerificationOpen(true);
  };

  const handleConfirmSubmit = async () => {
    if (pinEntry !== profile?.pin) {
      toast({ variant: "destructive", title: language === 'ar' ? "رمز PIN غير صحيح" : "Incorrect PIN" });
      setPinEntry('');
      return;
    }

    if (!user || !amount || !profile || !selectedMethod) return;
    const amountUsd = parseFloat(amount);

    setLoading(true);
    try {
      let requestId = "";
      await runTransaction(db, async (transaction) => {
        const userRef = doc(db, 'users', user.uid);
        transaction.update(userRef, { balance: increment(-amountUsd) });
        
        const withdrawalRef = doc(collection(db, 'withdrawals'));
        requestId = withdrawalRef.id;
        
        transaction.set(withdrawalRef, {
          userId: user.uid,
          username: profile.username,
          methodName: selectedMethod.name,
          amountUsd: amountUsd,
          localAmount: calculations.localAmount,
          currencyCode: selectedMethod.currencyCode,
          feeAmount: calculations.fee,
          netAmount: calculations.net,
          details: formData,
          status: 'pending',
          date: new Date().toISOString()
        });

        const txRef = doc(collection(db, 'users', user.uid, 'transactions'));
        transaction.set(txRef, {
          type: 'withdraw',
          amount: amountUsd,
          status: 'pending',
          date: new Date().toISOString()
        });
      });

      const detailsText = Object.entries(formData).map(([k, v]) => `- ${k}: <code>${v}</code>`).join('\n');
      await sendTelegramNotification(`
💸 <b>New Withdrawal Request (${selectedMethod.name})</b>
━━━━━━━━━━━━━━━━
<b>User:</b> @${profile.username}
<b>USD Amount:</b> $${amount}
<b>Local Total:</b> ${calculations.localAmount} ${selectedMethod.currencyCode}
<b>Fee Applied:</b> ${calculations.fee} ${selectedMethod.currencyCode}
<b>NET TO PAY:</b> <code>${calculations.net} ${selectedMethod.currencyCode}</code>
<b>Details:</b>
${detailsText}
      `, {
        inline_keyboard: [[
          { text: "✅ Approve", callback_data: `app_wit_${requestId}` },
          { text: "❌ Reject", callback_data: `rej_wit_${requestId}` }
        ]]
      });

      toast({ title: t.success });
      router.push('/dashboard');
    } catch (err: any) {
      toast({ variant: "destructive", title: "ERROR", description: err.message });
    } finally {
      setLoading(false);
      setIsPinVerificationOpen(false);
    }
  };

  const VirtualPad = ({ value, onChange, onComplete }: any) => {
    const handleAdd = (num: string) => { if (value.length < 4) onChange(value + num); };
    const handleClear = () => onChange(value.slice(0, -1));
    return (
      <div className="space-y-8" dir="ltr">
        <div className="flex justify-center gap-4">
          {[0, 1, 2, 3].map((i) => (
            <div key={i} className={cn("w-4 h-4 rounded-full border-2 transition-all duration-300", value.length > i ? "bg-primary border-primary scale-125" : "border-white/20")} />
          ))}
        </div>
        <div className="grid grid-cols-3 gap-4">
          {[1, 2, 3, 4, 5, 6, 7, 8, 9].map((n) => (
            <button key={n} type="button" onClick={() => handleAdd(n.toString())} className="h-16 rounded-2xl bg-white/5 border border-white/10 text-xl font-headline font-bold hover:bg-primary hover:text-background transition-all">{n}</button>
          ))}
          <button type="button" onClick={handleClear} className="h-16 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center hover:bg-red-500 transition-all"><Delete size={24} /></button>
          <button type="button" onClick={() => handleAdd('0')} className="h-16 rounded-2xl bg-white/5 border border-white/10 text-xl font-headline font-bold hover:bg-primary hover:text-background transition-all">0</button>
          <button type="button" disabled={value.length !== 4} onClick={onComplete} className="h-16 rounded-2xl bg-primary/20 border border-primary/40 flex items-center justify-center text-primary disabled:opacity-20 hover:bg-primary hover:text-background transition-all"><Check size={24} /></button>
        </div>
      </div>
    );
  };

  const renderStep = () => {
    switch (step) {
      case 1:
        return (
          <div className="space-y-6 animate-in fade-in zoom-in-95">
            <div className="space-y-2">
              <Label className="text-[10px] uppercase font-bold tracking-widest text-muted-foreground">{t.selectCountry}</Label>
              {initialLoading ? (
                <div className="h-14 flex items-center justify-center glass-card rounded-2xl">
                  <Loader2 className="animate-spin h-4 w-4 text-primary mr-2" />
                  <span className="text-[10px] uppercase font-headline text-muted-foreground">{t.loadingCountries}</span>
                </div>
              ) : (
                <Select value={selectedCountry} onValueChange={(val) => { setSelectedCountry(val); setStep(2); }}>
                  <SelectTrigger className="h-14 bg-card/40 border-white/10 rounded-2xl text-[10px] uppercase font-headline">
                    <SelectValue placeholder="CHOOSE LOCATION" />
                  </SelectTrigger>
                  <SelectContent className="bg-card border-white/10">
                    {availableCountries.length === 0 ? (
                      <div className="p-4 text-center text-[10px] uppercase text-muted-foreground">{t.noMethods}</div>
                    ) : availableCountries.map(c => (
                      <SelectItem key={c.code} value={c.code} className="text-[10px] uppercase font-headline">
                        {language === 'ar' ? c.ar : c.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              )}
            </div>
            {selectedCountry && <Button onClick={() => setStep(2)} className="w-full h-14 bg-primary text-background font-headline font-black tracking-widest rounded-xl hover:scale-[1.02] transition-all gold-glow"> {t.nextBtn} </Button>}
          </div>
        );
      case 2:
        return (
          <div className="space-y-6 animate-in slide-in-from-right-4">
            <h2 className="text-[10px] font-headline font-bold uppercase tracking-widest text-muted-foreground">{t.selectMethod}</h2>
            <div className="grid grid-cols-1 gap-4">
              {methodsLoading ? <Loader2 className="animate-spin mx-auto text-primary" /> : filteredMethods.length === 0 ? (
                <div className="glass-card p-10 rounded-3xl text-center space-y-4">
                  <Info className="mx-auto text-muted-foreground" size={32} />
                  <p className="text-[10px] font-headline font-bold uppercase text-muted-foreground">{t.noMethods}</p>
                </div>
              ) : filteredMethods.map((m: any) => (
                <button key={m.id} onClick={() => { setSelectedMethod(m); setStep(3); }} className="glass-card p-6 rounded-3xl flex items-center justify-between border-white/5 hover:border-primary/40 transition-all group">
                  <div className="flex items-center gap-5">
                    <div className="w-12 h-12 rounded-2xl bg-primary/10 flex items-center justify-center text-primary group-hover:scale-110 overflow-hidden border border-white/5">
                      {m.iconUrl ? <img src={m.iconUrl} className="w-full h-full object-cover" /> : <Landmark size={24} />}
                    </div>
                    <div className="text-left">
                      <p className="text-xs font-headline font-bold uppercase text-white">{m.name}</p>
                      <div className="flex gap-1 mt-1">
                        <Badge variant="outline" className="text-[6px] text-muted-foreground border-white/10">{m.currencyCode}</Badge>
                        <Badge className="text-[6px] bg-primary/10 text-primary border-primary/20">Rate: {m.exchangeRate}</Badge>
                      </div>
                    </div>
                  </div>
                  <div className="p-2 rounded-full bg-white/5 group-hover:bg-primary transition-all"><Check size={14} className="group-hover:text-background" /></div>
                </button>
              ))}
            </div>
          </div>
        );
      case 3:
        const isCrypto = selectedCountry === 'CR';
        return (
          <form onSubmit={handleInitiateWithdrawal} className="glass-card p-8 rounded-3xl space-y-8 border-white/5 gold-glow animate-in slide-in-from-right-4">
            <div className="space-y-4">
              <div className="flex justify-between items-center">
                <div className="flex items-center gap-2">
                  {isCrypto ? <Coins className="h-5 w-5 text-primary" /> : <Landmark className="h-5 w-5 text-primary" />}
                  <span className="text-[12px] font-headline font-bold uppercase text-primary">{selectedMethod.name}</span>
                </div>
                <span className="text-[8px] text-muted-foreground uppercase">{t.balance}: ${profile?.balance?.toLocaleString()}</span>
              </div>
              
              {isCrypto && (
                <div className="p-4 bg-primary/5 border border-primary/20 rounded-2xl flex items-start gap-3">
                  <Info className="h-4 w-4 text-primary shrink-0 mt-0.5" />
                  <p className="text-[9px] font-headline font-black text-primary uppercase tracking-widest leading-relaxed">{t.cryptoNotice}</p>
                </div>
              )}

              <Label className="text-[10px] tracking-widest font-headline uppercase block">{t.amountLabel}</Label>
              <Input type="number" placeholder="0.00" className="text-3xl font-headline font-bold h-20 text-center bg-background/50 border-white/10 rounded-xl text-primary focus:border-primary/50" value={amount} onChange={(e) => setAmount(e.target.value)} required />
              
              <div className="grid grid-cols-2 gap-4 p-4 bg-white/5 rounded-2xl border border-white/5">
                <div><p className="text-[8px] text-muted-foreground uppercase">{t.localValue}</p><p className="text-sm font-headline font-bold text-white">{calculations.localAmount.toLocaleString()} {selectedMethod.currencyCode}</p></div>
                <div className="text-right"><p className="text-[8px] text-muted-foreground uppercase">{t.fee}</p><p className="text-sm font-headline font-bold text-red-500">-{calculations.fee.toLocaleString()} {selectedMethod.currencyCode}</p></div>
              </div>

              <div className="p-4 bg-primary/10 rounded-2xl border border-primary/30 flex justify-between items-center">
                <p className="text-[10px] font-headline font-bold uppercase text-primary">{t.willReceive}</p>
                <p className="text-2xl font-headline font-black text-primary">{calculations.net.toLocaleString()} {selectedMethod.currencyCode}</p>
              </div>
            </div>

            <div className="space-y-6">
              <p className="text-[8px] text-muted-foreground uppercase font-black tracking-widest border-b border-white/5 pb-2">REQUIRED SECURITY INTEL</p>
              {selectedMethod.fields?.map((field: any, idx: number) => (
                <div key={idx} className="space-y-2">
                  <Label className="text-[9px] uppercase font-bold tracking-tight text-white/60">{field.label}</Label>
                  {field.type === 'textarea' ? (
                    <Textarea placeholder={`ENTER ${field.label.toUpperCase()}`} className="bg-background/50 border-white/10 rounded-xl text-xs pt-3 min-h-[100px]" value={formData[field.label] || ''} onChange={(e) => handleInputChange(field.label, e.target.value)} required />
                  ) : field.type === 'select' ? (
                    <Select value={formData[field.label] || ''} onValueChange={(val) => handleInputChange(field.label, val)}>
                      <SelectTrigger className="h-12 bg-background/50 border-white/10 rounded-xl text-xs uppercase"><SelectValue placeholder={`CHOOSE ${field.label.toUpperCase()}`} /></SelectTrigger>
                      <SelectContent className="bg-card border-white/10">
                        {field.options?.split(',').map((opt: string) => (
                          <SelectItem key={opt.trim()} value={opt.trim()} className="text-[10px] uppercase">{opt.trim()}</SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  ) : (
                    <Input placeholder={`ENTER ${field.label.toUpperCase()}`} className="h-12 bg-background/50 border-white/10 rounded-xl text-xs" value={formData[field.label] || ''} onChange={(e) => handleInputChange(field.label, e.target.value)} required />
                  )}
                </div>
              ))}
            </div>

            <Button type="submit" disabled={loading || !amount || calculations.net <= 0} className="w-full h-16 text-xs font-headline rounded-xl gold-glow bg-primary text-background font-black tracking-[0.2em] uppercase hover:scale-[1.02] transition-all">
              {loading ? <Loader2 className="animate-spin" /> : t.submitBtn}
            </Button>
          </form>
        );
      default:
        return null;
    }
  };

  return (
    <div className="max-w-lg mx-auto p-6 space-y-8 animate-in fade-in duration-500 pb-32">
      <header className="flex items-center gap-4">
        <button onClick={handleBack} className="p-2 glass-card rounded-xl hover:text-primary transition-colors">
          <ChevronLeft className={cn("h-5 w-5", language === 'ar' && "rotate-180")} />
        </button>
        <h1 className="text-lg font-headline font-bold tracking-widest uppercase">{t.header}</h1>
      </header>

      {renderStep()}

      {/* Withdrawal Confirmation Dialog */}
      <Dialog open={isConfirming} onOpenChange={(val) => !loading && setIsConfirming(val)}>
        <DialogContent className="max-w-sm glass-card border-white/10 p-8 rounded-[2.5rem] z-[1000]">
          <DialogHeader>
            <DialogTitle className="text-xs font-headline font-bold tracking-widest uppercase text-center flex items-center justify-center gap-2">
              <ShieldCheck size={16} className="text-primary" /> {t.authTitle}
            </DialogTitle>
          </DialogHeader>

          <div className="mt-6 space-y-6">
            <div className="p-6 bg-primary/5 border border-primary/20 rounded-3xl text-center space-y-4">
              <p className="text-[10px] font-headline font-bold uppercase tracking-widest leading-relaxed text-white/80">
                {t.confirmText}
              </p>
              
              <div className="py-4 border-y border-white/5 space-y-3">
                <div className="flex justify-between items-center">
                  <span className="text-[8px] text-muted-foreground uppercase font-black">Requested:</span>
                  <span className="text-sm font-headline font-bold text-white">${amount}</span>
                </div>
                <div className="flex justify-between items-center">
                  <span className="text-[8px] text-muted-foreground uppercase font-black">Method:</span>
                  <span className="text-[10px] font-headline font-bold text-primary">{selectedMethod?.name}</span>
                </div>
                <div className="flex justify-between items-center pt-2">
                  <span className="text-[8px] text-muted-foreground uppercase font-black">Net Payout:</span>
                  <span className="text-2xl font-headline font-black text-primary">
                    {calculations.net.toLocaleString()} {selectedMethod?.currencyCode}
                  </span>
                </div>
              </div>

              <div className="space-y-2 text-left bg-black/20 p-3 rounded-xl">
                <p className="text-[7px] text-muted-foreground uppercase font-black">Destination Intel:</p>
                {Object.entries(formData).map(([k, v]) => (
                  <div key={k} className="flex justify-between gap-4">
                    <span className="text-[7px] text-white/40 uppercase shrink-0">{k}:</span>
                    <span className="text-[8px] font-headline text-white truncate">{v}</span>
                  </div>
                ))}
              </div>
            </div>

            <div className="flex flex-col gap-3">
              <Button 
                onClick={handlePinAuth} 
                disabled={loading} 
                className="w-full h-14 bg-primary text-background rounded-xl font-headline text-[10px] uppercase tracking-widest font-black gold-glow flex items-center justify-center gap-2"
              >
                {t.finalConfirm} <ArrowRight size={14} />
              </Button>
              <Button 
                variant="ghost" 
                onClick={() => setIsConfirming(false)} 
                className="w-full h-10 text-[8px] font-headline uppercase text-muted-foreground" 
                disabled={loading}
              >
                {t.abort}
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* PIN Verification Modal */}
      <Dialog open={isPinVerificationOpen} onOpenChange={setIsPinVerificationOpen}>
        <DialogContent className="max-w-sm glass-card border-white/10 p-10 text-center rounded-[2.5rem] z-[2000]">
          <DialogHeader><DialogTitle className="text-xs font-headline font-bold tracking-widest uppercase text-primary flex items-center justify-center gap-2"><Fingerprint size={16} /> {t.verifyVault}</DialogTitle></DialogHeader>
          <div className="mt-8">
            <VirtualPad value={pinEntry} onChange={setPinEntry} onComplete={handleConfirmSubmit} />
            {loading && <div className="mt-4 flex justify-center"><Loader2 className="animate-spin text-primary" /></div>}
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}


--- START: /src/app/orders/page.tsx ---

"use client"

import { useState, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import { 
  ChevronLeft, 
  ShoppingBag, 
  Loader2, 
  Clock, 
  CheckCircle2, 
  XCircle, 
  Info, 
  Hash, 
  Copy,
  AlertCircle,
  Undo2
} from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { cn } from '@/lib/utils';
import { useUser, useFirestore, useCollection } from '@/firebase';
import { collection, query, where, orderBy } from 'firebase/firestore';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Badge } from '@/components/ui/badge';

export default function OrdersPage() {
  const router = useRouter();
  const { user } = useUser();
  const db = useFirestore();
  const { toast } = useToast();
  
  const ordersQuery = useMemo(() => {
    if (!user || !db) return null;
    return query(
      collection(db, 'service_requests'), 
      where('userId', '==', user.uid),
      orderBy('date', 'desc')
    );
  }, [db, user?.uid]);

  const { data: orders = [], loading } = useCollection(ordersQuery);

  const pendingOrders = orders.filter((o: any) => o.status === 'pending');
  const completedOrders = orders.filter((o: any) => o.status === 'completed');
  const rejectedOrders = orders.filter((o: any) => o.status === 'rejected');

  const copyCode = (code: string) => {
    navigator.clipboard.writeText(code);
    toast({ title: "CODE COPIED" });
  };

  return (
    <div className="max-w-lg mx-auto p-6 space-y-8 animate-in fade-in duration-500 pb-32">
      <header className="flex items-center gap-4">
        <button onClick={() => router.back()} className="p-2 glass-card rounded-xl hover:text-primary transition-colors">
          <ChevronLeft className="h-5 w-5" />
        </button>
        <h1 className="text-lg font-headline font-bold tracking-widest uppercase">Asset History</h1>
      </header>

      <Tabs defaultValue="pending" className="w-full">
        <TabsList className="grid w-full grid-cols-3 bg-card/40 border border-white/5 rounded-2xl h-12 p-1">
          <TabsTrigger value="pending" className="rounded-xl text-[8px] font-headline uppercase tracking-widest data-[state=active]:bg-primary data-[state=active]:text-background">
            Processing {pendingOrders.length > 0 && `(${pendingOrders.length})`}
          </TabsTrigger>
          <TabsTrigger value="completed" className="rounded-xl text-[8px] font-headline uppercase tracking-widest data-[state=active]:bg-primary data-[state=active]:text-background">
            Secured
          </TabsTrigger>
          <TabsTrigger value="rejected" className="rounded-xl text-[8px] font-headline uppercase tracking-widest data-[state=active]:bg-primary data-[state=active]:text-background">
            Declined
          </TabsTrigger>
        </TabsList>

        <div className="mt-8">
          {loading ? (
            <div className="py-20 flex justify-center"><Loader2 className="animate-spin text-primary" size={32} /></div>
          ) : (
            <>
              <TabsContent value="pending" className="space-y-4">
                {pendingOrders.length === 0 ? (
                  <div className="py-20 text-center glass-card rounded-3xl border-dashed border-white/10">
                    <Clock className="mx-auto text-muted-foreground mb-3 opacity-20" size={32} />
                    <p className="text-[10px] font-headline font-bold text-muted-foreground uppercase">No pending assets</p>
                  </div>
                ) : (
                  pendingOrders.map((o: any) => (
                    <div key={o.id} className="glass-card p-6 rounded-3xl border-white/5 space-y-4">
                      <div className="flex justify-between items-start">
                        <div className="flex items-center gap-4">
                          <div className="w-10 h-10 rounded-xl bg-primary/10 flex items-center justify-center text-primary border border-primary/20"><ShoppingBag size={20} /></div>
                          <div>
                            <p className="text-[10px] font-headline font-bold uppercase">{o.serviceName}</p>
                            <p className="text-[7px] text-muted-foreground uppercase">{o.selectedVariant || "Fixed Unit"}</p>
                          </div>
                        </div>
                        <p className="text-sm font-headline font-black text-primary">${o.price}</p>
                      </div>
                      <div className="p-3 bg-white/5 rounded-xl border border-white/5 flex items-center justify-between">
                        <span className="text-[8px] text-muted-foreground uppercase font-black">Status:</span>
                        <Badge variant="outline" className="text-[7px] uppercase border-yellow-500/40 text-yellow-500 h-5">Reviewing Protocol</Badge>
                      </div>
                    </div>
                  ))
                )}
              </TabsContent>

              <TabsContent value="completed" className="space-y-4">
                {completedOrders.length === 0 ? (
                  <div className="py-20 text-center glass-card rounded-3xl border-dashed border-white/10">
                    <CheckCircle2 className="mx-auto text-muted-foreground mb-3 opacity-20" size={32} />
                    <p className="text-[10px] font-headline font-bold text-muted-foreground uppercase">No secured assets yet</p>
                  </div>
                ) : (
                  completedOrders.map((o: any) => (
                    <div key={o.id} className="glass-card p-6 rounded-3xl border-primary/10 gold-glow space-y-5">
                      <div className="flex justify-between items-start">
                        <div className="flex items-center gap-4">
                          <div className="w-10 h-10 rounded-xl bg-green-500/10 flex items-center justify-center text-green-500 border border-green-500/20"><CheckCircle2 size={20} /></div>
                          <div>
                            <p className="text-[10px] font-headline font-bold uppercase">{o.serviceName}</p>
                            <p className="text-[7px] text-muted-foreground uppercase">{new Date(o.date).toLocaleDateString()}</p>
                          </div>
                        </div>
                        <Badge className="bg-green-500/20 text-green-500 border-green-500/30 text-[7px] uppercase h-5">Success</Badge>
                      </div>
                      
                      {o.resultCode && (
                        <div className="p-4 bg-green-500/10 border border-green-500/30 rounded-2xl space-y-2">
                          <p className="text-[8px] text-green-500 font-black uppercase tracking-widest">Asset Key / Code:</p>
                          <div className="flex items-center justify-between bg-black/40 p-3 rounded-xl border border-white/10">
                            <code className="text-xs font-headline font-bold text-white tracking-widest">{o.resultCode}</code>
                            <button onClick={() => copyCode(o.resultCode)} className="p-2 hover:bg-white/10 rounded-lg transition-colors"><Copy size={14} className="text-green-500" /></button>
                          </div>
                        </div>
                      )}
                    </div>
                  ))
                )}
              </TabsContent>

              <TabsContent value="rejected" className="space-y-4">
                {rejectedOrders.length === 0 ? (
                  <div className="py-20 text-center glass-card rounded-3xl border-dashed border-white/10">
                    <XCircle className="mx-auto text-muted-foreground mb-3 opacity-20" size={32} />
                    <p className="text-[10px] font-headline font-bold text-muted-foreground uppercase">System record is clean</p>
                  </div>
                ) : (
                  rejectedOrders.map((o: any) => (
                    <div key={o.id} className="glass-card p-6 rounded-3xl border-red-500/10 space-y-5">
                      <div className="flex justify-between items-start">
                        <div className="flex items-center gap-4">
                          <div className="w-10 h-10 rounded-xl bg-red-500/10 flex items-center justify-center text-red-500 border border-red-500/20"><XCircle size={20} /></div>
                          <div>
                            <p className="text-[10px] font-headline font-bold uppercase">{o.serviceName}</p>
                            <p className="text-[7px] text-muted-foreground uppercase">{new Date(o.date).toLocaleDateString()}</p>
                          </div>
                        </div>
                        <Badge variant="destructive" className="text-[7px] uppercase h-5">Rejected</Badge>
                      </div>

                      <div className="p-4 bg-red-500/5 border border-red-500/20 rounded-2xl space-y-2">
                        <div className="flex items-center gap-2 text-red-500">
                          <AlertCircle size={12} />
                          <p className="text-[8px] font-black uppercase tracking-widest">Administrator Note:</p>
                        </div>
                        <p className="text-[10px] font-headline text-white/80 italic leading-relaxed">"{o.rejectionReason || "No specific reason provided."}"</p>
                      </div>

                      <div className="flex items-center gap-2 p-3 bg-blue-500/10 border border-blue-500/20 rounded-xl">
                        <Undo2 size={12} className="text-blue-400" />
                        <p className="text-[8px] font-headline font-bold uppercase text-blue-400 tracking-tight">Funds Returned: ${o.price} credited back to vault.</p>
                      </div>
                    </div>
                  ))
                )}
              </TabsContent>
            </>
          )}
        </div>
      </Tabs>
    </div>
  );
}


--- START: /src/app/dashboard/page.tsx ---

"use client"

import { useEffect, useState, useMemo, useRef } from 'react';
import { useStore } from '@/app/lib/store';
import { 
  Bell, 
  User, 
  ArrowUpRight, 
  ArrowDownLeft,
  Settings,
  LogOut,
  Copy,
  Loader2,
  PlusCircle,
  ArrowDown,
  Languages,
  Moon,
  Sun,
  ShieldAlert,
  QrCode,
  CheckCircle2,
  Trash2,
  Wallet,
  Send,
  X,
  Camera,
  ShoppingBag,
  Delete,
  Check,
  Fingerprint,
  Briefcase,
  ChevronLeft,
  Smartphone,
  ShieldCheck,
  MailCheck,
  Headset,
  MessageSquare,
  FileText,
  ImageIcon,
  SendHorizontal,
  CircleDot,
  Star,
  ArrowRight
} from 'lucide-react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { cn } from '@/lib/utils';
import { useToast } from '@/hooks/use-toast';
import { useUser, useFirestore, useDoc, useAuth, useCollection } from '@/firebase';
import { 
  doc, 
  collection, 
  query, 
  where, 
  getDocs, 
  orderBy, 
  limit, 
  runTransaction, 
  increment, 
  updateDoc, 
  deleteDoc, 
  addDoc,
  setDoc,
  onSnapshot
} from 'firebase/firestore';
import { signOut } from 'firebase/auth';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Html5Qrcode } from "html5-qrcode";
import { ThemeToggle } from '@/components/ui/ThemeToggle';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Label } from '@/components/ui/label';
import { sendTelegramNotification, sendTelegramPhoto } from '@/lib/telegram';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';

export default function Dashboard() {
  const router = useRouter();
  const auth = useAuth();
  const { user, loading: authLoading } = useUser();
  const db = useFirestore();
  const { toast } = useToast();
  const { language, toggleLanguage, isScannerOpen, setScannerOpen } = useStore();
  
  const [isSettingsOpen, setIsSettingsOpen] = useState(false);
  const [isQrOpen, setIsQrOpen] = useState(false);
  const [isNotifOpen, setIsNotifOpen] = useState(false);
  const [isSupportOpen, setIsSupportOpen] = useState(false);
  const [supportStep, setSupportStep] = useState<'options' | 'form' | 'chat'>('options');
  
  // Chat States
  const [chatMessage, setChatMessage] = useState('');
  const [chatStatus, setChatStatus] = useState<any>(null);
  const [chatSession, setChatSession] = useState<any>(null);
  const [messages, setMessages] = useState<any[]>([]);
  const [isStartingChat, setIsStartingChat] = useState(false);
  const [userRating, setUserRating] = useState(0);
  const [userFeedback, setUserFeedback] = useState('');
  const [showRatingUI, setShowRatingUI] = useState(false);
  const [isSubmittingRating, setIsSubmittingRating] = useState(false);
  const chatEndRef = useRef<HTMLDivElement>(null);

  const [mounted, setMounted] = useState(false);

  // Support Form State
  const [supportSubject, setSupportSubject] = useState('');
  const [supportMessage, setSupportMessage] = useState('');
  const [supportImage, setSupportImage] = useState<string | null>(null);
  const [isSubmittingSupport, setIsSubmittingSupport] = useState(false);
  const supportFileInputRef = useRef<HTMLInputElement>(null);

  const scannerRef = useRef<Html5Qrcode | null>(null);
  const isStartingScanner = useRef(false);

  useEffect(() => { setMounted(true); }, []);
  useEffect(() => { if (mounted && !authLoading && !user) router.push('/'); }, [user, authLoading, router, mounted]);

  const userDocRef = useMemo(() => (user && db) ? doc(db, 'users', user.uid) : null, [db, user?.uid]);
  const { data: profile, loading: profileLoading } = useDoc(userDocRef);
  
  const transactionsQuery = useMemo(() => (user && db) ? query(collection(db, 'users', user.uid, 'transactions'), orderBy('date', 'desc'), limit(10)) : null, [db, user?.uid]);
  const { data: transactions = [] } = useCollection(transactionsQuery);

  const notificationsQuery = useMemo(() => (user && db) ? query(collection(db, 'users', user.uid, 'notifications'), orderBy('date', 'desc')) : null, [db, user?.uid]);
  const { data: notifications = [] } = useCollection(notificationsQuery);
  const unreadCount = notifications.filter((n: any) => !n.read).length;

  useEffect(() => {
    if (!db) return;
    const unsub = onSnapshot(doc(db, 'system_settings', 'chat_config'), (doc) => {
      if (doc.exists()) setChatStatus(doc.data());
    });
    return () => unsub();
  }, [db]);

  useEffect(() => {
    if (!db || !user || supportStep !== 'chat') return;
    const sessionsQuery = query(collection(db, 'chat_sessions'), where('userId', '==', user.uid));
    const unsubSessions = onSnapshot(sessionsQuery, (snap) => {
      if (!snap.empty) {
        const relevantDocs = snap.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter((s: any) => ['open', 'active', 'closed', 'archived'].includes(s.status))
          .sort((a: any, b: any) => new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime());

        if (relevantDocs.length > 0) {
          const session = relevantDocs[0];
          setChatSession(session);
          
          const msgsQuery = query(collection(db, 'chat_sessions', session.id, 'messages'), orderBy('timestamp', 'asc'));
          onSnapshot(msgsQuery, (mSnap) => {
            setMessages(mSnap.docs.map(d => ({ id: d.id, ...d.data() })));
            setTimeout(() => chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
          });
        }
      } else {
        setChatSession(null);
        setMessages([]);
      }
    });
    return () => unsubSessions();
  }, [db, user, supportStep]);

  const generateCaseId = () => `FL-${Math.floor(1000 + Math.random() * 9000)}`;

  const handleStartChat = async () => {
    if (!user || !profile || !db) return;
    setIsStartingChat(true);
    setShowRatingUI(false);
    setUserRating(0);
    setUserFeedback('');
    try {
      const caseId = generateCaseId();
      const newSessionRef = await addDoc(collection(db, 'chat_sessions'), {
        userId: user.uid,
        username: profile.username,
        email: profile.email,
        status: 'open',
        caseId: caseId,
        lastMessage: 'Protocol Initiated',
        updatedAt: new Date().toISOString()
      });
      await addDoc(collection(db, 'chat_sessions', newSessionRef.id, 'messages'), {
        text: language === 'ar' ? `مرحباً بك في دعم فلاش المباشر. تم فتح تذكرة برقم ${caseId}. يرجى وصف مشكلتك بالتفصيل.` : `Welcome to Flash Live Support. Case #${caseId} opened. Please describe your issue in detail.`,
        senderId: 'system',
        isAdmin: true,
        timestamp: new Date().toISOString()
      });
    } catch (e) {
      toast({ variant: "destructive", title: "Chat Error" });
    } finally {
      setIsStartingChat(false);
    }
  };

  const handleSendChatMessage = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!chatMessage.trim() || !user || !profile || !chatSession) return;
    try {
      await addDoc(collection(db, 'chat_sessions', chatSession.id, 'messages'), {
        text: chatMessage.trim(),
        senderId: user.uid,
        isAdmin: false,
        timestamp: new Date().toISOString()
      });
      await updateDoc(doc(db, 'chat_sessions', chatSession.id), {
        lastMessage: chatMessage.trim(),
        updatedAt: new Date().toISOString()
      });
      if (messages.length <= 2) {
        const telegramMsg = `💬 <b>New Live Chat Protocol [${chatSession.caseId}]</b>\n━━━━━━━━━━━━━━━━\n<b>From:</b> @${profile.username}\n<b>Email:</b> ${profile.email}\n<b>Issue:</b>\n${chatMessage.trim()}`;
        await sendTelegramNotification(telegramMsg);
      }
      setChatMessage('');
    } catch (e) {
      toast({ variant: "destructive", title: "Chat Error" });
    }
  };

  const submitRating = async () => {
    if (!chatSession || !db || userRating === 0) return;
    setIsSubmittingRating(true);
    try {
      await updateDoc(doc(db, 'chat_sessions', chatSession.id), {
        rating: userRating,
        feedback: userFeedback.trim(),
        status: 'archived',
        updatedAt: new Date().toISOString()
      });
      toast({ title: language === 'ar' ? "شكراً لتقييمك" : "Thank you for rating" });
      setShowRatingUI(false);
    } catch (e) { 
      toast({ variant: "destructive", title: "Rating failed" });
    } finally {
      setIsSubmittingRating(false);
    }
  };

  useEffect(() => {
    let isMounted = true;
    const stopScanner = async () => {
      if (scannerRef.current) {
        try {
          if (scannerRef.current.getState() === 2) await scannerRef.current.stop();
          await scannerRef.current.clear();
        } catch (e) { console.warn(e); } finally { scannerRef.current = null; }
      }
    };
    const startScanner = async () => {
      if (isStartingScanner.current) return;
      isStartingScanner.current = true;
      await new Promise(resolve => setTimeout(resolve, 600));
      if (!isMounted || !isScannerOpen) { isStartingScanner.current = false; return; }
      const readerElement = document.getElementById("reader");
      if (!readerElement) { isStartingScanner.current = false; return; }
      try {
        await stopScanner(); 
        const html5QrCode = new Html5Qrcode("reader");
        scannerRef.current = html5QrCode;
        await html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: { width: 250, height: 250 } },
          (decodedText) => {
            if (!isMounted) return;
            setScannerOpen(false);
            router.push(`/transfer?id=${decodedText.toUpperCase()}`);
            toast({ title: language === 'ar' ? "تم التعرف على الكود" : "ID DETECTED" });
          },
          () => {} 
        );
      } catch (err) {
        if (isMounted) {
          setScannerOpen(false);
          toast({ variant: "destructive", title: language === 'ar' ? "خطأ في الكاميرا" : "CAMERA ERROR" });
        }
      } finally { isStartingScanner.current = false; }
    };
    if (isScannerOpen) startScanner();
    else stopScanner();
    return () => { isMounted = false; stopScanner(); };
  }, [isScannerOpen, language, toast, setScannerOpen, router]);

  const copyId = () => {
    if (profile?.customId) {
      navigator.clipboard.writeText(profile.customId);
      toast({ title: "COPIED TO CLIPBOARD" });
    }
  };

  const handleSupportSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user || !db || !supportSubject.trim() || !supportMessage.trim()) return;
    setIsSubmittingSupport(true);
    try {
      await addDoc(collection(db, 'support_tickets'), {
        userId: user.uid,
        username: profile?.username || 'unknown',
        email: profile?.email || 'unknown',
        subject: supportSubject.trim(),
        message: supportMessage.trim(),
        imageUrl: supportImage,
        status: 'open',
        date: new Date().toISOString()
      });
      const telegramMsg = `🎫 <b>New Support Ticket</b>\n━━━━━━━━━━━━━━━━\n<b>From:</b> @${profile?.username}\n<b>Subject:</b> ${supportSubject}\n<b>Message:</b>\n${supportMessage}`;
      if (supportImage) await sendTelegramPhoto(supportImage, telegramMsg);
      else await sendTelegramNotification(telegramMsg);
      toast({ title: language === 'ar' ? "تم إرسال طلبك" : "Ticket Submitted" });
      setIsSupportOpen(false);
      setSupportStep('options');
    } catch (err: any) { toast({ variant: "destructive", title: "Error" }); } finally { setIsSubmittingSupport(false); }
  };

  const handleSupportImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => setSupportImage(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const markNotificationsAsRead = async () => {
    if (!user || !db || unreadCount === 0) return;
    notifications.forEach(async (n: any) => {
      if (!n.read) await updateDoc(doc(db, 'users', user.uid, 'notifications', n.id), { read: true });
    });
  };

  const deleteNotification = async (id: string) => {
    if (!user || !db) return;
    await deleteDoc(doc(db, 'users', user.uid, 'notifications', id));
  };

  if (!mounted) return null;
  if (authLoading || (profileLoading && !profile)) return <div className="min-h-screen bg-background flex items-center justify-center"><Loader2 className="animate-spin text-primary" /></div>;

  return (
    <div className="min-h-screen bg-background text-foreground pb-32">
      <header className="flex justify-between items-center px-8 py-10">
        <button onClick={() => setIsSettingsOpen(true)} className="flex items-center gap-4 group">
          <div className={cn("w-14 h-14 rounded-2xl border-2 transition-all duration-500 flex items-center justify-center relative overflow-hidden", profile?.verified ? "border-green-500 shadow-[0_0_15px_rgba(34,197,94,0.4)]" : "border-red-500 shadow-lg")}>{profile?.avatarUrl ? <img src={profile.avatarUrl} className="w-full h-full object-cover" /> : <User size={24} className="text-muted-foreground" />}</div>
          <div className="text-left">
            <div className="flex items-center gap-1.5 mb-0.5">{profile?.verified && <ShieldCheck size={10} className="text-green-500" />}{profile?.emailVerified && <MailCheck size={10} className="text-primary" />}{profile?.phoneVerified && <Smartphone size={10} className="text-blue-500" />}<p className="text-[9px] text-primary font-headline font-bold tracking-widest uppercase">{profile?.verified ? (language === 'ar' ? "هوية موثقة" : "Entity Verified") : (language === 'ar' ? "غير موثق" : "Unverified")}</p></div>
            <p className="font-headline font-bold text-sm">@{profile?.username}</p>
          </div>
        </button>
        <button onClick={() => { setIsNotifOpen(true); markNotificationsAsRead(); }} className="relative p-2 text-muted-foreground hover:text-foreground transition-all">
          <Bell size={24} />
          {unreadCount > 0 && <span className="absolute top-1 right-1 w-4 h-4 bg-red-500 text-[8px] font-bold text-white rounded-full flex items-center justify-center border-2 border-background">{unreadCount}</span>}
        </button>
      </header>

      <main className="px-8 space-y-10">
        <section className="text-center py-10 glass-card rounded-[2.5rem] gold-glow border-primary/20">
          <p className="text-muted-foreground text-[10px] uppercase tracking-[0.4em] font-headline mb-4">{language === 'ar' ? 'إجمالي الأصول' : 'Current Asset Value'}</p>
          <h1 className="text-5xl font-headline font-bold text-foreground tracking-tighter">${profile?.balance?.toLocaleString()}<span className="text-xl opacity-20">.00</span></h1>
          <div className="mt-6 inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-primary/10 border border-primary/20"><div className="w-1.5 h-1.5 bg-primary animate-pulse rounded-full"></div><span className="text-[8px] text-primary tracking-[0.2em] font-headline font-bold uppercase">Vault Secure v2.5.0</span></div>
        </section>

        <section className="grid grid-cols-3 gap-3">
          <Link href="/transfer" className="flex flex-col items-center gap-2 py-4 glass-card rounded-2xl hover:border-primary transition-all group"><div className="p-3 rounded-xl bg-primary/10 group-hover:bg-primary group-hover:text-primary-foreground transition-all"><Send size={20} /></div><span className="text-[7px] font-headline font-bold uppercase tracking-widest">{language === 'ar' ? 'إرسال' : 'Send'}</span></Link>
          <Link href="/deposit" className="flex flex-col items-center gap-2 py-4 glass-card rounded-2xl hover:border-secondary transition-all group"><div className="p-3 rounded-xl bg-secondary/10 group-hover:bg-secondary group-hover:text-background transition-all"><Wallet size={20} /></div><span className="text-[7px] font-headline font-bold uppercase tracking-widest">{language === 'ar' ? 'إيداع' : 'Deposit'}</span></Link>
          <Link href="/withdraw" className="flex flex-col items-center gap-2 py-4 glass-card rounded-2xl hover:border-foreground/20 transition-all group"><div className="p-3 rounded-xl bg-muted group-hover:bg-foreground group-hover:text-background transition-all"><ArrowDownLeft size={20} /></div><span className="text-[7px] font-headline font-bold uppercase tracking-widest">{language === 'ar' ? 'سحب' : 'Withdraw'}</span></Link>
        </section>

        <section className="space-y-6">
          <div className="flex justify-between items-center"><h3 className="text-[10px] font-headline font-bold uppercase tracking-widest text-muted-foreground">{language === 'ar' ? 'سجل العمليات' : 'Recent Ledger'}</h3><Link href="/transactions" className="text-[8px] font-headline text-primary hover:underline">{language === 'ar' ? 'استخراج الكل' : 'EXTRACT ALL'}</Link></div>
          <div className="space-y-3">
            {transactions.map((tx: any) => (
              <div key={tx.id} className="flex justify-between items-center p-5 glass-card rounded-2xl border-border/40 hover:bg-muted/5 transition-all">
                <div className="flex items-center gap-4">
                  <div className={cn("w-1 h-10 rounded-full", (tx.type === 'send' || tx.type === 'withdraw' || tx.type === 'purchase') ? "bg-red-500/40" : "bg-primary/40")} />
                  <div>
                    <p className="font-headline font-bold text-[10px] uppercase">{tx.type === 'send' ? (language === 'ar' ? `تحويل إلى @${tx.recipient}` : `SENT TO @${tx.recipient}`) : tx.type === 'receive' ? (language === 'ar' ? `استلام من @${tx.sender || 'SYSTEM'}` : `RECEIVED FROM @${tx.sender || 'SYSTEM'}`) : tx.type === 'withdraw' ? (language === 'ar' ? 'طلب سحب رصيد' : 'WITHDRAWAL INITIATED') : tx.type === 'deposit' ? (language === 'ar' ? 'تأكيد إيداع' : 'DEPOSIT CONFIRMED') : tx.type === 'refund' ? (language === 'ar' ? 'استرداد رصيد' : 'ASSET REFUNDED') : `${tx.service}`}</p>
                    <p className="text-[8px] text-muted-foreground uppercase tracking-widest mt-1">{new Date(tx.date).toLocaleDateString()}</p>
                  </div>
                </div>
                <p className={cn("font-headline font-bold text-xs", (tx.type === 'send' || tx.type === 'withdraw' || tx.type === 'purchase') ? "text-foreground" : "text-primary")}>{(tx.type === 'send' || tx.type === 'withdraw' || tx.type === 'purchase') ? '-' : '+'}${tx.amount}</p>
              </div>
            ))}
          </div>
        </section>
      </main>

      {/* Support Modal */}
      <Dialog open={isSupportOpen} onOpenChange={setIsSupportOpen}>
        <DialogContent className="max-w-sm glass-card border-border/40 p-6 sm:p-8 rounded-[2.5rem] z-[1001] max-h-[90vh] overflow-y-auto no-scrollbar">
          <DialogHeader className="relative mb-6">
            <button onClick={() => { if (supportStep === 'options') setIsSupportOpen(false); else setSupportStep('options'); }} className={cn("absolute top-1/2 -translate-y-1/2 p-2 hover:bg-white/5 rounded-xl transition-all text-muted-foreground hover:text-secondary", language === 'ar' ? "right-[-10px]" : "left-[-10px]")}><ChevronLeft className={cn("h-6 w-6", language === 'ar' && "rotate-180")} /></button>
            <DialogTitle className="text-xs font-headline font-bold tracking-widest uppercase text-center w-full">{language === 'ar' ? 'مركز الدعم والمساعدة' : 'Support Command Center'}</DialogTitle>
          </DialogHeader>

          {supportStep === 'options' ? (
            <div className="space-y-4 animate-in fade-in zoom-in-95 duration-300">
              <button onClick={() => setSupportStep('form')} className="w-full p-6 glass-card rounded-3xl border-secondary/20 flex items-center gap-5 hover:border-secondary transition-all group"><div className="w-12 h-12 rounded-2xl bg-secondary/10 flex items-center justify-center text-secondary group-hover:scale-110 transition-transform"><MessageSquare size={24} /></div><div className="text-left"><p className="text-[11px] font-headline font-bold uppercase">{language === 'ar' ? 'مراسلة الدعم' : 'Contact Support'}</p><p className="text-[8px] text-muted-foreground uppercase">{language === 'ar' ? 'افتح تذكرة دعم فني جديدة' : 'Open a new encrypted ticket'}</p></div></button>
              <button onClick={() => setSupportStep('chat')} className="w-full p-6 glass-card rounded-3xl border-primary/20 flex items-center gap-5 hover:border-primary transition-all group"><div className="w-12 h-12 rounded-2xl bg-primary/10 flex items-center justify-center text-primary group-hover:scale-110 transition-transform"><CircleDot size={24} className="animate-pulse" /></div><div className="text-left"><p className="text-[11px] font-headline font-bold uppercase">{language === 'ar' ? 'دردشة مباشرة' : 'Direct Live Chat'}</p><p className="text-[8px] text-muted-foreground uppercase">{language === 'ar' ? 'تواصل فوري مع الموظف' : 'Immediate connection with agent'}</p></div></button>
              <a href="https://t.me/flash_support" target="_blank" className="w-full p-6 glass-card rounded-3xl border-blue-500/20 flex items-center gap-5 hover:border-blue-500 transition-all group"><div className="w-12 h-12 rounded-2xl bg-blue-500/10 flex items-center justify-center text-blue-500 group-hover:scale-110 transition-transform"><SendHorizontal size={24} /></div><div className="text-left"><p className="text-[11px] font-headline font-bold uppercase">Telegram Support</p><p className="text-[8px] text-muted-foreground uppercase">Direct immediate connection</p></div></a>
            </div>
          ) : supportStep === 'form' ? (
            <form onSubmit={handleSupportSubmit} className="space-y-5 animate-in slide-in-from-right-4 duration-300">
              <div className="space-y-4">
                <div className="grid grid-cols-2 gap-3"><div className="space-y-1.5"><Label className="text-[8px] uppercase tracking-widest text-muted-foreground">{language === 'ar' ? 'الاسم' : 'ID NAME'}</Label><Input value={`${profile?.firstName || ''} ${profile?.lastName || ''}`.trim() || profile?.username} disabled className="h-10 bg-white/5 border-white/10 text-[10px] font-headline opacity-60" /></div><div className="space-y-1.5"><Label className="text-[8px] uppercase tracking-widest text-muted-foreground">{language === 'ar' ? 'البريد' : 'AUTHORITY MAIL'}</Label><Input value={profile?.email} disabled className="h-10 bg-white/5 border-white/10 text-[10px] font-headline opacity-60" /></div></div>
                <div className="space-y-1.5"><Label className="text-[8px] uppercase tracking-widest text-secondary">{language === 'ar' ? 'الموضوع' : 'PROTOCOL SUBJECT'}</Label><Input placeholder={language === 'ar' ? 'ما هي مشكلتك؟' : 'DESCRIBE ISSUE TYPE'} className="h-12 bg-background/50 border-white/10 text-[10px] font-headline uppercase focus:border-secondary/50" value={supportSubject} onChange={(e) => setSupportSubject(e.target.value)} required /></div>
                <div className="space-y-1.5"><Label className="text-[8px] uppercase tracking-widest text-secondary">{language === 'ar' ? 'الرسالة' : 'DETAILED INTEL'}</Label><Textarea placeholder={language === 'ar' ? 'اشرح بالتفصيل...' : 'PROVIDE FULL CONTEXT'} className="min-h-[120px] bg-background/50 border-white/10 text-[10px] font-headline uppercase focus:border-secondary/50 pt-3" value={supportMessage} onChange={(e) => setSupportMessage(e.target.value)} required /></div>
                <div className="space-y-1.5"><Label className="text-[8px] uppercase tracking-widest text-muted-foreground">{language === 'ar' ? 'إرفاق صورة (اختياري)' : 'ATTACH VISUAL EVIDENCE (OPTIONAL)'}</Label><div onClick={() => supportFileInputRef.current?.click()} className="w-full h-24 border border-dashed border-white/10 rounded-2xl flex flex-col items-center justify-center gap-2 cursor-pointer hover:bg-secondary/5 transition-all group overflow-hidden">{supportImage ? <img src={supportImage} className="w-full h-full object-cover" /> : <><ImageIcon size={20} className="text-muted-foreground group-hover:text-secondary transition-colors" /><span className="text-[7px] font-headline uppercase text-muted-foreground">Upload Protocol Evidence</span></>}<input type="file" ref={supportFileInputRef} className="hidden" accept="image/*" onChange={handleSupportImageUpload} /></div></div>
              </div>
              <button type="submit" disabled={isSubmittingSupport} className="w-full h-14 bg-secondary text-background font-headline font-black text-[10px] tracking-widest rounded-2xl cyan-glow flex items-center justify-center gap-2 hover:scale-[1.02] transition-all">{isSubmittingSupport ? <Loader2 className="animate-spin" /> : (language === 'ar' ? 'إرسال التذكرة' : 'DEPLOY SUPPORT TICKET')}</button>
            </form>
          ) : (
            <div className="flex flex-col h-[500px] animate-in slide-in-from-right-4 duration-300">
              {!chatSession ? (
                <div className="flex-1 flex flex-col items-center justify-center text-center p-6 space-y-6">
                  <div className="w-20 h-20 bg-primary/10 rounded-full flex items-center justify-center text-primary border border-primary/20"><CircleDot size={40} className="animate-pulse" /></div>
                  <div className="space-y-2"><h3 className="text-xs font-headline font-bold uppercase tracking-widest">{language === 'ar' ? 'ابدأ محادثة جديدة' : 'Initialize Protocol'}</h3><p className="text-[8px] text-muted-foreground uppercase">{language === 'ar' ? 'تواصل فوري مع خبراء فلاش' : 'Direct link to Flash Authority'}</p></div>
                  <Button onClick={handleStartChat} disabled={isStartingChat} className="w-full h-14 bg-primary text-background rounded-2xl font-headline font-black text-[10px] tracking-widest gold-glow">{isStartingChat ? <Loader2 className="animate-spin" /> : (language === 'ar' ? 'بدء الدردشة الآن' : 'START NEW CONVERSATION')}</Button>
                </div>
              ) : (
                <>
                  <div className="p-3 border-b border-white/5 flex justify-between items-center bg-white/5 rounded-t-2xl">
                    <p className="text-[8px] font-headline font-bold text-primary tracking-widest uppercase">CASE: {chatSession.caseId}</p>
                    <Badge variant="outline" className="text-[6px] h-4 border-primary/20 text-primary uppercase">{chatSession.status === 'active' ? (language === 'ar' ? 'متصل' : 'AGENT JOINED') : (language === 'ar' ? 'قيد الانتظار' : 'WAITING')}</Badge>
                  </div>
                  <div className="flex-1 overflow-y-auto space-y-4 p-4 no-scrollbar">
                    {messages.map((msg) => (
                      <div key={msg.id} className={cn("flex flex-col max-w-[85%]", msg.isAdmin ? "self-start items-start" : "self-end items-end")}>
                        <div className={cn("p-3 rounded-2xl text-[10px] font-headline", msg.isAdmin ? "bg-muted text-foreground rounded-tl-none border border-white/5" : "bg-primary text-background rounded-tr-none shadow-lg")}>{msg.text}</div>
                        <span className="text-[6px] text-muted-foreground mt-1 uppercase">{new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                      </div>
                    ))}

                    {chatSession.status === 'closed' && (
                      <div className="animate-in fade-in zoom-in-95 duration-500 py-4">
                        {!showRatingUI ? (
                          <div className="glass-card p-6 rounded-3xl border-primary/20 bg-primary/5 space-y-4 text-center">
                            <div className="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center text-primary mx-auto border border-primary/20"><CheckCircle2 size={24} /></div>
                            <div className="space-y-1">
                              <p className="text-[10px] font-headline font-bold uppercase tracking-widest">{language === 'ar' ? 'تم إنهاء البروتوكول' : 'Protocol Terminated'}</p>
                              <p className="text-[7px] text-muted-foreground uppercase">{language === 'ar' ? 'تم حل المشكلة. نرجو منك تقييم الخدمة.' : 'Issue resolved. Please authorize service evaluation.'}</p>
                            </div>
                            <Button onClick={() => setShowRatingUI(true)} className="w-full h-12 bg-primary text-background rounded-xl font-headline font-black text-[9px] tracking-widest gold-glow">
                              {language === 'ar' ? 'بدء التقييم الآن' : 'BEGIN EVALUATION'}
                            </Button>
                          </div>
                        ) : (
                          <div className="glass-card p-6 rounded-3xl border-primary/20 bg-primary/5 space-y-6 animate-in slide-in-from-bottom-4">
                            <div className="text-center space-y-1">
                              <p className="text-[10px] font-headline font-bold uppercase text-primary">{language === 'ar' ? 'كيف كانت تجربتك؟' : 'Rate Your Experience'}</p>
                              <p className="text-[7px] text-muted-foreground uppercase">Case ID: {chatSession.caseId}</p>
                            </div>
                            <div className="flex justify-center gap-3">
                              {[1, 2, 3, 4, 5].map((s) => (
                                <button key={s} onClick={() => setUserRating(s)} className={cn("p-1 transition-all hover:scale-125", userRating >= s ? "text-primary" : "text-white/10")}><Star fill={userRating >= s ? "currentColor" : "none"} size={28} /></button>
                              ))}
                            </div>
                            <div className="space-y-2">
                              <Label className="text-[8px] uppercase tracking-widest text-muted-foreground">{language === 'ar' ? 'ملاحظات إضافية' : 'Protocol Feedback'}</Label>
                              <Textarea 
                                placeholder={language === 'ar' ? 'اكتب تجربتك هنا...' : 'PROVIDE CONTEXTUAL FEEDBACK...'} 
                                className="bg-background/50 border-white/10 text-[9px] font-headline uppercase min-h-[80px]"
                                value={userFeedback}
                                onChange={(e) => setUserFeedback(e.target.value)}
                              />
                            </div>
                            <Button onClick={submitRating} disabled={isSubmittingRating || userRating === 0} className="w-full h-12 bg-primary text-background rounded-xl font-headline font-black text-[9px] tracking-widest gold-glow">
                              {isSubmittingRating ? <Loader2 className="animate-spin" /> : (language === 'ar' ? 'إرسال التقييم' : 'TRANSMIT FEEDBACK')}
                            </Button>
                          </div>
                        )}
                      </div>
                    )}

                    {chatSession.status === 'archived' && (
                      <div className="py-6 text-center animate-in fade-in">
                        <div className="w-12 h-12 bg-green-500/10 rounded-full flex items-center justify-center text-green-500 mx-auto mb-3"><CheckCircle2 size={24} /></div>
                        <p className="text-[10px] font-headline font-bold uppercase text-green-500">{language === 'ar' ? 'شكراً لتقييمك!' : 'Feedback Secured'}</p>
                        <p className="text-[7px] text-muted-foreground uppercase mt-1">{language === 'ar' ? 'تم أرشفة هذه التذكرة بنجاح.' : 'Protocol archived in global ledger.'}</p>
                        <Button variant="ghost" onClick={() => setSupportStep('options')} className="mt-4 text-[8px] font-headline uppercase text-muted-foreground hover:text-white">Return to Command</Button>
                      </div>
                    )}

                    <div ref={chatEndRef} />
                  </div>
                  
                  {chatSession.status === 'active' || chatSession.status === 'open' ? (
                    <>
                      {messages.length > 1 && chatSession.status === 'open' && (
                        <div className="mx-4 py-2 px-4 bg-primary/10 border border-primary/20 rounded-xl mb-2 text-center animate-pulse"><p className="text-[8px] font-headline font-black text-primary uppercase tracking-widest">{chatStatus?.isActive ? (language === 'ar' ? 'جاري البحث عن موظف...' : 'Searching for an agent...') : (language === 'ar' ? 'سيتم التواصل معك في أوقات العمل' : 'We will contact you during working hours')}</p></div>
                      )}
                      <form onSubmit={handleSendChatMessage} className="mt-auto p-4 pt-0 flex gap-2"><Input placeholder={language === 'ar' ? 'اكتب هنا...' : 'TYPE MESSAGE...'} className="h-12 bg-white/5 border-white/10 rounded-xl text-[10px] font-headline" value={chatMessage} onChange={(e) => setChatMessage(e.target.value)} /><button type="submit" disabled={!chatMessage.trim()} className="w-12 h-12 bg-primary text-background rounded-xl flex items-center justify-center hover:scale-105 transition-all disabled:opacity-50"><SendHorizontal size={20} /></button></form>
                    </>
                  ) : null}
                </>
              )}
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* QR Modal */}
      <Dialog open={isQrOpen} onOpenChange={setIsQrOpen}><DialogContent className="max-w-sm glass-card border-border/40 p-10 text-center rounded-[2.5rem] z-[1001]"><DialogHeader><DialogTitle className="text-xs font-headline font-bold tracking-widest uppercase text-primary">{language === 'ar' ? 'المعرف التشفيري' : 'Cryptographic Identifier'}</DialogTitle></DialogHeader><div className="space-y-8 mt-6"><div className="p-6 bg-white rounded-3xl inline-block shadow-lg"><img src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${profile?.customId}`} alt="QR" className="w-48 h-48" /></div><div className="space-y-2"><p className="text-center text-[10px] font-headline font-bold text-muted-foreground uppercase">{language === 'ar' ? 'معرف الكيان' : 'Entity ID'}</p><p className="text-center text-sm font-headline font-black tracking-widest text-foreground">{profile?.customId}</p></div><button onClick={copyId} className="w-full h-14 bg-primary text-primary-foreground font-headline font-bold rounded-2xl gold-glow hover:scale-105 transition-all">{language === 'ar' ? 'نسخ المعرف' : 'COPY FLASH ID'}</button></div></DialogContent></Dialog>

      {/* Notification Modal */}
      <Dialog open={isNotifOpen} onOpenChange={setIsNotifOpen}><DialogContent className="max-w-sm glass-card border-border/40 p-8 rounded-[2rem] max-h-[80vh] overflow-y-auto z-[1000]"><DialogHeader><DialogTitle className="text-xs font-headline font-bold tracking-widest uppercase text-center mb-4">{language === 'ar' ? 'شريط الحماية' : 'Security Feed'}</DialogTitle></DialogHeader><div className="space-y-4">{notifications.length === 0 ? <p className="text-center text-[10px] text-muted-foreground uppercase font-headline py-10">{language === 'ar' ? 'النظام خالي من التنبيهات' : 'System is clear'}</p> : notifications.map((n: any) => (<div key={n.id} className={cn("p-4 rounded-2xl border transition-all relative group", n.read ? "bg-muted/20 border-border/40" : "bg-primary/5 border-primary/20 shadow-lg")}><button onClick={() => deleteNotification(n.id)} className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity p-1 text-muted-foreground hover:text-red-500"><Trash2 size={12} /></button><div className="flex justify-between items-start mb-2"><p className="text-[10px] font-headline font-bold uppercase text-primary">{n.title}</p><p className="text-[7px] text-muted-foreground uppercase">{new Date(n.date).toLocaleTimeString()}</p></div><p className="text-[9px] text-muted-foreground leading-relaxed">{n.message}</p></div>))}</div></DialogContent></Dialog>

      {/* Settings Modal */}
      <Dialog open={isSettingsOpen} onOpenChange={setIsSettingsOpen}>
        <DialogContent className="max-w-sm glass-card border-border/40 p-6 sm:p-8 rounded-[2rem] z-[1000] max-h-[90vh] overflow-y-auto no-scrollbar animate-in fade-in slide-in-from-bottom-10 duration-500">
          <DialogHeader className="relative mb-4"><button onClick={() => setIsSettingsOpen(false)} className={cn("absolute top-1/2 -translate-y-1/2 p-2 hover:bg-white/5 rounded-xl transition-all text-muted-foreground hover:text-primary", language === 'ar' ? "right-[-10px]" : "left-[-10px]")}><ChevronLeft className={cn("h-6 w-6", language === 'ar' && "rotate-180")} /></button><DialogTitle className="text-xs font-headline font-bold tracking-widest uppercase text-center w-full">{language === 'ar' ? 'الإعدادات والتحكم' : 'Settings & Entity Control'}</DialogTitle></DialogHeader>
          <div className="space-y-6 sm:space-y-8 mt-4">
            <div className="flex flex-col items-center gap-4 text-center"><div className={cn("w-20 h-20 rounded-2xl border-2 flex items-center justify-center relative overflow-hidden shadow-xl", profile?.verified ? "border-green-500" : "border-red-500")}>{profile?.avatarUrl ? <img src={profile.avatarUrl} className="w-full h-full object-cover" /> : <User size={32} />}</div><div className="space-y-2"><h3 className="text-md font-headline font-bold tracking-tight">@{profile?.username}</h3><button onClick={copyId} className="px-4 py-2 bg-muted text-[9px] font-headline font-bold uppercase tracking-widest rounded-full border border-border/40 flex items-center gap-2 hover:bg-muted/80 transition-all">ID: {profile?.customId} <Copy size={12} /></button></div></div>
            <div className="space-y-3 pb-4">
              <ThemeToggle /><button onClick={() => { setIsSettingsOpen(false); setIsQrOpen(true); }} className="w-full h-14 glass-card rounded-2xl flex items-center px-6 gap-4 hover:border-primary transition-all"><QrCode size={18} className="text-primary" /><span className="text-[10px] font-headline font-bold uppercase tracking-widest">{language === 'ar' ? 'المعرف الرقمي الخاص بي' : 'My Flash Identifier'}</span></button>
              <Link href="/profile/edit" className="w-full h-14 glass-card rounded-2xl flex items-center px-6 gap-4 hover:border-primary transition-all"><Settings size={18} className="text-muted-foreground" /><span className="text-[10px] font-headline font-bold uppercase tracking-widest">{language === 'ar' ? 'تعديل الحساب' : 'Configure Account'}</span></Link>
              <button onClick={toggleLanguage} className="w-full h-14 glass-card rounded-2xl flex items-center px-6 gap-4 hover:bg-muted/20 transition-all"><Languages size={18} /><span className="text-[10px] font-headline font-bold uppercase tracking-widest">{language === 'ar' ? 'اللغة: العربية' : 'Language: EN'}</span></button>
              <button onClick={() => { setIsSettingsOpen(false); setIsSupportOpen(true); }} className="w-full h-14 glass-card rounded-2xl flex items-center px-6 gap-4 hover:border-secondary transition-all"><Headset size={18} className="text-secondary" /><span className="text-[10px] font-headline font-bold uppercase tracking-widest">{language === 'ar' ? 'الدعم الفني' : 'Support Center'}</span></button>
              <button onClick={() => signOut(auth)} className="w-full h-14 glass-card rounded-2xl border-red-500/20 text-red-500 flex items-center px-6 gap-4 hover:bg-red-500 hover:text-white transition-all"><LogOut size={18} /><span className="text-[10px] font-headline font-bold uppercase tracking-widest">{language === 'ar' ? 'تسجيل الخروج' : 'Terminate Access'}</span></button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      <Dialog open={isScannerOpen} onOpenChange={setScannerOpen}>
        <DialogContent className="max-w-sm glass-card border-white/10 p-6 rounded-[2rem] z-[1001]">
          <DialogHeader><DialogTitle className="text-xs font-headline font-bold uppercase text-center">{language === 'ar' ? 'ماسح المعرف' : 'Flash ID Scanner'}</DialogTitle></DialogHeader>
          <div className="mt-4 relative aspect-square overflow-hidden rounded-2xl border-2 border-primary/20 bg-black/40">
            <div id="reader" className="w-full h-full"></div>
            <div className="absolute inset-0 pointer-events-none border-[40px] border-black/40"></div>
            <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-48 h-48 border-2 border-primary rounded-2xl shadow-[0_0_20px_rgba(250,218,122,0.4)]">
              <div className="absolute top-0 left-0 w-full h-0.5 bg-primary animate-[scan_2s_linear_infinite]"></div>
            </div>
          </div>
          <p className="text-[8px] text-muted-foreground uppercase text-center mt-4 tracking-widest">{language === 'ar' ? 'قم بتوجيه الكاميرا نحو كود المستلم' : 'Position Flash ID within the frame'}</p>
          <Button variant="ghost" onClick={() => setScannerOpen(false)} className="w-full mt-4 text-[9px] font-headline font-bold uppercase tracking-widest text-red-500">{language === 'ar' ? 'إلغاء' : 'Abort Scan'}</Button>
        </DialogContent>
      </Dialog>

      <style jsx global>{`
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      `}</style>
    </div>
  );
}


--- START: /src/app/deposit/page.tsx ---

"use client"

import { useState, useMemo, useEffect, useRef } from 'react';
import { useRouter } from 'next/navigation';
import { useStore } from '@/app/lib/store';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Label } from '@/components/ui/label';
import { Badge } from '@/components/ui/badge';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { ChevronLeft, Loader2, Wallet, Camera, Check, Info, Landmark, User as UserIcon, Copy } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { cn } from '@/lib/utils';
import { useUser, useFirestore, useDoc, useCollection } from '@/firebase';
import { collection, doc, addDoc, query, where } from 'firebase/firestore';
import { sendTelegramPhoto } from '@/lib/telegram';

const COUNTRIES = [
  { code: 'GL', name: 'Global / Worldwide', ar: 'عالمي / دولي' },
  { code: 'CR', name: 'Crypto / Digital Assets', ar: 'عملات رقمية' },
  { code: 'SA', name: 'Saudi Arabia', ar: 'السعودية' },
  { code: 'EG', name: 'Egypt', ar: 'مصر' },
  { code: 'AE', name: 'UAE', ar: 'الإمارات' },
  { code: 'KW', name: 'Kuwait', ar: 'الكويت' },
  { code: 'QA', name: 'Qatar', ar: 'قطر' },
  { code: 'JO', name: 'Jordan', ar: 'الأردن' },
  { code: 'IQ', name: 'Iraq', ar: 'العراق' },
  { code: 'LY', name: 'Libya', ar: 'ليبيا' },
  { code: 'DZ', name: 'Algeria', ar: 'الجزائر' },
  { code: 'MA', name: 'Morocco', ar: 'المغرب' },
  { code: 'PS', name: 'Palestine', ar: 'فلسطين' },
  { code: 'LB', name: 'Lebanon', ar: 'لبنان' },
  { code: 'SY', name: 'Syria', ar: 'سوريا' },
  { code: 'OM', name: 'Oman', ar: 'عمان' },
  { code: 'YE', name: 'Yemen', ar: 'اليمن' },
  { code: 'BH', name: 'Bahrain', ar: 'البحرين' },
  { code: 'TN', name: 'Tunisia', ar: 'تونس' },
  { code: 'SD', name: 'Sudan', ar: 'السودان' },
  { code: 'US', name: 'USA', ar: 'أمريكا' },
  { code: 'GB', name: 'UK', ar: 'بريطانيا' },
  { code: 'CA', name: 'Canada', ar: 'كندا' },
];

export default function DepositPage() {
  const router = useRouter();
  const { user } = useUser();
  const db = useFirestore();
  const { toast } = useToast();
  const { language } = useStore();
  const fileInputRef = useRef<HTMLInputElement>(null);
  
  const [step, setStep] = useState(1); 
  const [selectedCountry, setSelectedCountry] = useState<string>('');
  const [selectedMethod, setSelectedMethod] = useState<any>(null);
  const [amount, setAmount] = useState('');
  const [senderName, setSenderName] = useState('');
  const [proofImage, setProofImage] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const userDocRef = useMemo(() => user ? doc(db, 'users', user.uid) : null, [db, user]);
  const { data: profile } = useDoc(userDocRef);

  const allMethodsQuery = useMemo(() => {
    if (!db) return null;
    return query(collection(db, 'deposit_methods'), where('isActive', '==', true));
  }, [db]);
  const { data: allDepositMethods = [], loading: initialLoading } = useCollection(allMethodsQuery);

  const availableCountries = useMemo(() => {
    const codes = new Set(allDepositMethods.map((m: any) => m.country));
    return COUNTRIES.filter(c => codes.has(c.code));
  }, [allDepositMethods]);

  useEffect(() => {
    if (profile?.country && !selectedCountry && availableCountries.some(c => c.code === profile.country)) {
      setSelectedCountry(profile.country);
    }
  }, [profile?.country, selectedCountry, availableCountries]);

  const methodsQuery = useMemo(() => {
    if (!db || !selectedCountry) return null;
    return query(collection(db, 'deposit_methods'), where('country', '==', selectedCountry), where('isActive', '==', true));
  }, [db, selectedCountry]);
  
  const { data: methods = [], loading: methodsLoading } = useCollection(methodsQuery);

  const t = {
    header: language === 'ar' ? 'إيداع رصيد' : 'Deposit Assets',
    selectCountry: language === 'ar' ? 'اختر الدولة' : 'Select Country',
    selectMethod: language === 'ar' ? 'اختر وسيلة الإيداع' : 'Select Deposit Gateway',
    noMethods: language === 'ar' ? 'لا تتوفر وسائل إيداع حالياً' : 'No gateways available',
    amountLabel: language === 'ar' ? 'المبلغ المطلوب إيداعه' : 'Amount to Deposit',
    proofLabel: language === 'ar' ? 'صورة إثبات الدفع' : 'Payment Evidence',
    senderLabel: language === 'ar' ? 'اسم المرسل' : 'Sender Name',
    instructions: language === 'ar' ? 'قم بالتحويل للبيانات المذكورة وارفاق صورة الوصل للمراجعة.' : 'Transfer to the credentials above and attach the receipt for review.',
    submitBtn: language === 'ar' ? 'إرسال طلب الإيداع' : 'SUBMIT REQUEST',
    nextBtn: language === 'ar' ? 'استمرار' : 'CONTINUE',
    success: language === 'ar' ? 'تم إرسال طلبك بنجاح' : 'Deposit request submitted!',
    error: language === 'ar' ? 'حدث خطأ ما' : 'An error occurred',
    details: language === 'ar' ? 'بيانات التحويل' : 'Gateway Credentials',
    loadingCountries: language === 'ar' ? 'جاري تحميل الدول المتاحة...' : 'Loading available countries...',
    copied: language === 'ar' ? 'تم النسخ!' : 'Copied!'
  };

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text);
    toast({ title: t.copied });
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => setProofImage(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user || !amount || !profile || !proofImage || !selectedMethod) return;

    setLoading(true);
    try {
      const docRef = await addDoc(collection(db, 'deposits'), {
        userId: user.uid,
        username: profile.username,
        senderName: senderName || profile.username,
        amount: parseFloat(amount),
        method: selectedMethod.name,
        proofUrl: proofImage,
        status: 'pending',
        date: new Date().toISOString()
      });

      await sendTelegramPhoto(proofImage, `
💰 <b>New Deposit Request</b>
━━━━━━━━━━━━━━━━
<b>User:</b> @${profile.username}
<b>ID:</b> <code>${profile.customId}</code>
<b>Amount:</b> $${amount}
<b>Method:</b> ${selectedMethod.name}
<b>Sender:</b> ${senderName || profile.username}
<b>Country:</b> ${selectedCountry}
<b>Date:</b> ${new Date().toLocaleString()}
      `, {
        inline_keyboard: [
          [
            { text: "✅ Approve", callback_data: `app_dep_${docRef.id}` },
            { text: "❌ Reject", callback_data: `rej_dep_${docRef.id}` }
          ]
        ]
      });

      toast({ title: t.success });
      router.push('/dashboard');
    } catch (err: any) {
      toast({ variant: "destructive", title: t.error, description: err.message });
    } finally {
      setLoading(false);
    }
  };

  const renderStep = () => {
    switch (step) {
      case 1:
        return (
          <div className="space-y-6 animate-in fade-in zoom-in-95 duration-300">
            <div className="space-y-2">
              <Label className="text-[10px] uppercase font-bold tracking-widest text-muted-foreground">{t.selectCountry}</Label>
              {initialLoading ? (
                <div className="h-14 flex items-center justify-center glass-card rounded-2xl">
                  <Loader2 className="animate-spin h-4 w-4 text-primary mr-2" />
                  <span className="text-[10px] uppercase font-headline text-muted-foreground">{t.loadingCountries}</span>
                </div>
              ) : (
                <Select value={selectedCountry} onValueChange={(val) => { setSelectedCountry(val); setStep(2); }}>
                  <SelectTrigger className="h-14 bg-card/40 border-white/10 rounded-2xl text-[10px] uppercase tracking-widest font-headline">
                    <SelectValue placeholder="CHOOSE COUNTRY" />
                  </SelectTrigger>
                  <SelectContent className="bg-card border-white/10">
                    {availableCountries.length === 0 ? (
                      <div className="p-4 text-center text-[10px] uppercase text-muted-foreground">{t.noMethods}</div>
                    ) : availableCountries.map(c => (
                      <SelectItem key={c.code} value={c.code} className="text-[10px] uppercase font-headline">
                        {language === 'ar' ? c.ar : c.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              )}
            </div>
            {selectedCountry && (
               <Button onClick={() => setStep(2)} className="w-full h-14 font-headline text-md rounded-xl bg-primary text-background font-black tracking-widest">
                  {t.nextBtn}
               </Button>
            )}
          </div>
        );
      case 2:
        return (
          <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-300">
            <div className="flex justify-between items-center">
              <h2 className="text-[10px] font-headline font-bold uppercase tracking-widest text-muted-foreground">{t.selectMethod}</h2>
              <Badge variant="outline" className="text-[8px] uppercase tracking-widest border-primary/20 text-primary">{selectedCountry}</Badge>
            </div>
            <div className="grid grid-cols-1 gap-4">
              {methodsLoading ? (
                <Loader2 className="animate-spin mx-auto text-primary" />
              ) : methods.length === 0 ? (
                <div className="glass-card p-10 rounded-3xl text-center space-y-4">
                  <Info className="mx-auto text-muted-foreground" size={32} />
                  <p className="text-[10px] font-headline font-bold uppercase text-muted-foreground">{t.noMethods}</p>
                  <Button variant="ghost" className="text-[8px] uppercase font-headline" onClick={() => setStep(1)}>Change Country</Button>
                </div>
              ) : methods.map((m: any) => (
                <button 
                  key={m.id} 
                  onClick={() => { setSelectedMethod(m); setStep(3); }}
                  className="glass-card p-6 rounded-3xl flex items-center justify-between border-white/5 hover:border-primary/40 hover:bg-primary/5 transition-all group"
                >
                  <div className="flex items-center gap-5">
                    <div className="w-12 h-12 rounded-2xl bg-primary/10 flex items-center justify-center text-primary group-hover:scale-110 transition-transform overflow-hidden border border-white/5">
                      {m.iconUrl ? <img src={m.iconUrl} className="w-full h-full object-cover" /> : <Landmark size={24} />}
                    </div>
                    <div className="text-left">
                      <p className="text-xs font-headline font-bold uppercase text-white">{m.name}</p>
                      <div className="flex gap-1 mt-1">
                        <Badge className="text-[6px] bg-primary/10 text-primary border-primary/20">Rate: {m.exchangeRate} {m.currencyCode}</Badge>
                      </div>
                    </div>
                  </div>
                  <div className="p-2 rounded-full bg-white/5 group-hover:bg-primary transition-all">
                    <Check size={14} className="group-hover:text-background" />
                  </div>
                </button>
              ))}
            </div>
          </div>
        );
      case 3:
        return (
          <div className="glass-card p-8 rounded-3xl space-y-8 border-white/5 gold-glow animate-in slide-in-from-right-4 duration-300">
            <div className="space-y-4">
              <div className="flex justify-between items-center">
                <div className="flex items-center gap-3">
                  {selectedMethod.iconUrl && <div className="w-8 h-8 rounded-lg overflow-hidden border border-white/10"><img src={selectedMethod.iconUrl} className="w-full h-full object-cover" /></div>}
                  <span className="text-[9px] font-headline font-bold uppercase tracking-widest text-primary">{selectedMethod.name}</span>
                </div>
                <span className="text-[8px] text-muted-foreground uppercase">{t.details}</span>
              </div>
              
              <div className="space-y-3">
                {selectedMethod.fields?.map((field: any, idx: number) => (
                  <div key={idx} className="p-4 bg-background/50 rounded-2xl border border-white/5 flex items-center justify-between group">
                    <div className="min-w-0 flex-1">
                      <p className="text-[7px] text-muted-foreground uppercase font-black tracking-widest mb-1">{field.label}</p>
                      <p className="text-sm font-headline font-bold text-white break-all">{field.value}</p>
                    </div>
                    <button 
                      onClick={() => copyToClipboard(field.value)}
                      className="p-2 bg-white/5 rounded-xl text-primary hover:bg-primary hover:text-background transition-all"
                    >
                      <Copy size={14} />
                    </button>
                  </div>
                ))}
              </div>
            </div>

            <div className="space-y-4">
              <Label className="text-[10px] tracking-[0.2em] font-headline uppercase block">{t.amountLabel}</Label>
              <Input 
                type="number" 
                placeholder="0.00" 
                className="text-2xl font-headline font-bold h-16 text-center bg-background/50 border-white/10 rounded-xl text-primary focus:border-primary/50"
                value={amount}
                onChange={(e) => setAmount(e.target.value)}
              />
              <div className="p-4 bg-white/5 rounded-2xl border border-white/5 flex justify-between items-center">
                <span className="text-[8px] text-muted-foreground uppercase">Estimated Local Value:</span>
                <span className="text-sm font-headline font-black text-white">
                  {Math.round(parseFloat(amount || '0') * (selectedMethod.exchangeRate || 1)).toLocaleString()} {selectedMethod.currencyCode}
                </span>
              </div>
              <Button 
                onClick={() => setStep(4)} 
                disabled={!amount}
                className="w-full h-14 text-md font-headline rounded-xl gold-glow bg-primary hover:bg-primary/90 text-background font-black tracking-widest"
              >
                {t.nextBtn}
              </Button>
            </div>
          </div>
        );
      case 4:
        return (
          <form onSubmit={handleSubmit} className="glass-card p-8 rounded-3xl space-y-8 border-white/5 gold-glow animate-in slide-in-from-right-4 duration-300">
            <div className="space-y-4">
              <Label className="text-[10px] tracking-[0.2em] font-headline uppercase block">{t.senderLabel}</Label>
              <div className="relative group">
                <UserIcon className={cn("absolute top-1/2 -translate-y-1/2 h-4 w-4 text-white/20 group-focus-within:text-primary transition-colors", language === 'ar' ? "right-3" : "left-3")} />
                <Input 
                  placeholder="NAME ON ACCOUNT" 
                  className={cn("h-12 bg-background/50 border-white/10 rounded-xl text-[10px] font-headline uppercase", language === 'ar' ? "pr-10" : "pl-10")}
                  value={senderName}
                  onChange={(e) => setSenderName(e.target.value)}
                  required
                />
              </div>
            </div>

            <div className="space-y-4">
              <Label className="text-[10px] tracking-[0.2em] font-headline uppercase block">{t.proofLabel}</Label>
              <div 
                onClick={() => fileInputRef.current?.click()}
                className="w-full h-44 border-2 border-dashed border-white/10 rounded-2xl flex flex-col items-center justify-center gap-3 cursor-pointer hover:border-primary/50 hover:bg-primary/5 transition-all group relative overflow-hidden"
              >
                {proofImage ? (
                  <img src={proofImage} alt="Proof" className="w-full h-full object-cover" />
                ) : (
                  <>
                    <Camera className="text-white/20 group-hover:text-primary transition-colors" size={32} />
                    <span className="text-[8px] font-headline font-bold uppercase text-white/20">Upload Receipt</span>
                  </>
                )}
                <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileChange} />
              </div>
            </div>

            <div className="p-4 bg-white/5 rounded-2xl border border-white/5 flex gap-3 items-start">
              <Info className="h-4 w-4 text-primary shrink-0 mt-0.5" />
              <p className="text-[9px] text-muted-foreground leading-relaxed font-bold uppercase tracking-tight">{t.instructions}</p>
            </div>

            <Button 
              type="submit" 
              disabled={loading || !proofImage || !senderName}
              className="w-full h-14 text-md font-headline rounded-xl gold-glow bg-primary hover:bg-primary/90 text-background font-black tracking-widest"
            >
              {loading ? <Loader2 className="animate-spin" /> : t.submitBtn}
            </Button>
          </form>
        );
      default:
        return null;
    }
  };

  return (
    <div className="max-w-lg mx-auto p-6 space-y-8 animate-in fade-in duration-500 pb-32">
      <header className="flex items-center gap-4">
        <button onClick={() => step === 1 ? router.back() : setStep(step - 1)} className="p-2 glass-card rounded-xl hover:text-primary transition-colors">
          <ChevronLeft className={cn("h-5 w-5", language === 'ar' && "rotate-180")} />
        </button>
        <h1 className="text-lg font-headline font-bold tracking-widest uppercase">{t.header}</h1>
      </header>

      {renderStep()}
    </div>
  );
}


--- START: /src/app/profile/edit/page.tsx ---

"use client"

import { useState, useEffect, useMemo, useRef } from 'react';
import { useRouter } from 'next/navigation';
import { 
  User, 
  Phone, 
  ChevronLeft, 
  Camera, 
  Loader2,
  ChevronDown,
  CheckCircle2,
  ShieldCheck,
  KeyRound,
  Delete,
  Fingerprint,
  Plus,
  UserCircle,
  Mail,
  RefreshCw,
  ExternalLink
} from 'lucide-react';
import { useStore } from '@/app/lib/store';
import { useUser, useFirestore, useDoc, useAuth, useCollection } from '@/firebase';
import { doc, updateDoc, collection, query, where, limit } from 'firebase/firestore';
import { updatePassword, RecaptchaVerifier, signInWithPhoneNumber, ConfirmationResult, sendEmailVerification } from 'firebase/auth';
import { useToast } from '@/hooks/use-toast';
import { cn } from '@/lib/utils';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import Cropper from 'react-easy-crop';
import { getCroppedImg } from '@/lib/crop-image';
import { Slider } from '@/components/ui/slider';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import { Capacitor } from '@capacitor/core';
import { Preferences } from '@capacitor/preferences';
import { NativeBiometric } from 'capacitor-native-biometric';

const AVATARS = [
  "https://picsum.photos/seed/avatar1/200",
  "https://picsum.photos/seed/avatar2/200",
  "https://picsum.photos/seed/avatar3/200",
  "https://picsum.photos/seed/avatar4/200",
  "https://picsum.photos/seed/avatar5/200",
];

const COUNTRIES = [
  { code: 'SA', nameEn: 'Saudi Arabia', nameAr: 'السعودية', flag: '🇸🇦', prefix: '+966' },
  { code: 'EG', nameEn: 'Egypt', nameAr: 'مصر', flag: '🇪🇬', prefix: '+20' },
  { code: 'AE', nameEn: 'UAE', nameAr: 'الإمارات', flag: '🇦🇪', prefix: '+971' },
  { code: 'KW', nameEn: 'Kuwait', nameAr: 'الكويت', flag: '🇰🇼', prefix: '+965' },
  { code: 'QA', nameEn: 'Qatar', nameAr: 'قطر', flag: '🇶🇦', prefix: '+974' },
  { code: 'JO', nameEn: 'Jordan', nameAr: 'الأردن', flag: '🇯🇴', prefix: '+962' },
  { code: 'IQ', nameEn: 'Iraq', nameAr: 'العراق', flag: '🇮🇶', prefix: '+964' },
];

export default function EditProfilePage() {
  const router = useRouter();
  const auth = useAuth();
  const { user } = useUser();
  const db = useFirestore();
  const { toast } = useToast();
  const { language } = useStore();
  const fileInputRef = useRef<HTMLInputElement>(null);
  const otpInputs = useRef<HTMLInputElement[]>([]);
  
  const userDocRef = useMemo(() => user ? doc(db, 'users', user.uid) : null, [db, user]);
  const { data: profile } = useDoc(userDocRef);

  // Profile States
  const [firstName, setFirstName] = useState('');
  const [lastName, setLastName] = useState('');
  const [gender, setGender] = useState<'male' | 'female'>('male');
  const [birthDate, setBirthDate] = useState<Date | undefined>(undefined);
  const [username, setUsername] = useState('');
  const [email, setEmail] = useState('');
  const [phone, setPhone] = useState('');
  const [selectedCountry, setSelectedCountry] = useState(COUNTRIES[0]);
  const [isCountryOpen, setIsCountryOpen] = useState(false);
  const [newPassword, setNewPassword] = useState('');
  const [selectedAvatar, setSelectedAvatar] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);
  const [isAvatarOpen, setIsAvatarOpen] = useState(false);

  // Verification States
  const [isPhoneVerified, setIsPhoneVerified] = useState(false);
  const [isEmailVerified, setIsEmailVerified] = useState(false);
  const [isKycVerified, setIsKycVerified] = useState(false);
  const [sendingEmail, setSendingEmail] = useState(false);

  // PIN States
  const [isPinModalOpen, setIsPinModalOpen] = useState(false);
  const [pinEntry, setPinEntry] = useState('');
  const [submittingPin, setSubmittingPin] = useState(false);

  // Cropper States
  const [imageToCrop, setImageToCrop] = useState<string | null>(null);
  const [crop, setCrop] = useState({ x: 0, y: 0 });
  const [zoom, setZoom] = useState(1);
  const [croppedAreaPixels, setCroppedAreaPixels] = useState<any>(null);
  const [isCropDialogOpen, setIsCropDialogOpen] = useState(false);

  // Phone Verification
  const [isOtpOpen, setIsOtpOpen] = useState(false);
  const [otpCode, setOtpCode] = useState(['', '', '', '', '', '']);
  const [verifyingPhone, setVerifyingPhone] = useState(false);
  const [confirmationResult, setConfirmationResult] = useState<ConfirmationResult | null>(null);

  useEffect(() => {
    if (profile) {
      setFirstName(profile.firstName || '');
      setLastName(profile.lastName || '');
      setGender(profile.gender || 'male');
      if (profile.birthDate) setBirthDate(new Date(profile.birthDate));
      setUsername(profile.username || '');
      setEmail(profile.email || '');
      const fullPhone = profile.phone || '';
      const countryMatch = COUNTRIES.find(c => c.prefix && fullPhone.startsWith(c.prefix));
      if (countryMatch) {
        setSelectedCountry(countryMatch);
        setPhone(fullPhone.replace(countryMatch.prefix, ''));
      } else {
        setPhone(fullPhone);
      }
      setSelectedAvatar(profile.avatarUrl || AVATARS[0]);
      setIsPhoneVerified(profile.phoneVerified || false);
      setIsEmailVerified(profile.emailVerified || false);
      setIsKycVerified(profile.verified || false);
    }
  }, [profile]);

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user || !db) return;
    setLoading(true);
    try {
      const updates: any = {
        firstName: firstName.trim(),
        lastName: lastName.trim(),
        gender,
        birthDate: birthDate?.toISOString(),
        username: username.trim().toLowerCase(),
        avatarUrl: selectedAvatar,
      };
      await updateDoc(doc(db, 'users', user.uid), updates);
      if (newPassword.trim()) {
        await updatePassword(user, newPassword.trim());
      }
      toast({ title: language === 'ar' ? "تم تحديث البيانات" : "Profile updated" });
      router.push('/dashboard');
    } catch (error: any) {
      toast({ variant: "destructive", title: "Error", description: error.message });
    } finally {
      setLoading(false);
    }
  };

  const handleVerifyEmail = async () => {
    if (!user || sendingEmail) return;
    setSendingEmail(true);
    try {
      await sendEmailVerification(user);
      toast({ 
        title: language === 'ar' ? "تم إرسال الرابط" : "Verification Sent", 
        description: language === 'ar' ? "تحقق من صندوق الوارد الخاص بك" : "Check your inbox for the link" 
      });
    } catch (error: any) {
      toast({ variant: "destructive", title: "Error", description: error.message });
    } finally {
      setSendingEmail(false);
    }
  };

  const refreshEmailStatus = async () => {
    if (!user || !db) return;
    setLoading(true);
    try {
      await user.reload();
      if (user.emailVerified) {
        await updateDoc(doc(db, 'users', user.uid), { emailVerified: true });
        setIsEmailVerified(true);
        toast({ title: language === 'ar' ? "تم توثيق البريد بنجاح" : "Email Verified Successfully" });
      } else {
        toast({ variant: "destructive", title: language === 'ar' ? "لم يتم التوثيق بعد" : "Not Verified Yet" });
      }
    } catch (error: any) {
      toast({ variant: "destructive", title: "Error", description: error.message });
    } finally {
      setLoading(false);
    }
  };

  const handleSendOtp = async () => {
    if (!phone || !auth || !db) return;
    setVerifyingPhone(true);
    try {
      const fullPhone = `${selectedCountry.prefix}${phone.trim()}`;
      
      // Prevent Duplicate Phone
      const q = query(collection(db, 'users'), where('phone', '==', fullPhone), limit(1));
      const snap = await getDocs(q);
      if (!snap.empty && snap.docs[0].id !== user?.uid) {
        toast({ variant: "destructive", title: language === 'ar' ? "الرقم مستخدم بالفعل" : "Phone number already in use" });
        return;
      }

      const verifier = new RecaptchaVerifier(auth, 'recaptcha-container', { size: 'invisible' });
      const result = await signInWithPhoneNumber(auth, fullPhone, verifier);
      setConfirmationResult(result);
      setIsOtpOpen(true);
    } catch (error: any) {
      toast({ variant: "destructive", title: "Error", description: error.message });
    } finally {
      setVerifyingPhone(false);
    }
  };

  const handleVerifyOtp = async () => {
    if (!confirmationResult || !user || !db) return;
    setVerifyingPhone(true);
    const code = otpCode.join('');
    try {
      await confirmationResult.confirm(code);
      const fullPhone = `${selectedCountry.prefix}${phone.trim()}`;
      await updateDoc(doc(db, 'users', user.uid), { 
        phoneVerified: true,
        phone: fullPhone
      });
      setIsPhoneVerified(true);
      setIsOtpOpen(false);
      toast({ title: language === 'ar' ? "تم توثيق الهاتف" : "Phone Verified" });
    } catch (error: any) {
      toast({ variant: "destructive", title: "Invalid Code" });
    } finally {
      setVerifyingPhone(false);
    }
  };

  const handleApplyCrop = async () => {
    if (imageToCrop && croppedAreaPixels) {
      const croppedImage = await getCroppedImg(imageToCrop, croppedAreaPixels);
      if (croppedImage) {
        setSelectedAvatar(croppedImage);
        setIsCropDialogOpen(false);
      }
    }
  };

  const VirtualPad = ({ value, onChange, onComplete }: any) => {
    const handleAdd = (num: string) => { if (value.length < 4) onChange(value + num); };
    const handleClear = () => onChange(value.slice(0, -1));
    return (
      <div className="space-y-8" dir="ltr">
        <div className="flex justify-center gap-4">
          {[0, 1, 2, 3].map((i) => (
            <div key={i} className={cn("w-4 h-4 rounded-full border-2 transition-all duration-300", value.length > i ? "bg-primary border-primary scale-125" : "border-white/20")} />
          ))}
        </div>
        <div className="grid grid-cols-3 gap-4">
          {[1, 2, 3, 4, 5, 6, 7, 8, 9].map((n) => (
            <button key={n} type="button" onClick={() => handleAdd(n.toString())} className="h-16 rounded-2xl bg-white/5 border border-white/10 text-xl font-headline font-bold hover:bg-primary hover:text-background transition-all">{n}</button>
          ))}
          <button type="button" onClick={handleClear} className="h-16 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center hover:bg-red-500 transition-all"><Delete size={24} /></button>
          <button type="button" onClick={() => handleAdd('0')} className="h-16 rounded-2xl bg-white/5 border border-white/10 text-xl font-headline font-bold hover:bg-primary hover:text-background transition-all">0</button>
          <button type="button" disabled={value.length !== 4} onClick={onComplete} className="h-16 rounded-2xl bg-primary/20 border border-primary/40 flex items-center justify-center text-primary disabled:opacity-20 hover:bg-primary hover:text-background transition-all"><Check size={24} /></button>
        </div>
      </div>
    );
  };

  return (
    <div className="max-w-lg mx-auto p-6 space-y-8 animate-in fade-in duration-500 pb-32" onClick={() => setIsCountryOpen(false)}>
      <header className="flex items-center gap-4">
        <button onClick={() => router.back()} className="p-2 glass-card rounded-xl hover:text-primary transition-colors">
          <ChevronLeft className={cn("h-5 w-5", language === 'ar' && "rotate-180")} />
        </button>
        <h1 className="text-lg font-headline font-bold tracking-widest uppercase">{language === 'ar' ? 'تعديل الحساب' : 'Edit Profile'}</h1>
      </header>

      <div id="recaptcha-container"></div>

      {/* Verification Summary Section */}
      <div className="grid grid-cols-3 gap-2">
        <div className={cn("p-3 rounded-2xl border text-center space-y-1 transition-all", isKycVerified ? "bg-green-500/10 border-green-500/20 text-green-500" : "bg-red-500/10 border-red-500/20 text-red-500")}>
          <ShieldCheck size={16} className="mx-auto" />
          <p className="text-[7px] font-headline font-bold uppercase">{language === 'ar' ? 'الهوية' : 'Identity'}</p>
        </div>
        <div className={cn("p-3 rounded-2xl border text-center space-y-1 transition-all", isEmailVerified ? "bg-primary/10 border-primary/20 text-primary" : "bg-white/5 border-white/10 text-white/30")}>
          <Mail size={16} className="mx-auto" />
          <p className="text-[7px] font-headline font-bold uppercase">{language === 'ar' ? 'البريد' : 'Email'}</p>
        </div>
        <div className={cn("p-3 rounded-2xl border text-center space-y-1 transition-all", isPhoneVerified ? "bg-blue-500/10 border-blue-500/20 text-blue-500" : "bg-white/5 border-white/10 text-white/30")}>
          <Phone size={16} className="mx-auto" />
          <p className="text-[7px] font-headline font-bold uppercase">{language === 'ar' ? 'الهاتف' : 'Phone'}</p>
        </div>
      </div>

      <div className="flex flex-col items-center gap-4 py-6">
        <div className="relative group">
          <div className={cn("w-32 h-32 rounded-full overflow-hidden border-4 transition-all duration-500 bg-white/5 flex items-center justify-center", profile?.verified ? "border-green-500 shadow-xl" : "border-red-500 shadow-xl")}>
            {selectedAvatar ? <img src={selectedAvatar} alt="Profile" className="w-full h-full object-cover" /> : <User size={48} className="text-white/20" />}
          </div>
          <button type="button" onClick={() => fileInputRef.current?.click()} className="absolute bottom-0 right-0 p-2 bg-primary text-primary-foreground rounded-full shadow-lg hover:scale-110 transition-transform"><Camera size={18} /></button>
          <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={(e) => {
            const file = e.target.files?.[0];
            if (file) {
              const reader = new FileReader();
              reader.onloadend = () => { setImageToCrop(reader.result as string); setIsCropDialogOpen(true); };
              reader.readAsDataURL(file);
            }
          }} />
        </div>
        <button onClick={() => setIsAvatarOpen(!isAvatarOpen)} className="text-[8px] font-headline font-bold uppercase text-primary/60 hover:text-primary">Change Avatar</button>
        {isAvatarOpen && (
          <div className="flex flex-wrap justify-center gap-3 p-4 glass-card rounded-2xl">
            {AVATARS.map((url, i) => (
              <button key={i} onClick={() => { setSelectedAvatar(url); setIsAvatarOpen(false); }} className={cn("w-12 h-12 rounded-full overflow-hidden border-2", selectedAvatar === url ? "border-primary" : "border-transparent opacity-50")}><img src={url} className="w-full h-full object-cover" /></button>
            ))}
          </div>
        )}
      </div>

      <form onSubmit={handleSave} className="glass-card p-6 rounded-3xl space-y-6 border-white/5">
        <div className="grid grid-cols-2 gap-4">
          <div className="space-y-2">
            <Label className="text-[10px] uppercase text-white/40">First Name</Label>
            <Input value={firstName} onChange={(e) => setFirstName(e.target.value)} className="h-12 bg-white/5 border-white/10" />
          </div>
          <div className="space-y-2">
            <Label className="text-[10px] uppercase text-white/40">Last Name</Label>
            <Input value={lastName} onChange={(e) => setLastName(e.target.value)} className="h-12 bg-white/5 border-white/10" />
          </div>
        </div>

        <div className="space-y-2">
          <Label className="text-[10px] uppercase text-white/40">Gender</Label>
          <RadioGroup value={gender} onValueChange={(v: any) => setGender(v)} className="flex gap-4">
            <div className={cn("flex-1 h-12 rounded-xl border flex items-center justify-center font-headline text-[10px] uppercase cursor-pointer", gender === 'male' ? "bg-primary/10 border-primary text-primary" : "bg-white/5 border-white/10 text-white/40")}>
              <RadioGroupItem value="male" id="male-edit" className="sr-only" />
              <Label htmlFor="male-edit" className="cursor-pointer">Male</Label>
            </div>
            <div className={cn("flex-1 h-12 rounded-xl border flex items-center justify-center font-headline text-[10px] uppercase cursor-pointer", gender === 'female' ? "bg-pink-500/10 border-pink-500 text-pink-500" : "bg-white/5 border-white/10 text-white/40")}>
              <RadioGroupItem value="female" id="female-edit" className="sr-only" />
              <Label htmlFor="female-edit" className="cursor-pointer">Female</Label>
            </div>
          </RadioGroup>
        </div>

        <div className="space-y-2">
          <Label className="text-[10px] uppercase text-white/40">Birth Date</Label>
          <Input 
            type="date"
            value={birthDate ? birthDate.toISOString().split('T')[0] : ''}
            onChange={(e) => setBirthDate(e.target.value ? new Date(e.target.value) : undefined)}
            className="h-12 bg-white/5 border-white/10 text-white focus:border-primary/50"
            style={{ colorScheme: 'dark' }}
          />
        </div>

        <div className="space-y-2">
          <Label className="text-[10px] uppercase text-white/40">Username</Label>
          <div className="relative">
            <UserCircle className={cn("absolute top-1/2 -translate-y-1/2 text-white/20", language === 'ar' ? 'right-3' : 'left-3')} size={18} />
            <Input value={username} onChange={(e) => setUsername(e.target.value.toLowerCase())} className={cn("h-12 bg-white/5 border-white/10", language === 'ar' ? 'pr-10' : 'pl-10')} />
          </div>
        </div>

        <Button type="submit" disabled={loading} className="w-full h-14 bg-primary text-background font-headline font-black tracking-widest rounded-xl gold-glow">
          {loading ? <Loader2 className="animate-spin" /> : "Save Profile"}
        </Button>
      </form>

      {/* Email Verification Section */}
      <div className="glass-card p-6 rounded-3xl space-y-6 border-white/5">
        <h2 className="text-[10px] font-headline font-bold uppercase tracking-widest text-primary flex items-center gap-2"><Mail size={14} /> Email Authority</h2>
        <div className="space-y-4">
          <div className="relative">
            <Mail className="absolute top-1/2 -translate-y-1/2 left-3 h-4 w-4 text-white/20" />
            <Input value={email} disabled className="h-12 bg-white/5 border-white/10 pl-10 opacity-60" />
          </div>
          {!isEmailVerified ? (
            <div className="grid grid-cols-2 gap-3">
              <Button type="button" onClick={handleVerifyEmail} disabled={sendingEmail} className="h-12 bg-primary/10 border border-primary/20 text-primary text-[9px] font-headline uppercase tracking-widest">
                {sendingEmail ? <Loader2 className="animate-spin" size={14} /> : "Send Link"}
              </Button>
              <Button type="button" onClick={refreshEmailStatus} className="h-12 bg-white/5 border border-white/10 text-white text-[9px] font-headline uppercase tracking-widest flex items-center gap-2">
                <RefreshCw size={12} /> Sync Status
              </Button>
            </div>
          ) : (
            <div className="h-12 flex items-center justify-center gap-2 text-primary font-headline font-bold text-[10px] uppercase px-3 bg-primary/10 rounded-xl border border-primary/20 w-full">
              <CheckCircle2 size={14} /> Email Verified
            </div>
          )}
        </div>
      </div>

      {/* Phone Verification Section */}
      <div className="glass-card p-6 rounded-3xl space-y-6 border-white/5">
        <h2 className="text-[10px] font-headline font-bold uppercase tracking-widest text-blue-400 flex items-center gap-2"><Phone size={14} /> Phone Identity</h2>
        <div className="space-y-4">
          <div className="flex gap-2" dir="ltr">
            <button type="button" onClick={(e) => { e.stopPropagation(); setIsCountryOpen(!isCountryOpen); }} className="h-12 bg-white/5 border border-white/10 rounded-xl px-3 flex items-center gap-2">
              <span className="text-xs">{selectedCountry.flag}</span>
              <ChevronDown size={14} className={cn(isCountryOpen && "rotate-180")} />
            </button>
            <div className="relative flex-1">
              <Phone className="absolute top-1/2 -translate-y-1/2 left-3 h-4 w-4 text-white/20" />
              <Input type="tel" dir="ltr" value={phone} onChange={(e) => { setPhone(e.target.value); setIsPhoneVerified(false); }} className="h-12 bg-white/5 border-white/10 pl-10" />
            </div>
          </div>
          {isCountryOpen && (
            <div className="absolute z-[110] bg-[#1a1a1a] border border-white/10 rounded-xl shadow-2xl overflow-y-auto max-h-48 w-48">
              {COUNTRIES.map(c => (
                <button key={c.code} type="button" onClick={() => { setSelectedCountry(c); setIsCountryOpen(false); }} className="w-full flex items-center justify-between p-3 hover:bg-white/5 border-b border-white/5 last:border-0"><span className="text-xs">{language === 'ar' ? c.nameAr : c.nameEn}</span><span className="text-xs text-white/40">{c.prefix}</span></button>
              ))}
            </div>
          )}
          {!isPhoneVerified ? (
            <Button type="button" onClick={handleSendOtp} disabled={verifyingPhone || !phone} className="w-full h-12 bg-secondary/10 border border-secondary/20 text-secondary text-[10px] font-headline uppercase tracking-widest">
              {verifyingPhone ? <Loader2 className="animate-spin" size={14} /> : "Verify Number"}
            </Button>
          ) : (
            <div className="h-12 flex items-center justify-center gap-2 text-blue-500 font-headline font-bold text-[10px] uppercase px-3 bg-blue-500/10 rounded-xl border border-blue-500/20 w-full">
              <CheckCircle2 size={14} /> Phone Verified
            </div>
          )}
        </div>
      </div>

      <div className="glass-card p-6 rounded-3xl space-y-6 border-white/5 shadow-2xl gold-glow">
        <h2 className="text-[10px] font-headline font-bold uppercase tracking-widest text-primary flex items-center gap-2"><KeyRound size={14} /> Security PIN</h2>
        <div className="flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/10">
          <div><p className="text-[10px] font-headline font-bold uppercase">{profile?.pin ? "Vault Locked" : "Set PIN"}</p></div>
          {!profile?.pin ? (
            <button onClick={() => setIsPinModalOpen(true)} className="p-3 bg-primary/10 text-primary rounded-xl hover:bg-primary"><Plus size={20} /></button>
          ) : (
            <div className="p-3 bg-green-500/10 text-green-500 rounded-xl"><ShieldCheck size={20} /></div>
          )}
        </div>
      </div>

      <Dialog open={isPinModalOpen} onOpenChange={setIsPinModalOpen}>
        <DialogContent className="max-w-sm glass-card border-white/10 p-10 text-center rounded-[2.5rem] z-[2000]">
          <DialogHeader><DialogTitle className="text-xs font-headline font-bold tracking-widest uppercase text-primary flex items-center justify-center gap-2"><Fingerprint size={16} /> Authorize PIN</DialogTitle></DialogHeader>
          <div className="mt-8">
            <VirtualPad value={pinEntry} onChange={setPinEntry} onComplete={async () => {
              if (pinEntry.length === 4 && user && db) {
                setSubmittingPin(true);
                await updateDoc(doc(db, 'users', user.uid), { pin: pinEntry });
                setSubmittingPin(false);
                setIsPinModalOpen(false);
                toast({ title: "PIN Saved" });
              }
            }} />
            {submittingPin && <div className="mt-4 flex justify-center"><Loader2 className="animate-spin text-primary" /></div>}
          </div>
        </DialogContent>
      </Dialog>

      <Dialog open={isCropDialogOpen} onOpenChange={setIsCropDialogOpen}>
        <DialogContent className="max-w-md glass-card border-white/10 p-0 rounded-[2rem] z-[2001] overflow-hidden">
          <DialogHeader className="p-6 border-b border-white/5"><DialogTitle className="text-xs font-headline font-bold uppercase">Crop Avatar</DialogTitle></DialogHeader>
          <div className="relative w-full aspect-square">
            {imageToCrop && <Cropper image={imageToCrop} crop={crop} zoom={zoom} aspect={1} cropShape="round" onCropChange={setCrop} onZoomChange={setZoom} onCropComplete={(_, p) => setCroppedAreaPixels(p)} />}
          </div>
          <div className="p-6 space-y-6">
            <Slider value={[zoom]} min={1} max={3} step={0.1} onValueChange={(v) => setZoom(v[0])} />
            <div className="flex gap-3">
              <Button variant="outline" onClick={() => setIsCropDialogOpen(false)} className="flex-1">Cancel</Button>
              <Button onClick={handleApplyCrop} className="flex-1 bg-primary text-background font-bold uppercase text-[10px]">Apply</Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      <Dialog open={isOtpOpen} onOpenChange={setIsOtpOpen}>
        <DialogContent className="max-w-sm glass-card border-white/10 p-8 text-center rounded-[2.5rem] z-[2000]">
          <DialogHeader><DialogTitle className="text-xs font-headline font-bold tracking-widest uppercase text-secondary">Verification Code</DialogTitle></DialogHeader>
          <div className="space-y-6 mt-4">
            <div className="flex gap-2 justify-center" dir="ltr">
              {otpCode.map((digit, i) => (
                <input key={i} ref={el => { if(el) otpInputs.current[i] = el; }} type="text" maxLength={1} value={digit} onChange={(e) => {
                  const val = e.target.value;
                  const newOtp = [...otpCode];
                  newOtp[i] = val;
                  setOtpCode(newOtp);
                  if (val && i < 5) otpInputs.current[i+1]?.focus();
                }} className="w-10 h-14 bg-white/5 border border-white/10 text-center text-xl font-bold text-secondary outline-none rounded-lg" />
              ))}
            </div>
            <div className="flex flex-col gap-3">
              <Button onClick={handleVerifyOtp} disabled={verifyingPhone || otpCode.join('').length < 6} className="w-full h-14 bg-secondary text-background font-headline font-bold text-[10px] uppercase tracking-widest cyan-glow">
                {verifyingPhone ? <Loader2 className="animate-spin" /> : "Validate"}
              </Button>
              <Button variant="ghost" onClick={handleSendOtp} className="text-[8px] font-headline uppercase text-muted-foreground">Resend Code</Button>
              <Button variant="ghost" onClick={() => setIsOtpOpen(false)} className="text-[8px] font-headline uppercase text-red-500">Cancel</Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}


--- START: /src/app/otp/page.tsx ---
"use client"

import { useState, useEffect, useRef } from 'react';
import { useRouter } from 'next/navigation';
import { Shield, Loader2, ArrowLeft } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { Button } from '@/components/ui/button';
import { useStore } from '@/app/lib/store';

export default function OTPPage() {
  const router = useRouter();
  const { language } = useStore();
  const { toast } = useToast();
  const [otp, setOtp] = useState(['', '', '', '', '', '']);
  const [loading, setLoading] = useState(false);
  const inputs = useRef<HTMLInputElement[]>([]);

  const handleChange = (index: number, value: string) => {
    if (!/^\d*$/.test(value)) return;
    if (value.length > 1) value = value[value.length - 1];
    const newOtp = [...otp];
    newOtp[index] = value;
    setOtp(newOtp);

    if (value && index < 5) inputs.current[index + 1]?.focus();
  };

  const handleKeyDown = (index: number, e: React.KeyboardEvent) => {
    if (e.key === 'Backspace' && !otp[index] && index > 0) {
      inputs.current[index - 1]?.focus();
    }
  };

  const handleVerify = async () => {
    setLoading(true);
    setTimeout(() => {
      setLoading(false);
      router.push('/dashboard');
    }, 2000);
  };

  return (
    <div className="min-h-screen bg-background flex flex-col p-12">
      <header>
        <button onClick={() => router.back()} className="text-muted-foreground hover:text-white transition-all">
          <ArrowLeft size={24} />
        </button>
      </header>

      <main className="flex-1 flex flex-col items-center justify-center space-y-16 max-w-sm mx-auto w-full">
        <div className="w-20 h-20 bg-card border border-border flex items-center justify-center text-primary">
          <Shield size={40} strokeWidth={1.5} />
        </div>

        <div className="text-center space-y-4">
          <h1 className="text-3xl font-headline font-bold text-white tracking-tight uppercase">SECURE VERIFICATION</h1>
          <p className="text-[10px] text-muted-foreground uppercase tracking-[0.3em] font-bold">Input the 6-digit cryptographic sequence</p>
        </div>

        <div className="flex gap-3" dir="ltr">
          {otp.map((digit, i) => (
            <input
              key={i}
              ref={el => { if(el) inputs.current[i] = el; }}
              type="text"
              inputMode="numeric"
              value={digit}
              onChange={(e) => handleChange(i, e.target.value)}
              onKeyDown={(e) => handleKeyDown(i, e)}
              className="w-12 h-16 bg-card border border-border text-center text-xl font-headline font-bold text-primary focus:border-primary transition-all outline-none"
            />
          ))}
        </div>

        <Button 
          onClick={handleVerify} 
          disabled={loading || otp.join('').length < 6}
          className="w-full h-14 bg-primary text-primary-foreground font-headline font-bold text-xs tracking-[0.2em] rounded-none"
        >
          {loading ? <Loader2 className="animate-spin" /> : "VALIDATE ACCESS"}
        </Button>
      </main>
    </div>
  );
}

--- START: /src/app/onboarding/page.tsx ---
"use client"

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Shield, Zap, Globe, ArrowRight } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { cn } from '@/lib/utils';
import { useStore } from '@/app/lib/store';

const STEPS = [
  {
    title: "AUTHORITY",
    titleAr: "السلطة المالية",
    desc: "Licensed digital financial infrastructure with multi-layer encryption protocols.",
    descAr: "بنية تحتية مالية رقمية مرخصة مع بروتوكولات تشفير متعددة الطبقات.",
    icon: Shield,
  },
  {
    title: "PRECISION",
    titleAr: "الدقة",
    desc: "Instantaneous global settlements via the proprietary Flash network.",
    descAr: "تسويات عالمية فورية عبر شبكة فلاش الخاصة.",
    icon: Zap,
  },
  {
    title: "ECOSYSTEM",
    titleAr: "النظام الشامل",
    desc: "Unified access to global financial services and digital assets.",
    descAr: "وصول موحد للخدمات المالية العالمية والأصول الرقمية.",
    icon: Globe,
  }
];

export default function OnboardingPage() {
  const router = useRouter();
  const { language } = useStore();
  const [currentStep, setCurrentStep] = useState(0);

  const handleNext = () => {
    if (currentStep < STEPS.length - 1) {
      setCurrentStep(currentStep + 1);
    } else {
      localStorage.setItem('flash_onboarded', 'true');
      router.push('/');
    }
  };

  const step = STEPS[currentStep];

  return (
    <div className="min-h-screen bg-background flex flex-col p-12">
      <header className="flex justify-between items-center">
        <div className="font-headline font-bold text-lg text-white tracking-tighter">FLASH</div>
        <button onClick={() => { localStorage.setItem('flash_onboarded', 'true'); router.push('/'); }} className="text-[9px] font-bold text-muted-foreground uppercase tracking-widest hover:text-primary transition-colors">
          {language === 'ar' ? 'تخطي' : 'Skip'}
        </button>
      </header>

      <main className="flex-1 flex flex-col items-center justify-center text-center space-y-16 max-w-xs mx-auto">
        <div className="w-24 h-24 bg-card border border-border flex items-center justify-center text-primary">
          <step.icon size={48} strokeWidth={1.5} />
        </div>

        <div className="space-y-6">
          <h2 className="text-4xl font-headline font-bold text-white tracking-tight leading-none">
            {language === 'ar' ? step.titleAr : step.title}
          </h2>
          <p className="text-sm text-muted-foreground leading-relaxed">
            {language === 'ar' ? step.descAr : step.desc}
          </p>
        </div>
      </main>

      <footer className="space-y-12 pb-8 max-w-xs mx-auto w-full">
        <div className="flex justify-center gap-3">
          {STEPS.map((_, i) => (
            <div key={i} className={cn("h-1 rounded-full transition-all duration-700", i === currentStep ? "w-10 bg-primary" : "w-3 bg-muted")} />
          ))}
        </div>

        <Button 
          onClick={handleNext} 
          className="w-full h-14 bg-primary text-primary-foreground font-headline font-bold text-xs tracking-[0.2em] flex items-center justify-between px-8"
        >
          <span>{currentStep === STEPS.length - 1 ? (language === 'ar' ? 'البدء' : 'ENTER VAULT') : (language === 'ar' ? 'استمرار' : 'CONTINUE')}</span>
          <ArrowRight size={16} className={cn(language === 'ar' && "rotate-180")} />
        </Button>
      </footer>
    </div>
  );
}

--- START: /src/app/marketplace/page.tsx ---
"use client"

import { useState, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';
import { 
  Search, 
  ChevronLeft, 
  Gamepad2, 
  Gift, 
  Users, 
  ShoppingBag, 
  Loader2, 
  CheckCircle2, 
  AlertCircle,
  Keyboard,
  Coins,
  ArrowRight,
  X,
  ShieldCheck,
  Filter,
  Fingerprint,
  Delete,
  Check
} from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { cn } from '@/lib/utils';
import { useUser, useFirestore, useDoc, useCollection } from '@/firebase';
import { doc, collection, increment, runTransaction, addDoc, query, where } from 'firebase/firestore';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from '@/components/ui/dialog';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { sendTelegramNotification } from '@/lib/telegram';

const CATEGORY_ICONS: Record<string, any> = {
  GAMES: Gamepad2,
  CARDS: Gift,
  SOFTWARE: ShoppingBag,
  SOCIAL: Users,
};

export default function MarketplacePage() {
  const router = useRouter();
  const { user } = useUser();
  const db = useFirestore();
  const { toast } = useToast();
  const [search, setSearch] = useState('');
  const [selectedCategory, setSelectedCategory] = useState('ALL');
  
  // Checkout Modal State
  const [selectedService, setSelectedService] = useState<any>(null);
  const [selectedVariantIdx, setSelectedVariantIdx] = useState<string>("");
  const [userInput, setUserInput] = useState("");
  const [isConfirming, setIsConfirming] = useState(false);
  const [isPinVerificationOpen, setIsPinVerificationOpen] = useState(false);
  const [isBuying, setIsSending] = useState(false);
  const [pinEntry, setPinEntry] = useState('');

  const userDocRef = useMemo(() => user ? doc(db, 'users', user.uid) : null, [db, user]);
  const { data: profile } = useDoc(userDocRef);

  // Filter only ACTIVE services
  const servicesQuery = useMemo(() => query(collection(db, 'marketplace_services'), where('isActive', '==', true)), [db]);
  const { data: services = [], loading: servicesLoading } = useCollection(servicesQuery);

  const categories = useMemo(() => {
    const cats = new Set(services.map((s: any) => s.category?.toUpperCase() || 'UNCATEGORIZED'));
    return Array.from(cats).sort();
  }, [services]);

  const filtered = useMemo(() => {
    return services.filter((s: any) => {
      const matchesSearch = s.name?.toLowerCase().includes(search.toLowerCase());
      const matchesCategory = selectedCategory === 'ALL' || (s.category?.toUpperCase() || 'UNCATEGORIZED') === selectedCategory;
      return matchesSearch && matchesCategory;
    });
  }, [services, search, selectedCategory]);

  const handleOpenBuyModal = (service: any) => {
    setSelectedService(service);
    setSelectedVariantIdx("");
    setUserInput("");
    setIsConfirming(false);
  };

  const handleInitiatePurchase = () => {
    if (!selectedService) return;

    if (!profile?.pin) {
      toast({ variant: "destructive", title: "PIN REQUIRED", description: "Please setup your security PIN in profile settings first." });
      router.push('/profile/edit');
      return;
    }

    if (selectedService.type === 'variable' && selectedVariantIdx === "") {
      toast({ variant: "destructive", title: "SELECT OPTION", description: "Please select a package first." });
      return;
    }

    if (selectedService.requiresInput && !userInput.trim()) {
      toast({ variant: "destructive", title: "DATA REQUIRED", description: `Please provide the ${selectedService.inputLabel}.` });
      return;
    }

    let price = selectedService.price;
    if (selectedService.type === 'variable') {
      price = selectedService.variants[parseInt(selectedVariantIdx)].price;
    }

    if (profile.balance < price) {
      toast({ variant: "destructive", title: "INSUFFICIENT BALANCE", description: "Add funds to complete this purchase." });
      return;
    }

    setIsConfirming(true);
  };

  const handlePinAuth = () => {
    setIsConfirming(false);
    setPinEntry('');
    setIsPinVerificationOpen(true);
  };

  const handleConfirmPurchase = async () => {
    if (pinEntry !== profile?.pin) {
      toast({ variant: "destructive", title: "INCORRECT PIN" });
      setPinEntry('');
      return;
    }

    if (!user || !profile || !selectedService) return;

    let finalPrice = selectedService.price;
    let variantLabel = "";

    if (selectedService.type === 'variable') {
      const variant = selectedService.variants[parseInt(selectedVariantIdx)];
      finalPrice = variant.price;
      variantLabel = variant.label;
    }

    setIsSending(true);
    try {
      await runTransaction(db, async (transaction) => {
        const userRef = doc(db, 'users', user.uid);
        transaction.update(userRef, { balance: increment(-finalPrice) });
        
        // Add to user transactions
        const txRef = doc(collection(db, 'users', user.uid, 'transactions'));
        transaction.set(txRef, {
          type: 'purchase',
          amount: finalPrice,
          service: selectedService.name + (variantLabel ? ` (${variantLabel})` : ''),
          status: 'completed',
          date: new Date().toISOString()
        });

        // Add to global service requests for admin
        const requestRef = doc(collection(db, 'service_requests'));
        transaction.set(requestRef, {
          userId: user.uid,
          username: profile.username,
          serviceName: selectedService.name,
          selectedVariant: variantLabel,
          userInput: userInput.trim(),
          price: finalPrice,
          status: 'pending',
          date: new Date().toISOString()
        });
      });

      // Send Telegram Notification to Admin
      const telegramMessage = `
🛒 <b>New Marketplace Order</b>
━━━━━━━━━━━━━━━━
<b>User:</b> @${profile.username}
<b>Service:</b> ${selectedService.name}
${variantLabel ? `<b>Package:</b> ${variantLabel}` : ''}
${userInput ? `<b>User Data:</b> <code>${userInput}</code>` : ''}
<b>Price:</b> $${finalPrice}
<b>Date:</b> ${new Date().toLocaleString()}
      `;
      await sendTelegramNotification(telegramMessage);

      toast({ title: "PURCHASE SUCCESSFUL", description: `Your order has been logged for processing.` });
      setSelectedService(null);
      setIsPinVerificationOpen(false);
      router.push('/dashboard');
    } catch (e: any) {
      toast({ variant: "destructive", title: "PURCHASE FAILED", description: e.message });
    } finally {
      setIsSending(false);
    }
  };

  const VirtualPad = ({ value, onChange, onComplete }: any) => {
    const handleAdd = (num: string) => { if (value.length < 4) onChange(value + num); };
    const handleClear = () => onChange(value.slice(0, -1));
    return (
      <div className="space-y-8" dir="ltr">
        <div className="flex justify-center gap-4">
          {[0, 1, 2, 3].map((i) => (
            <div key={i} className={cn("w-4 h-4 rounded-full border-2 transition-all duration-300", value.length > i ? "bg-primary border-primary scale-125" : "border-white/20")} />
          ))}
        </div>
        <div className="grid grid-cols-3 gap-4">
          {[1, 2, 3, 4, 5, 6, 7, 8, 9].map((n) => (
            <button key={n} type="button" onClick={() => handleAdd(n.toString())} className="h-16 rounded-2xl bg-white/5 border border-white/10 text-xl font-headline font-bold hover:bg-primary hover:text-background transition-all">{n}</button>
          ))}
          <button type="button" onClick={handleClear} className="h-16 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center hover:bg-red-500 transition-all"><Delete size={24} /></button>
          <button type="button" onClick={() => handleAdd('0')} className="h-16 rounded-2xl bg-white/5 border border-white/10 text-xl font-headline font-bold hover:bg-primary hover:text-background transition-all">0</button>
          <button type="button" disabled={value.length !== 4} onClick={onComplete} className="h-16 rounded-2xl bg-primary/20 border border-primary/40 flex items-center justify-center text-primary disabled:opacity-20 hover:bg-primary hover:text-background transition-all"><Check size={24} /></button>
        </div>
      </div>
    );
  };

  return (
    <div className="max-w-lg mx-auto p-6 space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500 pb-32">
      <header className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <button onClick={() => router.back()} className="p-2 glass-card rounded-xl"><ChevronLeft className="h-5 w-5" /></button>
          <h1 className="text-lg font-headline font-bold tracking-widest uppercase">Global Store</h1>
        </div>
        <div className="text-right">
          <p className="text-[8px] text-muted-foreground font-black tracking-widest uppercase">Vault Asset</p>
          <p className="text-sm font-headline font-black text-primary">${profile?.balance?.toLocaleString() || '0'}</p>
        </div>
      </header>

      <div className="space-y-4">
        <div className="relative group">
          <Search className="absolute left-4 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground group-focus-within:text-primary transition-colors" />
          <Input placeholder="SEARCH PROTOCOLS..." className="pl-12 h-14 bg-background/50 border-white/10 rounded-2xl font-headline text-[10px] tracking-widest uppercase" value={search} onChange={(e) => setSearch(e.target.value)} />
        </div>

        <div className="flex items-center gap-2 overflow-x-auto pb-2 no-scrollbar">
          <button 
            onClick={() => setSelectedCategory('ALL')}
            className={cn(
              "px-4 py-2 rounded-full border text-[8px] font-headline font-bold uppercase transition-all shrink-0",
              selectedCategory === 'ALL' 
                ? "bg-primary border-primary text-background gold-glow" 
                : "bg-white/5 border-white/10 text-muted-foreground hover:border-primary/40"
            )}
          >
            All Assets
          </button>
          {categories.map(cat => (
            <button 
              key={cat}
              onClick={() => setSelectedCategory(cat)}
              className={cn(
                "px-4 py-2 rounded-full border text-[8px] font-headline font-bold uppercase transition-all shrink-0",
                selectedCategory === cat 
                  ? "bg-primary border-primary text-background gold-glow" 
                  : "bg-white/5 border-white/10 text-muted-foreground hover:border-primary/40"
              )}
            >
              {cat}
            </button>
          ))}
        </div>
      </div>

      <section className="grid grid-cols-2 gap-4">
        {servicesLoading ? (
          <div className="col-span-full py-20 flex justify-center"><Loader2 className="animate-spin text-primary" size={32} /></div>
        ) : filtered.length === 0 ? (
          <div className="col-span-full text-center py-20 glass-card rounded-3xl border-dashed border-white/10">
            <AlertCircle className="mx-auto text-muted-foreground mb-3" />
            <p className="text-[10px] font-headline font-bold text-muted-foreground uppercase tracking-widest">No assets found</p>
          </div>
        ) : filtered.map((service: any) => {
          const catKey = (service.category || '').toUpperCase();
          const Icon = CATEGORY_ICONS[catKey] || ShoppingBag;
          const displayPrice = service.type === 'variable' 
            ? `From $${Math.min(...service.variants.map((v: any) => v.price))}`
            : `$${service.price}`;

          return (
            <div key={service.id} className="glass-card rounded-[2rem] flex flex-col border-white/5 hover:border-primary/20 transition-all group overflow-hidden">
              <div className="aspect-[4/3] relative bg-white/5">
                {service.imageUrl ? (
                  <img src={service.imageUrl} alt={service.name} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700" />
                ) : (
                  <div className="w-full h-full flex items-center justify-center"><Icon className={cn("h-10 w-10 opacity-20", service.color)} /></div>
                )}
                <div className="absolute top-3 left-3">
                  <Badge className={cn("text-[7px] uppercase font-black tracking-tighter border-white/10", service.color)}>
                    {service.category}
                  </Badge>
                </div>
              </div>
              <div className="p-5 flex-1 flex flex-col justify-between gap-4">
                <div>
                  <h3 className="text-[11px] font-headline font-bold leading-tight group-hover:text-primary transition-colors uppercase">{service.name}</h3>
                  <p className="text-lg font-headline font-black text-primary mt-2">{displayPrice}</p>
                </div>
                <button onClick={() => handleOpenBuyModal(service)} className="w-full h-10 bg-primary/10 border border-primary/20 rounded-xl text-[9px] font-headline font-bold tracking-widest uppercase hover:bg-primary hover:text-background transition-all">Order Asset</button>
              </div>
            </div>
          );
        })}
      </section>

      {/* Buying Modal */}
      <Dialog open={!!selectedService} onOpenChange={() => !isBuying && setSelectedService(null)}>
        <DialogContent className="max-w-sm glass-card border-white/10 p-8 rounded-[2.5rem] z-[1000]">
          {selectedService && (
            <>
              <DialogHeader>
                <DialogTitle className="text-xs font-headline font-bold tracking-widest uppercase text-center flex items-center justify-center gap-2">
                  <ShoppingBag size={14} className="text-primary" /> 
                  {isConfirming ? "Security Authorization" : "Purchase Protocol"}
                </DialogTitle>
              </DialogHeader>
              
              <div className="mt-6 space-y-6">
                {!isConfirming ? (
                  <>
                    <div className="flex items-center gap-4 p-4 bg-white/5 rounded-2xl border border-white/5">
                      <div className="w-12 h-12 rounded-xl overflow-hidden bg-black/20 shrink-0">
                        {selectedService.imageUrl ? <img src={selectedService.imageUrl} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center"><ShoppingBag size={20} className="text-primary/20" /></div>}
                      </div>
                      <div>
                        <p className="text-[10px] font-headline font-bold uppercase">{selectedService.name}</p>
                        <p className="text-[8px] text-muted-foreground uppercase tracking-widest">{selectedService.category}</p>
                      </div>
                    </div>

                    {selectedService.type === 'variable' && (
                      <div className="space-y-2">
                        <Label className="text-[8px] uppercase tracking-widest text-muted-foreground">Select Package</Label>
                        <Select value={selectedVariantIdx} onValueChange={setSelectedVariantIdx}>
                          <SelectTrigger className="h-14 bg-background/50 border-white/10 rounded-xl text-[10px] uppercase font-headline">
                            <SelectValue placeholder="CHOOSE QUANTITY" />
                          </SelectTrigger>
                          <SelectContent className="bg-card border-white/10 z-[1100]" position="popper">
                            {selectedService.variants.map((v: any, idx: number) => (
                              <SelectItem key={idx} value={idx.toString()} className="text-[10px] uppercase font-headline">
                                {v.label} - ${v.price}
                              </SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                      </div>
                    )}

                    {selectedService.requiresInput && (
                      <div className="space-y-2 animate-in slide-in-from-top-2">
                        <Label className="text-[8px] uppercase tracking-widest text-muted-foreground">{selectedService.inputLabel || "Required Info"}</Label>
                        <div className="relative">
                          <Keyboard className="absolute left-4 top-1/2 -translate-y-1/2 h-4 w-4 text-white/20" />
                          <Input 
                            placeholder={`ENTER ${selectedService.inputLabel?.toUpperCase() || "DATA"}`} 
                            className="h-14 bg-background/50 border-white/10 rounded-xl text-[10px] font-headline uppercase pl-12" 
                            value={userInput}
                            onChange={(e) => setUserInput(e.target.value)}
                          />
                        </div>
                      </div>
                    )}

                    <div className="p-5 bg-primary/10 rounded-2xl border border-primary/20 flex justify-between items-center">
                      <p className="text-[10px] font-headline font-bold uppercase text-primary">Final Asset Cost</p>
                      <p className="text-2xl font-headline font-black text-primary">
                        ${selectedService.type === 'variable' 
                          ? (selectedVariantIdx !== "" ? selectedService.variants[parseInt(selectedVariantIdx)].price : "---")
                          : selectedService.price}
                      </p>
                    </div>

                    <div className="flex gap-3">
                      <Button variant="outline" onClick={() => setSelectedService(null)} className="flex-1 h-14 rounded-xl font-headline text-[9px] uppercase tracking-widest border-white/10">Abort</Button>
                      <button onClick={handleInitiatePurchase} className="flex-1 h-14 bg-primary text-background rounded-xl font-headline text-[9px] uppercase tracking-widest font-black gold-glow flex items-center justify-center gap-2">
                        Checkout <ArrowRight size={14} />
                      </button>
                    </div>
                  </>
                ) : (
                  <div className="space-y-6 animate-in zoom-in-95">
                    <div className="p-6 bg-primary/5 border border-primary/20 rounded-3xl text-center space-y-4">
                      <div className="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto border border-primary/30">
                        <ShieldCheck className="text-primary h-8 w-8" />
                      </div>
                      <p className="text-[10px] font-headline font-bold uppercase tracking-widest leading-relaxed">
                        Authorize this transaction?
                      </p>
                      <div className="pt-2">
                        <p className="text-[8px] text-muted-foreground uppercase font-black">Amount to deduct:</p>
                        <p className="text-3xl font-headline font-black text-primary">
                          ${selectedService.type === 'variable' 
                            ? selectedService.variants[parseInt(selectedVariantIdx)].price 
                            : selectedService.price}
                        </p>
                      </div>
                    </div>

                    <div className="flex flex-col gap-3">
                      <Button onClick={handlePinAuth} disabled={isBuying} className="w-full h-14 bg-primary text-background rounded-xl font-headline text-[10px] uppercase tracking-widest font-black gold-glow">
                        Authorize Payment
                      </Button>
                      <Button variant="ghost" onClick={() => setIsConfirming(false)} className="w-full h-10 text-[8px] font-headline uppercase text-muted-foreground" disabled={isBuying}>Back</Button>
                    </div>
                  </div>
                )}
              </div>
            </>
          )}
        </DialogContent>
      </Dialog>

      {/* PIN Verification Modal */}
      <Dialog open={isPinVerificationOpen} onOpenChange={setIsPinVerificationOpen}>
        <DialogContent className="max-w-sm glass-card border-white/10 p-10 text-center rounded-[2.5rem] z-[2000]">
          <DialogHeader><DialogTitle className="text-xs font-headline font-bold tracking-widest uppercase text-primary flex items-center justify-center gap-2"><Fingerprint size={16} /> Verify Vault PIN</DialogTitle></DialogHeader>
          <div className="mt-8">
            <VirtualPad value={pinEntry} onChange={setPinEntry} onComplete={handleConfirmPurchase} />
            {isBuying && <div className="mt-4 flex justify-center"><Loader2 className="animate-spin text-primary" /></div>}
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}


--- START: /src/app/register/page.tsx ---

"use client"

import { useState, useEffect, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import { 
  Mail, 
  Lock, 
  User, 
  Phone, 
  ArrowRight, 
  Loader2, 
  ChevronDown, 
  Eye, 
  EyeOff, 
  UserCircle,
  CheckCircle2,
  XCircle,
  AlertCircle,
  ShieldCheck,
  ChevronLeft
} from 'lucide-react';
import { PlaceHolderImages } from '@/app/lib/placeholder-images';
import { useStore } from '@/app/lib/store';
import { LanguageToggle } from '@/components/ui/LanguageToggle';
import { cn } from '@/lib/utils';
import { useAuth, useUser, useFirestore } from '@/firebase';
import { 
  createUserWithEmailAndPassword, 
  GoogleAuthProvider, 
  signInWithPopup, 
  signOut 
} from 'firebase/auth';
import { doc, setDoc, collection, query, where, getDocs, limit, getDoc } from 'firebase/firestore';
import { useToast } from '@/hooks/use-toast';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";

const COUNTRIES = [
  { code: 'SA', nameEn: 'Saudi Arabia', nameAr: 'السعودية', flag: '🇸🇦', prefix: '+966' },
  { code: 'EG', nameEn: 'Egypt', nameAr: 'مصر', flag: '🇪🇬', prefix: '+20' },
  { code: 'AE', nameEn: 'UAE', nameAr: 'الإمارات', flag: '🇦🇪', prefix: '+971' },
  { code: 'KW', nameEn: 'Kuwait', nameAr: 'الكويت', flag: '🇰🇼', prefix: '+965' },
  { code: 'QA', nameEn: 'Qatar', nameAr: 'قطر', flag: '🇶🇦', prefix: '+974' },
  { code: 'JO', nameEn: 'Jordan', nameAr: 'الأردن', flag: '🇯🇴', prefix: '+962' },
  { code: 'IQ', nameEn: 'Iraq', nameAr: 'العراق', flag: '🇮🇶', prefix: '+964' },
];

export default function RegisterPage() {
  const router = useRouter();
  const auth = useAuth();
  const db = useFirestore();
  const { toast } = useToast();
  const { language } = useStore();

  const [step, setStep] = useState(1);
  const [loading, setLoading] = useState(false);
  
  // Step 1 Fields
  const [firstName, setFirstName] = useState('');
  const [lastName, setLastName] = useState('');
  const [gender, setGender] = useState<'male' | 'female'>('male');
  const [birthDate, setBirthDate] = useState<Date | undefined>(undefined);

  // Step 2 Fields
  const [username, setUsername] = useState('');
  const [isUsernameValid, setIsUsernameValid] = useState<boolean | null>(null);
  const [usernameSuggestions, setUsernameSuggestions] = useState<string[]>([]);
  const [checkingUsername, setCheckingUsername] = useState(false);
  const [email, setEmail] = useState('');
  const [phone, setPhone] = useState('');
  const [selectedCountry, setSelectedCountry] = useState(COUNTRIES[0]);
  const [isCountryOpen, setIsCountryOpen] = useState(false);
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);

  const backgroundImage = PlaceHolderImages.find(img => img.id === 'login-bg');

  const passwordCriteria = {
    length: password.length >= 8,
    upper: /[A-Z]/.test(password),
    number: /[0-9]/.test(password),
    special: /[@$!%*?&]/.test(password)
  };

  const isPasswordStrong = Object.values(passwordCriteria).every(Boolean);

  const generateCustomId = () => {
    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const firstLetter = letters.charAt(Math.floor(Math.random() * letters.length));
    const numbers = Array.from({ length: 12 }, () => Math.floor(Math.random() * 10)).join('');
    return `${firstLetter}${numbers}`;
  };

  const checkUsernameUniqueness = async (val: string) => {
    if (val.length < 3) {
      setIsUsernameValid(null);
      return;
    }
    setCheckingUsername(true);
    try {
      const q = query(collection(db, 'users'), where('username', '==', val.toLowerCase()), limit(1));
      const snap = await getDocs(q);
      if (snap.empty) {
        setIsUsernameValid(true);
        setUsernameSuggestions([]);
      } else {
        setIsUsernameValid(false);
        const suggestions = [
          `${val}${Math.floor(Math.random() * 999)}`,
          `${val}_${new Date().getFullYear()}`,
          `${val}.flash`
        ];
        setUsernameSuggestions(suggestions);
      }
    } catch (e) {
      console.error(e);
    } finally {
      setCheckingUsername(false);
    }
  };

  useEffect(() => {
    const timer = setTimeout(() => {
      if (username) checkUsernameUniqueness(username);
    }, 500);
    return () => clearTimeout(timer);
  }, [username]);

  const handleNextStep = () => {
    if (!firstName || !lastName || !birthDate) {
      toast({ variant: "destructive", title: language === 'ar' ? "بيانات ناقصة" : "Missing Info" });
      return;
    }
    if (!username) setUsername(`${firstName}${lastName}`.toLowerCase().replace(/\s/g, ''));
    setStep(2);
  };

  const handleGoogleRegister = async () => {
    if (!auth || !db) return;
    setLoading(true);
    const provider = new GoogleAuthProvider();
    try {
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      const docRef = doc(db, 'users', user.uid);
      const docSnap = await getDoc(docRef);

      if (!docSnap.exists()) {
        const names = user.displayName?.split(' ') || [];
        await setDoc(docRef, {
          firstName: names[0] || '',
          lastName: names.slice(1).join(' ') || '',
          username: user.email?.split('@')[0].toLowerCase() || user.uid.slice(0, 8),
          email: user.email?.toLowerCase(),
          phone: '',
          gender: 'male',
          birthDate: null,
          country: 'GL',
          customId: generateCustomId(),
          balance: 0,
          role: 'user',
          verified: false,
          language: language,
          createdAt: new Date().toISOString()
        });
        toast({ title: language === 'ar' ? "تم التسجيل بنجاح! يرجى إكمال ملفك الشخصي." : "Registered via Google! Please complete your profile." });
        router.push('/profile/edit');
      } else {
        toast({ title: language === 'ar' ? "أنت تملك حساباً بالفعل." : "You already have an account." });
        router.push('/dashboard');
      }
    } catch (error: any) {
      toast({ variant: "destructive", title: "Google Auth Failed", description: error.message });
    } finally {
      setLoading(false);
    }
  };

  const handleRegister = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!isUsernameValid || !isPasswordStrong || !email || !phone) return;

    setLoading(true);
    try {
      const cleanEmail = email.trim().toLowerCase();
      const fullPhone = `${selectedCountry.prefix}${phone.trim()}`;

      const qEmail = query(collection(db, 'users'), where('email', '==', cleanEmail));
      const emailSnap = await getDocs(qEmail);
      if (!emailSnap.empty) {
        toast({ variant: "destructive", title: language === 'ar' ? "البريد مستخدم" : "Email in use" });
        setLoading(false);
        return;
      }

      const userCredential = await createUserWithEmailAndPassword(auth, cleanEmail, password);
      await setDoc(doc(db, 'users', userCredential.user.uid), {
        firstName,
        lastName,
        username: username.toLowerCase(),
        email: cleanEmail,
        phone: fullPhone,
        gender,
        birthDate: birthDate?.toISOString(),
        country: selectedCountry.code,
        customId: generateCustomId(),
        balance: 0,
        role: 'user',
        verified: false,
        language: language,
        createdAt: new Date().toISOString()
      });

      await signOut(auth);
      toast({
        title: language === 'ar' ? "تم إنشاء الحساب!" : "Wallet Created!",
        description: language === 'ar' ? "يرجى تسجيل الدخول للبدء." : "Please login to start."
      });
      router.push('/');
    } catch (error: any) {
      toast({ variant: "destructive", title: "Error", description: error.message });
    } finally {
      setLoading(false);
    }
  };

  const t = {
    title: language === 'ar' ? 'إنشاء محفظة' : 'CREATE WALLET',
    step1: language === 'ar' ? 'البيانات الشخصية' : 'Personal Info',
    step2: language === 'ar' ? 'بيانات الحماية' : 'Security Setup',
    firstName: language === 'ar' ? 'الاسم الأول' : 'First Name',
    lastName: language === 'ar' ? 'الاسم الأخير' : 'Last Name',
    gender: language === 'ar' ? 'الجنس' : 'Gender',
    male: language === 'ar' ? 'ذكر' : 'Male',
    female: language === 'ar' ? 'أنثى' : 'Female',
    birthDate: language === 'ar' ? 'تاريخ الميلاد' : 'Birth Date',
    next: language === 'ar' ? 'التالي' : 'Next',
    username: language === 'ar' ? 'اسم المستخدم' : 'Username',
    checking: language === 'ar' ? 'جاري التحقق...' : 'Checking...',
    taken: language === 'ar' ? 'هذا الاسم محجوز' : 'Username taken',
    available: language === 'ar' ? 'اسم المستخدم متاح' : 'Username available',
    suggest: language === 'ar' ? 'اقتراحات:' : 'Suggestions:',
    email: language === 'ar' ? 'البريد الإلكتروني' : 'Email Address',
    phone: language === 'ar' ? 'رقم الهاتف' : 'Phone Number',
    password: language === 'ar' ? 'كلمة المرور' : 'Password',
    register: language === 'ar' ? 'تفعيل المحفظة' : 'Activate Wallet',
    back: language === 'ar' ? 'رجوع' : 'Back',
    login: language === 'ar' ? 'تسجيل الدخول' : 'Login'
  };

  return (
    <div className="min-h-screen flex items-center justify-center relative overflow-hidden bg-[#0a0a0a]" onClick={() => setIsCountryOpen(false)}>
      <div className="absolute top-6 right-6 z-[100]"><LanguageToggle /></div>
      <div className="absolute inset-0 z-0 opacity-40" style={{ backgroundImage: `url('${backgroundImage?.imageUrl}')`, backgroundSize: 'cover', backgroundPosition: 'center' }}>
        <div className="absolute inset-0 bg-black/85 backdrop-blur-sm"></div>
      </div>

      <div className="relative z-10 w-full max-w-md p-8 m-4 rounded-[2.5rem] border border-white/10 bg-black/30 backdrop-blur-xl shadow-2xl animate-in fade-in duration-700 max-h-[95vh] overflow-y-auto no-scrollbar">
        <header className="text-center mb-8">
          <h1 className="text-4xl font-headline font-bold text-white tracking-tighter gold-glow-text mb-2">FLASH</h1>
          <div className="flex items-center justify-center gap-2">
            <div className={cn("w-2 h-2 rounded-full", step >= 1 ? "bg-primary" : "bg-white/20")} />
            <div className={cn("w-10 h-1 rounded-full", step >= 2 ? "bg-primary" : "bg-white/20")} />
            <div className={cn("w-2 h-2 rounded-full", step >= 2 ? "bg-primary" : "bg-white/20")} />
          </div>
          <p className="text-primary/60 text-[9px] font-bold uppercase tracking-[0.3em] mt-2">{step === 1 ? t.step1 : t.step2}</p>
        </header>

        {step === 1 ? (
          <div className="space-y-6 animate-in slide-in-from-right-4">
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label className="text-[10px] uppercase text-white/40">{t.firstName}</Label>
                <Input value={firstName} onChange={(e) => setFirstName(e.target.value)} className="bg-white/5 border-white/10 h-12 text-sm" placeholder="John" />
              </div>
              <div className="space-y-2">
                <Label className="text-[10px] uppercase text-white/40">{t.lastName}</Label>
                <Input value={lastName} onChange={(e) => setLastName(e.target.value)} className="bg-white/5 border-white/10 h-12 text-sm" placeholder="Doe" />
              </div>
            </div>

            <div className="space-y-2">
              <Label className="text-[10px] uppercase text-white/40">{t.gender}</Label>
              <RadioGroup value={gender} onValueChange={(v: any) => setGender(v)} className="flex gap-4">
                <div className={cn("flex-1 flex items-center justify-center gap-2 h-12 rounded-xl border transition-all cursor-pointer", gender === 'male' ? "bg-primary/10 border-primary text-primary" : "bg-white/5 border-white/10 text-white/40")}>
                  <RadioGroupItem value="male" id="male" className="sr-only" />
                  <Label htmlFor="male" className="cursor-pointer font-headline text-[10px] uppercase">{t.male}</Label>
                </div>
                <div className={cn("flex-1 flex items-center justify-center gap-2 h-12 rounded-xl border transition-all cursor-pointer", gender === 'female' ? "bg-pink-500/10 border-pink-500 text-pink-500" : "bg-white/5 border-white/10 text-white/40")}>
                  <RadioGroupItem value="female" id="female" className="sr-only" />
                  <Label htmlFor="female" className="cursor-pointer font-headline text-[10px] uppercase">{t.female}</Label>
                </div>
              </RadioGroup>
            </div>

            <div className="space-y-2">
              <Label className="text-[10px] uppercase text-white/40">{t.birthDate}</Label>
              <Input 
                type="date"
                value={birthDate ? birthDate.toISOString().split('T')[0] : ''}
                onChange={(e) => setBirthDate(e.target.value ? new Date(e.target.value) : undefined)}
                className="bg-white/5 border-white/10 h-12 text-sm text-white focus:border-primary/50 rounded-xl"
                style={{ colorScheme: 'dark' }}
              />
            </div>

            <Button onClick={handleNextStep} disabled={!firstName || !lastName || !birthDate} className="w-full h-14 bg-primary text-background font-headline font-black tracking-widest rounded-2xl gold-glow mt-4">
              {t.next} <ArrowRight className={cn("ml-2", language === 'ar' && "rotate-180")} size={18} />
            </Button>

            <div className="relative my-6">
              <div className="absolute inset-0 flex items-center"><span className="w-full border-t border-white/5"></span></div>
              <div className="relative flex justify-center"><span className="bg-[#0b0b0d] px-4 text-[8px] text-white/30 uppercase tracking-[0.3em] font-black">OR</span></div>
            </div>

            <button type="button" onClick={handleGoogleRegister} className="w-full h-16 bg-white/5 border border-white/5 rounded-2xl flex items-center justify-center gap-3 hover:bg-white/10 transition-all group">
              <svg className="w-5 h-5" viewBox="0 0 48 48">
                <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.13-.45-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24s.92 7.54 2.56 10.78l7.97-6.19z"/>
                <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
              </svg>
              <span className="text-[10px] font-headline font-bold uppercase tracking-widest text-white/60 group-hover:text-white">Sign up with Google</span>
            </button>
          </div>
        ) : (
          <form onSubmit={handleRegister} className="space-y-4 animate-in slide-in-from-right-4">
            <div className="space-y-2">
              <Label className="text-[10px] uppercase text-white/40">{t.username}</Label>
              <div className="relative">
                <UserCircle className={cn("absolute top-1/2 -translate-y-1/2 text-white/20", language === 'ar' ? 'right-4' : 'left-4')} size={18} />
                <Input 
                  value={username} 
                  onChange={(e) => setUsername(e.target.value.toLowerCase().replace(/[^a-z0-9_]/g, ''))} 
                  className={cn("bg-white/5 border-white/10 h-12 text-sm", language === 'ar' ? 'pr-12' : 'pl-12')} 
                  placeholder="username"
                />
                <div className="absolute right-4 top-1/2 -translate-y-1/2">
                  {checkingUsername ? <Loader2 className="animate-spin text-primary h-4 w-4" /> : 
                   isUsernameValid === true ? <CheckCircle2 className="text-green-500 h-4 w-4" /> :
                   isUsernameValid === false ? <XCircle className="text-red-500 h-4 w-4" /> : null}
                </div>
              </div>
              {isUsernameValid === false && (
                <div className="p-3 bg-red-500/10 border border-red-500/20 rounded-xl space-y-2">
                  <p className="text-[9px] text-red-500 font-bold uppercase">{t.taken}</p>
                  <div className="flex flex-wrap gap-2">
                    {usernameSuggestions.map(s => (
                      <button key={s} type="button" onClick={() => setUsername(s)} className="px-2 py-1 bg-white/5 rounded-md text-[8px] text-white/60 hover:text-primary transition-colors">@{s}</button>
                    ))}
                  </div>
                </div>
              )}
            </div>

            <div className="space-y-2">
              <Label className="text-[10px] uppercase text-white/40">{t.email}</Label>
              <div className="relative">
                <Mail className={cn("absolute top-1/2 -translate-y-1/2 text-white/20", language === 'ar' ? 'right-4' : 'left-4')} size={18} />
                <Input value={email} type="email" onChange={(e) => setEmail(e.target.value)} className={cn("bg-white/5 border-white/10 h-12 text-sm", language === 'ar' ? 'pr-12' : 'pl-12')} placeholder="email@example.com" required />
              </div>
            </div>

            <div className="space-y-2">
              <Label className="text-[10px] uppercase text-white/40">{t.phone}</Label>
              <div className="flex gap-2" dir="ltr">
                <button type="button" onClick={(e) => { e.stopPropagation(); setIsCountryOpen(!isCountryOpen); }} className="h-12 bg-white/5 border border-white/10 rounded-xl px-3 flex items-center gap-2 min-w-[90px]">
                  <span className="text-xs">{selectedCountry.flag}</span>
                  <ChevronDown size={12} className={cn(isCountryOpen && "rotate-180")} />
                </button>
                <div className="relative flex-1">
                  <Phone className="absolute top-1/2 -translate-y-1/2 left-4 text-white/20" size={18} />
                  <Input value={phone} onChange={(e) => setPhone(e.target.value)} className="bg-white/5 border-white/10 h-12 text-sm pl-12" placeholder="123456789" required />
                </div>
              </div>
              {isCountryOpen && (
                <div className="absolute left-8 right-8 z-[110] bg-[#1a1a1a] border border-white/10 rounded-xl max-h-40 overflow-y-auto shadow-2xl">
                  {COUNTRIES.map(c => (
                    <button key={c.code} type="button" onClick={() => { setSelectedCountry(c); setIsCountryOpen(false); }} className="w-full p-3 flex items-center gap-3 hover:bg-white/5 border-b border-white/5 last:border-0">
                      <span className="text-lg">{c.flag}</span>
                      <span className="text-xs text-white/80">{language === 'ar' ? c.nameAr : c.nameEn}</span>
                      <span className="text-[10px] text-white/30 ml-auto">{c.prefix}</span>
                    </button>
                  ))}
                </div>
              )}
            </div>

            <div className="space-y-2">
              <Label className="text-[10px] uppercase text-white/40">{t.password}</Label>
              <div className="relative">
                <Lock className={cn("absolute top-1/2 -translate-y-1/2 text-white/20", language === 'ar' ? 'right-4' : 'left-4')} size={18} />
                <Input value={password} type={showPassword ? "text" : "password"} onChange={(e) => setPassword(e.target.value)} className={cn("bg-white/5 border-white/10 h-12 text-sm", language === 'ar' ? 'pr-12 pl-12' : 'pl-12 pr-12')} placeholder="••••••••" required />
                <button type="button" onClick={() => setShowPassword(!showPassword)} className={cn("absolute top-1/2 -translate-y-1/2 text-white/20", language === 'ar' ? 'left-4' : 'right-4')}>
                  {showPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                </button>
              </div>
              <div className="grid grid-cols-2 gap-2 mt-2">
                {Object.entries(passwordCriteria).map(([key, valid]) => (
                  <div key={key} className="flex items-center gap-1.5">
                    {valid ? <ShieldCheck className="text-green-500" size={10} /> : <AlertCircle className="text-white/20" size={10} />}
                    <span className={cn("text-[8px] uppercase font-bold", valid ? "text-green-500" : "text-white/30")}>
                      {key === 'length' ? '8+ Chars' : key === 'upper' ? 'Uppercase' : key === 'number' ? 'Number' : 'Special Symbol'}
                    </span>
                  </div>
                ))}
              </div>
            </div>

            <div className="flex gap-3 mt-6">
              <Button type="button" variant="outline" onClick={() => setStep(1)} className="flex-1 h-14 rounded-2xl bg-white/5 border-white/10 font-headline text-[10px] uppercase">
                {t.back}
              </Button>
              <Button type="submit" disabled={loading || !isUsernameValid || !isPasswordStrong} className="flex-[2] h-14 bg-primary text-background font-headline font-black tracking-widest rounded-2xl gold-glow">
                {loading ? <Loader2 className="animate-spin" /> : t.register}
              </Button>
            </div>
          </form>
        )}

        <p className="text-center mt-8 text-white/40 text-[10px] font-bold uppercase tracking-widest">
          {language === 'ar' ? 'لديك حساب بالفعل؟' : 'Already have an account?'} <Link href="/" className="text-primary cursor-pointer hover:underline">{t.login}</Link>
        </p>
      </div>
    </div>
  );
}


--- START: /src/app/admin/page.tsx ---

"use client"

import { useMemo, useEffect, useState, useRef } from 'react';
import { useRouter } from 'next/navigation';
import { Badge } from '@/components/ui/badge';
import { 
  Check, 
  X, 
  Loader2, 
  Users, 
  Search, 
  User as UserIcon,
  ArrowUpCircle,
  ArrowDownCircle,
  LayoutDashboard,
  ShieldCheck,
  FileText,
  Globe,
  DollarSign,
  Trash2,
  Settings2,
  Plus,
  CircleDot,
  SendHorizontal,
  LogOut,
  Star,
  History,
  Info,
  ArrowRight,
  MessageSquare,
  ShoppingBag,
  Ticket,
  ChevronDown,
  PlusCircle,
  Banknote,
  ClipboardList,
  Store as StoreIcon,
  AlertTriangle,
  Keyboard,
  Edit3,
  ImageIcon,
} from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { cn } from '@/lib/utils';
import { useFirestore, useCollection, useUser, useDoc } from '@/firebase';
import { 
  collection, 
  doc, 
  updateDoc, 
  query, 
  orderBy, 
  runTransaction, 
  setDoc, 
  increment, 
  deleteDoc, 
  addDoc, 
  onSnapshot, 
  where, 
  getDocs 
} from 'firebase/firestore';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Label } from '@/components/ui/label';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Button } from '@/components/ui/button';
import { Switch } from '@/components/ui/switch';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import Link from 'next/link';

const COUNTRIES = [
  { code: 'GL', name: 'Global' },
  { code: 'CR', name: 'Crypto' },
  { code: 'SA', name: 'Saudi Arabia' },
  { code: 'EG', name: 'Egypt' },
  { code: 'AE', name: 'UAE' },
  { code: 'KW', name: 'Kuwait' },
  { code: 'QA', name: 'Qatar' },
  { code: 'JO', name: 'Jordan' },
  { code: 'IQ', name: 'Iraq' },
];

export default function AdminPage() {
  const router = useRouter();
  const db = useFirestore();
  const { user, loading: authLoading } = useUser();
  const { toast } = useToast();
  
  const [searchTerm, setSearchTerm] = useState('');
  const [editingUserId, setEditingUserId] = useState<string | null>(null);
  const [editForm, setEditForm] = useState<any>({});
  const [isUserDeleteDialogOpen, setIsUserDeleteDialogOpen] = useState(false);
  
  // Product Image Ref
  const productFileInputRef = useRef<HTMLInputElement>(null);

  // Chat Admin States
  const [chatConfig, setChatConfig] = useState<any>(null);
  const [activeChat, setActiveChat] = useState<any>(null);
  const [chatReply, setChatMessage] = useState('');
  const [chatMessages, setChatMessages] = useState<any[]>([]);
  const [isJoiningChat, setIsJoiningChat] = useState(false);
  const [isClosingChat, setIsClosingChat] = useState(false);
  const chatScrollRef = useRef<HTMLDivElement>(null);

  // Archive State
  const [selectedArchive, setSelectedArchive] = useState<any>(null);
  const [archiveMessages, setArchiveMessages] = useState<any[]>([]);
  const [showFullArchive, setShowFullArchive] = useState(false);

  // Management States
  const [isAddingMethod, setIsAddingMethod] = useState(false);
  const [methodType, setMethodType] = useState<'deposit' | 'withdraw'>('deposit');
  const [newMethod, setNewMethod] = useState<any>({
    name: '',
    country: 'GL',
    currencyCode: 'USD',
    exchangeRate: 1,
    feeType: 'fixed',
    feeValue: 0,
    isActive: true,
    fields: [{ label: '', value: '', type: 'text' }]
  });

  const [isAddingProduct, setIsAddingProduct] = useState(false);
  const [editingProductId, setEditingProductId] = useState<string | null>(null);
  const [newProduct, setNewProduct] = useState<any>({
    name: '',
    category: '',
    price: 0,
    type: 'fixed',
    variants: [{ label: '', price: 0 }],
    requiresInput: false,
    inputLabel: '',
    isActive: true,
    imageUrl: '',
    color: 'bg-primary'
  });

  const userDocRef = useMemo(() => (user && db) ? doc(db, 'users', user.uid) : null, [db, user]);
  const { data: profile, loading: profileLoading } = useDoc(userDocRef);

  // Queries
  const allWithdrawalsQuery = useMemo(() => query(collection(db, 'withdrawals')), [db]);
  const { data: allWithdrawals = [] } = useCollection(allWithdrawalsQuery);
  const withdrawals = useMemo(() => [...allWithdrawals].sort((a: any, b: any) => new Date(b.date).getTime() - new Date(a.date).getTime()), [allWithdrawals]);

  const allDepositsQuery = useMemo(() => query(collection(db, 'deposits')), [db]);
  const { data: allDeposits = [] } = useCollection(allDepositsQuery);
  const deposits = useMemo(() => [...allDeposits].sort((a: any, b: any) => new Date(b.date).getTime() - new Date(a.date).getTime()), [allDeposits]);

  const allUsersQuery = useMemo(() => query(collection(db, 'users')), [db]);
  const { data: allUsers = [] } = useCollection(allUsersQuery);

  const allVerificationsQuery = useMemo(() => query(collection(db, 'verifications')), [db]);
  const { data: allVerifications = [] } = useCollection(allVerificationsQuery);
  const verifications = useMemo(() => [...allVerifications].sort((a: any, b: any) => new Date(b.date).getTime() - new Date(a.date).getTime()), [allVerifications]);

  const allTicketsQuery = useMemo(() => query(collection(db, 'support_tickets')), [db]);
  const { data: allTickets = [] } = useCollection(allTicketsQuery);
  const tickets = useMemo(() => [...allTickets].sort((a: any, b: any) => new Date(b.date).getTime() - new Date(a.date).getTime()), [allTickets]);

  const allOrdersQuery = useMemo(() => query(collection(db, 'service_requests')), [db]);
  const { data: allOrders = [] } = useCollection(allOrdersQuery);
  const orders = useMemo(() => [...allOrders].sort((a: any, b: any) => new Date(b.date).getTime() - new Date(a.date).getTime()), [allOrders]);

  const chatSessionsQuery = useMemo(() => query(collection(db, 'chat_sessions')), [db]);
  const { data: allChatSessions = [] } = useCollection(chatSessionsQuery);

  const depositMethodsQuery = useMemo(() => query(collection(db, 'deposit_methods')), [db]);
  const { data: depositMethods = [] } = useCollection(depositMethodsQuery);

  const withdrawalMethodsQuery = useMemo(() => query(collection(db, 'withdrawal_methods')), [db]);
  const { data: withdrawalMethods = [] } = useCollection(withdrawalMethodsQuery);

  const productsQuery = useMemo(() => query(collection(db, 'marketplace_services')), [db]);
  const { data: products = [] } = useCollection(productsQuery);

  // Processed Chat Data
  const chatSessions = useMemo(() => {
    return allChatSessions
      .filter((s: any) => ['open', 'active', 'closed'].includes(s.status))
      .sort((a: any, b: any) => new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime());
  }, [allChatSessions]);

  const archivedSessions = useMemo(() => {
    return allChatSessions
      .filter((s: any) => s.status === 'archived')
      .sort((a: any, b: any) => new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime());
  }, [allChatSessions]);

  const filteredUsers = useMemo(() => {
    return allUsers.filter((u: any) => 
      u.username?.toLowerCase().includes(searchTerm.toLowerCase()) || 
      u.customId?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      u.email?.toLowerCase().includes(searchTerm.toLowerCase())
    );
  }, [allUsers, searchTerm]);

  useEffect(() => {
    if (!authLoading && !profileLoading && profile && (profile as any).role !== 'admin') {
      toast({ variant: "destructive", title: "ACCESS DENIED" });
      router.push('/dashboard');
    }
  }, [profile, profileLoading, authLoading, router, toast]);

  useEffect(() => {
    if (!db) return;
    const unsub = onSnapshot(doc(db, 'system_settings', 'chat_config'), (doc) => {
      if (doc.exists()) setChatConfig(doc.data());
    });
    return () => unsub();
  }, [db]);

  useEffect(() => {
    if (!db || !activeChat) return;
    const qMsg = query(collection(db, 'chat_sessions', activeChat.id, 'messages'), orderBy('timestamp', 'asc'));
    const unsub = onSnapshot(qMsg, (snap) => {
      setChatMessages(snap.docs.map(d => ({ id: d.id, ...d.data() })));
      setTimeout(() => chatScrollRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
    });
    return () => unsub();
  }, [db, activeChat]);

  // Handlers
  const handleAction = async (type: 'deposit' | 'withdraw' | 'kyc' | 'order', id: string, action: 'approve' | 'reject', extra?: any) => {
    if (!db) return;
    try {
      const collectionName = type === 'kyc' ? 'verifications' : type === 'deposit' ? 'deposits' : type === 'withdraw' ? 'withdrawals' : 'service_requests';
      const docRef = doc(db, collectionName, id);
      const snap = await getDocs(query(collection(db, collectionName), where('__name__', '==', id)));
      if (snap.empty) return;
      const data = snap.docs[0].data();

      if (action === 'approve') {
        await runTransaction(db, async (transaction) => {
          const userRef = doc(db, 'users', data.userId);
          transaction.update(docRef, { status: 'approved', ...extra });
          if (type === 'deposit') {
            transaction.update(userRef, { balance: increment(data.amount) });
            transaction.set(doc(collection(db, 'users', data.userId, 'transactions')), { type: 'deposit', amount: data.amount, status: 'completed', date: new Date().toISOString() });
          } else if (type === 'kyc') transaction.update(userRef, { verified: true });
          transaction.set(doc(collection(db, 'users', data.userId, 'notifications')), {
            title: type === 'deposit' ? "Assets Credited" : type === 'kyc' ? "Authority Verified" : type === 'order' ? "Order Fulfilled" : "Withdrawal Success",
            message: type === 'deposit' ? `$${data.amount} added to vault.` : "Protocol executed successfully.",
            read: false,
            date: new Date().toISOString()
          });
        });
      } else {
        await runTransaction(db, async (transaction) => {
          transaction.update(docRef, { status: 'rejected', rejectionReason: extra?.reason || 'Protocol Denied' });
          if (type === 'withdraw' || type === 'order') transaction.update(doc(db, 'users', data.userId), { balance: increment(data.amountUsd || data.price) });
        });
      }
      toast({ title: "ACTION EXECUTED" });
    } catch (e: any) { toast({ variant: "destructive", title: "FAILED", description: e.message }); }
  };

  const handleSaveMethod = async () => {
    if (!db) return;
    try {
      await addDoc(collection(db, methodType === 'deposit' ? 'deposit_methods' : 'withdrawal_methods'), newMethod);
      toast({ title: "METHOD DEPLOYED" });
      setIsAddingMethod(false);
    } catch (e) { toast({ variant: "destructive", title: "DEPLOY FAILED" }); }
  };

  const handleSaveProduct = async () => {
    if (!db) return;
    try {
      if (editingProductId) await updateDoc(doc(db, 'marketplace_services', editingProductId), newProduct);
      else await addDoc(collection(db, 'marketplace_services'), newProduct);
      toast({ title: "PRODUCT SECURED" });
      setIsAddingProduct(false);
      setEditingProductId(null);
    } catch (e) { toast({ variant: "destructive", title: "SAVE FAILED" }); }
  };

  const handleEditProduct = (product: any) => {
    setEditingProductId(product.id);
    setNewProduct({ ...product });
    setIsAddingProduct(true);
  };

  const handleProductImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setNewProduct((prev: any) => ({ ...prev, imageUrl: reader.result as string }));
      };
      reader.readAsDataURL(file);
    }
  };

  const toggleStatus = async (coll: string, id: string, status: boolean) => {
    try { await updateDoc(doc(db, coll, id), { isActive: status }); toast({ title: "STATUS SYNCED" }); } catch (e) { }
  };

  const handleDeleteUserEntity = async () => {
    if (!editingUserId || !db) return;
    try {
      await deleteDoc(doc(db, 'users', editingUserId));
      toast({ title: "ENTITY PURGED" });
      setEditingUserId(null);
      setIsUserDeleteDialogOpen(false);
    } catch (e: any) { toast({ variant: "destructive", title: "PURGE FAILED", description: e.message }); }
  };

  if (authLoading || profileLoading) return <div className="min-h-screen bg-background flex items-center justify-center"><Loader2 className="h-8 w-8 text-primary animate-spin" /></div>;

  return (
    <div className="max-w-7xl mx-auto p-4 sm:p-6 space-y-8 animate-in fade-in slide-in-from-top-4 duration-700 pb-32">
      <header className="flex justify-between items-center p-5 glass-card rounded-[2rem] border-primary/20 gold-glow">
        <div className="flex items-center gap-3">
          <Link href="/dashboard" className="p-2 hover:bg-primary/10 rounded-xl transition-all text-primary group"><LayoutDashboard className="h-6 w-6 group-hover:scale-110" /></Link>
          <div><h1 className="text-xs font-headline font-bold tracking-widest uppercase">Admin Command</h1><p className="text-[8px] text-muted-foreground uppercase font-black">Authorized Shell v4.5.0</p></div>
        </div>
        <Badge variant="outline" className="text-[8px] tracking-[0.2em] font-black uppercase text-primary border-primary/30 py-1">System Master</Badge>
      </header>

      <Tabs defaultValue="withdrawals" className="w-full">
        <div className="pb-8">
          <TabsList className="grid grid-cols-2 sm:grid-cols-4 w-full h-auto bg-card/40 border border-white/5 rounded-[2rem] p-2 gap-2">
            <TabsTrigger value="withdrawals" className="rounded-2xl font-headline text-[10px] uppercase data-[state=active]:bg-primary data-[state=active]:text-background p-4 flex items-center justify-center gap-2"><ArrowUpCircle className="h-4 w-4" /> Withdraws</TabsTrigger>
            <TabsTrigger value="deposits" className="rounded-2xl font-headline text-[10px] uppercase data-[state=active]:bg-primary data-[state=active]:text-background p-4 flex items-center justify-center gap-2"><ArrowDownCircle className="h-4 w-4" /> Deposits</TabsTrigger>
            <TabsTrigger value="chats" className="rounded-2xl font-headline text-[10px] uppercase data-[state=active]:bg-primary data-[state=active]:text-background p-4 flex items-center justify-center gap-2"><MessageSquare className="h-4 w-4" /> Chats</TabsTrigger>
            <TabsTrigger value="tickets" className="rounded-2xl font-headline text-[10px] uppercase data-[state=active]:bg-primary data-[state=active]:text-background p-4 flex items-center justify-center gap-2"><Ticket className="h-4 w-4" /> Tickets</TabsTrigger>
            <TabsTrigger value="orders" className="rounded-2xl font-headline text-[10px] uppercase data-[state=active]:bg-primary data-[state=active]:text-background p-4 flex items-center justify-center gap-2"><ClipboardList className="h-4 w-4" /> Orders</TabsTrigger>
            <TabsTrigger value="gateways" className="rounded-2xl font-headline text-[10px] uppercase data-[state=active]:bg-primary data-[state=active]:text-background p-4 flex items-center justify-center gap-2"><Banknote className="h-4 w-4" /> Gateways</TabsTrigger>
            <TabsTrigger value="store" className="rounded-2xl font-headline text-[10px] uppercase data-[state=active]:bg-primary data-[state=active]:text-background p-4 flex items-center justify-center gap-2"><StoreIcon className="h-4 w-4" /> Store</TabsTrigger>
            <TabsTrigger value="users" className="rounded-2xl font-headline text-[10px] uppercase data-[state=active]:bg-primary data-[state=active]:text-background p-4 flex items-center justify-center gap-2"><Users className="h-4 w-4" /> Entities</TabsTrigger>
            <TabsTrigger value="kyc" className="rounded-2xl font-headline text-[10px] uppercase data-[state=active]:bg-primary data-[state=active]:text-background p-4 flex items-center justify-center gap-2 sm:col-span-4"><ShieldCheck className="h-4 w-4" /> KYC Verification</TabsTrigger>
          </TabsList>
        </div>

        <TabsContent value="users" className="space-y-6">
          <div className="flex flex-col sm:flex-row gap-4 justify-between items-center mb-6">
            <div className="relative w-full sm:max-w-md group"><Search className="absolute left-4 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground group-focus-within:text-primary transition-colors" /><Input placeholder="SEARCH INTEL LEDGER..." className="pl-12 h-12 bg-card/40 border-white/10 rounded-2xl text-[10px] font-headline uppercase" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div>
            <div className="flex gap-4"><div className="glass-card px-6 py-2 rounded-2xl text-center"><p className="text-[7px] text-muted-foreground uppercase font-black">Active Entities</p><p className="text-lg font-headline font-black text-white">{allUsers.length}</p></div><div className="glass-card px-6 py-2 rounded-2xl text-center"><p className="text-[7px] text-muted-foreground uppercase font-black">Managed Liquidity</p><p className="text-lg font-headline font-black text-primary">${allUsers.reduce((acc: any, u: any) => acc + (u.balance || 0), 0).toLocaleString()}</p></div></div>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {filteredUsers.map((u: any) => (
              <div key={u.id} className="glass-card p-5 rounded-[2rem] border-white/5 hover:border-primary/20 transition-all group">
                <div className="flex justify-between items-start mb-4">
                  <div className="flex items-center gap-3">
                    <div className={cn("w-10 h-10 rounded-xl border flex items-center justify-center relative overflow-hidden", u.verified ? "border-green-500 shadow-[0_0_10px_rgba(34,197,94,0.3)]" : "border-red-500")}>{u.avatarUrl ? <img src={u.avatarUrl} className="w-full h-full object-cover" alt="avatar" /> : <UserIcon className="text-muted-foreground" />}</div>
                    <div>
                      <div className="text-[10px] font-headline font-bold uppercase">@{u.username}</div>
                      <div className="text-[7px] text-muted-foreground font-black tracking-widest flex flex-col gap-0.5 mt-1">
                        <span>ID: {u.customId}</span>
                        <span className="lowercase opacity-60 truncate max-w-[120px]">{u.email}</span>
                      </div>
                    </div>
                  </div>
                  <button onClick={() => { setEditingUserId(u.id); setEditForm(u); }} className="p-2 hover:bg-primary/10 rounded-xl text-primary transition-all"><Settings2 size={16} /></button>
                </div>
                <div className="space-y-3"><div className="flex justify-between items-center"><span className="text-[8px] text-muted-foreground uppercase font-black">Vault Status:</span><span className="text-sm font-headline font-black text-primary">${u.balance?.toLocaleString()}</span></div><div className="flex justify-between items-center"><span className="text-[8px] text-muted-foreground uppercase font-black">Role:</span><Badge variant="outline" className="text-[6px] uppercase border-primary/20 text-primary">{u.role}</Badge></div></div>
              </div>
            ))}
          </div>
        </TabsContent>

        <TabsContent value="store" className="space-y-8">
          <div className="flex justify-between items-center bg-card/20 p-6 rounded-3xl border border-white/5">
            <div><h2 className="text-sm font-headline font-bold uppercase tracking-widest text-primary">Marketplace Core</h2><p className="text-[8px] text-muted-foreground uppercase">Deploy and Manage Global Digital Assets</p></div>
            <Button onClick={() => { setEditingProductId(null); setIsAddingProduct(true); setNewProduct({ name: '', category: '', price: 0, type: 'fixed', variants: [{ label: '', price: 0 }], requiresInput: false, inputLabel: '', isActive: true, imageUrl: '', color: 'bg-primary' }); }} className="bg-primary text-background h-12 rounded-xl font-headline text-[9px] font-black uppercase tracking-widest gold-glow"><PlusCircle size={16} className="mr-2" /> Add New Asset</Button>
          </div>
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            {products.map((p: any) => (
              <div key={p.id} className="glass-card rounded-[2rem] overflow-hidden border-white/5 group relative">
                <div className="aspect-video relative bg-white/5">
                  {p.imageUrl ? <img src={p.imageUrl} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700" alt={p.name} /> : <div className="w-full h-full flex items-center justify-center opacity-20"><ShoppingBag size={32} /></div>}
                  <div className="absolute top-3 left-3"><Badge className="text-[6px] uppercase border-white/10 bg-black/40">{p.category}</Badge></div>
                  <button onClick={() => handleEditProduct(p)} className="absolute top-3 right-3 p-2 bg-black/60 rounded-lg text-primary opacity-0 group-hover:opacity-100 transition-opacity"><Edit3 size={14} /></button>
                </div>
                <div className="p-5 space-y-4">
                  <div>
                    <h4 className="text-[10px] font-headline font-bold uppercase truncate">{p.name}</h4>
                    <div className="text-lg font-headline font-black text-primary">${p.price || (p.variants && p.variants[0]?.price)}</div>
                  </div>
                  <div className="flex items-center justify-between pt-2 border-t border-white/5">
                    <Switch checked={p.isActive} onCheckedChange={(val) => toggleStatus('marketplace_services', p.id, val)} />
                    <button onClick={async () => { if(confirm("Purge asset?")) await deleteDoc(doc(db, 'marketplace_services', p.id)); }} className="p-2 text-red-500/40 hover:bg-red-500/10 rounded-lg hover:text-red-500 transition-all"><Trash2 size={14} /></button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </TabsContent>
      </Tabs>

      {/* Modals from original file */}
      <Dialog open={!!editingUserId} onOpenChange={() => setEditingUserId(null)}>
        <DialogContent className="max-w-sm glass-card border-white/10 p-8 rounded-[2rem] z-[1000]">
          <DialogHeader><DialogTitle className="text-xs font-headline font-bold tracking-widest uppercase text-center flex items-center justify-center gap-2"><Settings2 size={14} className="text-primary" /> Edit Entity Protocol</DialogTitle></DialogHeader>
          <div className="mt-6 space-y-6">
            <div className="space-y-2"><Label className="text-[8px] uppercase tracking-widest text-muted-foreground">Adjust Balance ($)</Label><Input type="number" className="h-12 bg-background border-white/10 rounded-xl font-headline text-lg text-primary text-center" value={editForm.balance} onChange={(e) => setEditForm({...editForm, balance: e.target.value})} /></div>
            <div className="space-y-2">
              <Label className="text-[8px] uppercase tracking-widest text-muted-foreground">Authority Role</Label>
              <Select value={editForm.role} onValueChange={(val) => setEditForm({...editForm, role: val})}>
                <SelectTrigger className="h-12 rounded-xl bg-background border-white/10"><SelectValue /></SelectTrigger>
                <SelectContent className="bg-card border-white/10 z-[1100]">
                  <SelectItem value="user">User</SelectItem><SelectItem value="agent">Agent</SelectItem><SelectItem value="admin">Admin</SelectItem>
                </SelectContent>
              </Select>
            </div>
            <div className="flex items-center justify-between p-5 bg-card/40 rounded-2xl border border-white/10" dir="ltr">
              <div className="space-y-1"><Label className="text-[10px] font-headline font-bold uppercase tracking-widest">Verified Entity</Label><p className="text-[7px] text-muted-foreground uppercase">Enable high-authority status</p></div>
              <Switch checked={editForm.verified} onCheckedChange={(val) => setEditForm({...editForm, verified: val})} className="data-[state=checked]:bg-green-500" />
            </div>
            <div className="pt-4 space-y-3">
              <Button onClick={async () => { try { await updateDoc(doc(db, 'users', editingUserId!), { balance: parseFloat(editForm.balance), role: editForm.role, verified: editForm.verified }); toast({ title: "SYNCED" }); setEditingUserId(null); } catch (e) {} }} className="w-full h-14 bg-primary text-background font-headline font-black text-[10px] tracking-widest rounded-xl gold-glow">Sync Changes</Button>
              <button onClick={() => setIsUserDeleteDialogOpen(true)} className="w-full py-3 flex items-center justify-center gap-2 text-red-500/60 hover:text-red-500 transition-all text-[8px] font-headline font-bold uppercase tracking-[0.2em]"><AlertTriangle size={14} /> Purge Entity</button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      <AlertDialog open={isUserDeleteDialogOpen} onOpenChange={setIsUserDeleteDialogOpen}>
        <AlertDialogContent className="glass-card border-white/10 rounded-[2rem] p-8 max-w-sm z-[2000]">
          <AlertDialogHeader>
            <AlertDialogTitle className="text-xs font-headline font-bold uppercase text-red-500 flex items-center gap-2"><AlertTriangle size={16} /> Critical Warning</AlertDialogTitle>
            <AlertDialogDescription className="text-[10px] font-headline uppercase leading-relaxed text-white/60">This action will permanently purge the entity from the ledger. Proceed?</AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter className="mt-6 flex flex-col gap-2">
            <AlertDialogAction onClick={handleDeleteUserEntity} className="bg-red-600 hover:bg-red-700 text-white rounded-xl h-12 font-headline font-black text-[10px] uppercase w-full">Confirm Purge</AlertDialogAction>
            <AlertDialogCancel className="bg-white/5 border-white/10 text-white rounded-xl h-12 font-headline font-bold text-[9px] uppercase w-full">Abort</AlertDialogCancel>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
}


--- START: /src/components/FirebaseErrorListener.tsx ---
'use client';

import { useEffect } from 'react';
import { errorEmitter } from '@/firebase/error-emitter';

export function FirebaseErrorListener() {
  useEffect(() => {
    const handlePermissionError = (error: Error) => {
      // In development, this will trigger the Next.js error overlay
      throw error;
    };

    errorEmitter.on('permission-error', handlePermissionError);
    return () => errorEmitter.off('permission-error', handlePermissionError);
  }, []);

  return null;
}


--- START: /src/components/layout/BottomNav.tsx ---

"use client"

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { Home, ArrowDownToLine, User, ScanLine, LayoutGrid, ShieldAlert, Briefcase } from 'lucide-react';
import { cn } from '@/lib/utils';
import { useStore } from '@/app/lib/store';
import { useMemo } from 'react';
import { useDoc, useUser, useFirestore } from '@/firebase';
import { doc } from 'firebase/firestore';

export function BottomNav() {
  const pathname = usePathname();
  const { language, setScannerOpen } = useStore();
  const { user } = useUser();
  const db = useFirestore();

  const userDocRef = useMemo(() => 
    (user && db) ? doc(db, 'users', user.uid) : null, 
    [db, user?.uid]
  );
  
  const { data: profile } = useDoc(userDocRef);

  // Added '/admin' and '/agent' to hiddenPaths to hide bottom navigation
  const hiddenPaths = ['/', '/register', '/onboarding', '/splash', '/otp', '/profile/edit', '/admin', '/agent'];
  const isHiddenPage = hiddenPaths.some(path => {
    const normalizedPath = pathname?.replace(/\/$/, '') || '/';
    const normalizedTarget = path.replace(/\/$/, '') || '/';
    return normalizedPath === normalizedTarget;
  });

  if (isHiddenPage) return null;

  const navItems = [
    { label: language === 'ar' ? 'الرئيسية' : 'HOME', icon: Home, href: '/dashboard' },
    { label: language === 'ar' ? 'الخدمات' : 'SERVICES', icon: LayoutGrid, href: '/marketplace' },
    { label: 'center', icon: ScanLine, href: '#' },
    { label: language === 'ar' ? 'سحب' : 'WITHDRAW', icon: ArrowDownToLine, href: '/withdraw' },
    { 
      label: profile?.role === 'admin' 
        ? (language === 'ar' ? 'الإدارة' : 'ADMIN') 
        : profile?.role === 'agent'
          ? (language === 'ar' ? 'الوكالة' : 'AGENT')
          : (language === 'ar' ? 'حسابي' : 'PROFILE'), 
      icon: profile?.role === 'admin' 
        ? ShieldAlert 
        : profile?.role === 'agent'
          ? Briefcase
          : User, 
      href: profile?.role === 'admin' 
        ? '/admin' 
        : profile?.role === 'agent'
          ? '/agent'
          : '/profile/edit' 
    },
  ];

  return (
    <nav className="fixed bottom-0 left-0 right-0 z-[100] px-4 pb-8 pt-2 pointer-events-none w-full">
      <div className="mx-auto max-w-lg rounded-[2.5rem] flex items-center justify-between py-2 px-1 border bg-card/80 backdrop-blur-2xl shadow-2xl border-white/5 pointer-events-auto">
        {navItems.map((item, idx) => {
          if (item.label === 'center') {
            return (
              <div key="center-container" className="flex-1 flex justify-center items-center">
                <button
                  onClick={(e) => {
                    e.preventDefault();
                    setScannerOpen(true);
                  }}
                  className="relative -top-10 w-16 h-16 shrink-0 rounded-[1.5rem] bg-primary flex items-center justify-center border-4 border-background hover:scale-105 transition-all duration-300 gold-glow active:scale-95"
                >
                  <ScanLine size={28} className="text-primary-foreground" />
                </button>
              </div>
            );
          }

          const isActive = pathname === item.href || pathname === `${item.href}/`;
          return (
            <div key={item.label + idx} className="flex-1 flex justify-center items-center">
              <Link
                href={item.href}
                className={cn(
                  "flex flex-col items-center justify-center gap-1.5 transition-all duration-300 rounded-2xl w-full max-w-[70px] h-16",
                  isActive 
                    ? "text-primary bg-primary/10" 
                    : "text-muted-foreground hover:text-foreground"
                )}
              >
                <item.icon size={20} />
                <span className="text-[8px] font-headline font-black tracking-[0.15em] uppercase text-center leading-none">
                  {item.label}
                </span>
              </Link>
            </div>
          );
        })}
      </div>
    </nav>
  );
}


--- START: /src/components/layout/LanguageHandler.tsx ---

"use client"

import { useEffect } from 'react';
import { useStore } from '@/app/lib/store';

export function LanguageHandler() {
  const store = useStore();

  useEffect(() => {
    if (typeof window !== 'undefined') {
      const lang = store.language || 'en';
      document.documentElement.lang = lang;
      document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
      
      if (lang === 'ar') {
        document.body.classList.add('font-arabic');
      } else {
        document.body.classList.remove('font-arabic');
      }
    }
  }, [store.language]);

  return null;
}


--- START: /src/components/layout/ThemeHandler.tsx ---

"use client"

import { useEffect } from 'react';
import { useUIStore } from '@/app/lib/store';

export function ThemeHandler() {
  const theme = useUIStore((state) => state.theme);

  useEffect(() => {
    const root = window.document.documentElement;
    root.classList.remove('light', 'dark');
    root.classList.add(theme);
  }, [theme]);

  return null;
}


--- START: /src/components/ui/input.tsx ---
import * as React from "react"

import { cn } from "@/lib/utils"

const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }


--- START: /src/components/ui/carousel.tsx ---
"use client"

import * as React from "react"
import useEmblaCarousel, {
  type UseEmblaCarouselType,
} from "embla-carousel-react"
import { ArrowLeft, ArrowRight } from "lucide-react"

import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"

type CarouselApi = UseEmblaCarouselType[1]
type UseCarouselParameters = Parameters<typeof useEmblaCarousel>
type CarouselOptions = UseCarouselParameters[0]
type CarouselPlugin = UseCarouselParameters[1]

type CarouselProps = {
  opts?: CarouselOptions
  plugins?: CarouselPlugin
  orientation?: "horizontal" | "vertical"
  setApi?: (api: CarouselApi) => void
}

type CarouselContextProps = {
  carouselRef: ReturnType<typeof useEmblaCarousel>[0]
  api: ReturnType<typeof useEmblaCarousel>[1]
  scrollPrev: () => void
  scrollNext: () => void
  canScrollPrev: boolean
  canScrollNext: boolean
} & CarouselProps

const CarouselContext = React.createContext<CarouselContextProps | null>(null)

function useCarousel() {
  const context = React.useContext(CarouselContext)

  if (!context) {
    throw new Error("useCarousel must be used within a <Carousel />")
  }

  return context
}

const Carousel = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & CarouselProps
>(
  (
    {
      orientation = "horizontal",
      opts,
      setApi,
      plugins,
      className,
      children,
      ...props
    },
    ref
  ) => {
    const [carouselRef, api] = useEmblaCarousel(
      {
        ...opts,
        axis: orientation === "horizontal" ? "x" : "y",
      },
      plugins
    )
    const [canScrollPrev, setCanScrollPrev] = React.useState(false)
    const [canScrollNext, setCanScrollNext] = React.useState(false)

    const onSelect = React.useCallback((api: CarouselApi) => {
      if (!api) {
        return
      }

      setCanScrollPrev(api.canScrollPrev())
      setCanScrollNext(api.canScrollNext())
    }, [])

    const scrollPrev = React.useCallback(() => {
      api?.scrollPrev()
    }, [api])

    const scrollNext = React.useCallback(() => {
      api?.scrollNext()
    }, [api])

    const handleKeyDown = React.useCallback(
      (event: React.KeyboardEvent<HTMLDivElement>) => {
        if (event.key === "ArrowLeft") {
          event.preventDefault()
          scrollPrev()
        } else if (event.key === "ArrowRight") {
          event.preventDefault()
          scrollNext()
        }
      },
      [scrollPrev, scrollNext]
    )

    React.useEffect(() => {
      if (!api || !setApi) {
        return
      }

      setApi(api)
    }, [api, setApi])

    React.useEffect(() => {
      if (!api) {
        return
      }

      onSelect(api)
      api.on("reInit", onSelect)
      api.on("select", onSelect)

      return () => {
        api?.off("select", onSelect)
      }
    }, [api, onSelect])

    return (
      <CarouselContext.Provider
        value={{
          carouselRef,
          api: api,
          opts,
          orientation:
            orientation || (opts?.axis === "y" ? "vertical" : "horizontal"),
          scrollPrev,
          scrollNext,
          canScrollPrev,
          canScrollNext,
        }}
      >
        <div
          ref={ref}
          onKeyDownCapture={handleKeyDown}
          className={cn("relative", className)}
          role="region"
          aria-roledescription="carousel"
          {...props}
        >
          {children}
        </div>
      </CarouselContext.Provider>
    )
  }
)
Carousel.displayName = "Carousel"

const CarouselContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const { carouselRef, orientation } = useCarousel()

  return (
    <div ref={carouselRef} className="overflow-hidden">
      <div
        ref={ref}
        className={cn(
          "flex",
          orientation === "horizontal" ? "-ml-4" : "-mt-4 flex-col",
          className
        )}
        {...props}
      />
    </div>
  )
})
CarouselContent.displayName = "CarouselContent"

const CarouselItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const { orientation } = useCarousel()

  return (
    <div
      ref={ref}
      role="group"
      aria-roledescription="slide"
      className={cn(
        "min-w-0 shrink-0 grow-0 basis-full",
        orientation === "horizontal" ? "pl-4" : "pt-4",
        className
      )}
      {...props}
    />
  )
})
CarouselItem.displayName = "CarouselItem"

const CarouselPrevious = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<typeof Button>
>(({ className, variant = "outline", size = "icon", ...props }, ref) => {
  const { orientation, scrollPrev, canScrollPrev } = useCarousel()

  return (
    <Button
      ref={ref}
      variant={variant}
      size={size}
      className={cn(
        "absolute  h-8 w-8 rounded-full",
        orientation === "horizontal"
          ? "-left-12 top-1/2 -translate-y-1/2"
          : "-top-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollPrev}
      onClick={scrollPrev}
      {...props}
    >
      <ArrowLeft className="h-4 w-4" />
      <span className="sr-only">Previous slide</span>
    </Button>
  )
})
CarouselPrevious.displayName = "CarouselPrevious"

const CarouselNext = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<typeof Button>
>(({ className, variant = "outline", size = "icon", ...props }, ref) => {
  const { orientation, scrollNext, canScrollNext } = useCarousel()

  return (
    <Button
      ref={ref}
      variant={variant}
      size={size}
      className={cn(
        "absolute h-8 w-8 rounded-full",
        orientation === "horizontal"
          ? "-right-12 top-1/2 -translate-y-1/2"
          : "-bottom-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollNext}
      onClick={scrollNext}
      {...props}
    >
      <ArrowRight className="h-4 w-4" />
      <span className="sr-only">Next slide</span>
    </Button>
  )
})
CarouselNext.displayName = "CarouselNext"

export {
  type CarouselApi,
  Carousel,
  CarouselContent,
  CarouselItem,
  CarouselPrevious,
  CarouselNext,
}


--- START: /src/components/ui/radio-group.tsx ---
"use client"

import * as React from "react"
import * as RadioGroupPrimitive from "@radix-ui/react-radio-group"
import { Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const RadioGroup = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Root
      className={cn("grid gap-2", className)}
      {...props}
      ref={ref}
    />
  )
})
RadioGroup.displayName = RadioGroupPrimitive.Root.displayName

const RadioGroupItem = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Item
      ref={ref}
      className={cn(
        "aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <RadioGroupPrimitive.Indicator className="flex items-center justify-center">
        <Circle className="h-2.5 w-2.5 fill-current text-current" />
      </RadioGroupPrimitive.Indicator>
    </RadioGroupPrimitive.Item>
  )
})
RadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName

export { RadioGroup, RadioGroupItem }


--- START: /src/components/ui/label.tsx ---
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const labelVariants = cva(
  "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
)

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
    VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(labelVariants(), className)}
    {...props}
  />
))
Label.displayName = LabelPrimitive.Root.displayName

export { Label }


--- START: /src/components/ui/slider.tsx ---
"use client"

import * as React from "react"
import * as SliderPrimitive from "@radix-ui/react-slider"

import { cn } from "@/lib/utils"

const Slider = React.forwardRef<
  React.ElementRef<typeof SliderPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>
>(({ className, ...props }, ref) => (
  <SliderPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex w-full touch-none select-none items-center",
      className
    )}
    {...props}
  >
    <SliderPrimitive.Track className="relative h-2 w-full grow overflow-hidden rounded-full bg-secondary">
      <SliderPrimitive.Range className="absolute h-full bg-primary" />
    </SliderPrimitive.Track>
    <SliderPrimitive.Thumb className="block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50" />
  </SliderPrimitive.Root>
))
Slider.displayName = SliderPrimitive.Root.displayName

export { Slider }


--- START: /src/components/ui/button.tsx ---
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground hover:bg-destructive/90",
        outline:
          "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-10 px-4 py-2",
        sm: "h-9 rounded-md px-3",
        lg: "h-11 rounded-md px-8",
        icon: "h-10 w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button"
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }


--- START: /src/components/ui/separator.tsx ---
"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

const Separator = React.forwardRef<
  React.ElementRef<typeof SeparatorPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
>(
  (
    { className, orientation = "horizontal", decorative = true, ...props },
    ref
  ) => (
    <SeparatorPrimitive.Root
      ref={ref}
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "shrink-0 bg-border",
        orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]",
        className
      )}
      {...props}
    />
  )
)
Separator.displayName = SeparatorPrimitive.Root.displayName

export { Separator }


--- START: /src/components/ui/tabs.tsx ---
"use client"

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

const Tabs = TabsPrimitive.Root

const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",
      className
    )}
    {...props}
  />
))
TabsList.displayName = TabsPrimitive.List.displayName

const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",
      className
    )}
    {...props}
  />
))
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName

const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className
    )}
    {...props}
  />
))
TabsContent.displayName = TabsPrimitive.Content.displayName

export { Tabs, TabsList, TabsTrigger, TabsContent }


--- START: /src/components/ui/collapsible.tsx ---
"use client"

import * as CollapsiblePrimitive from "@radix-ui/react-collapsible"

const Collapsible = CollapsiblePrimitive.Root

const CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger

const CollapsibleContent = CollapsiblePrimitive.CollapsibleContent

export { Collapsible, CollapsibleTrigger, CollapsibleContent }


--- START: /src/components/ui/checkbox.tsx ---
"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { Check } from "lucide-react"

import { cn } from "@/lib/utils"

const Checkbox = React.forwardRef<
  React.ElementRef<typeof CheckboxPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
>(({ className, ...props }, ref) => (
  <CheckboxPrimitive.Root
    ref={ref}
    className={cn(
      "peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",
      className
    )}
    {...props}
  >
    <CheckboxPrimitive.Indicator
      className={cn("flex items-center justify-center text-current")}
    >
      <Check className="h-4 w-4" />
    </CheckboxPrimitive.Indicator>
  </CheckboxPrimitive.Root>
))
Checkbox.displayName = CheckboxPrimitive.Root.displayName

export { Checkbox }


--- START: /src/components/ui/dropdown-menu.tsx ---
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const DropdownMenu = DropdownMenuPrimitive.Root

const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger

const DropdownMenuGroup = DropdownMenuPrimitive.Group

const DropdownMenuPortal = DropdownMenuPrimitive.Portal

const DropdownMenuSub = DropdownMenuPrimitive.Sub

const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup

const DropdownMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <DropdownMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto" />
  </DropdownMenuPrimitive.SubTrigger>
))
DropdownMenuSubTrigger.displayName =
  DropdownMenuPrimitive.SubTrigger.displayName

const DropdownMenuSubContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
DropdownMenuSubContent.displayName =
  DropdownMenuPrimitive.SubContent.displayName

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
))
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName

const DropdownMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <DropdownMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
))
DropdownMenuCheckboxItem.displayName =
  DropdownMenuPrimitive.CheckboxItem.displayName

const DropdownMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <DropdownMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
))
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName

const DropdownMenuLabel = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName

const DropdownMenuShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn("ml-auto text-xs tracking-widest opacity-60", className)}
      {...props}
    />
  )
}
DropdownMenuShortcut.displayName = "DropdownMenuShortcut"

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuRadioGroup,
}


--- START: /src/components/ui/tooltip.tsx ---
"use client"

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"

import { cn } from "@/lib/utils"

const TooltipProvider = TooltipPrimitive.Provider

const Tooltip = TooltipPrimitive.Root

const TooltipTrigger = TooltipPrimitive.Trigger

const TooltipContent = React.forwardRef<
  React.ElementRef<typeof TooltipPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <TooltipPrimitive.Content
    ref={ref}
    sideOffset={sideOffset}
    className={cn(
      "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
TooltipContent.displayName = TooltipPrimitive.Content.displayName

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }


--- START: /src/components/ui/progress.tsx ---
"use client"

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

const Progress = React.forwardRef<
  React.ElementRef<typeof ProgressPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>
>(({ className, value, ...props }, ref) => (
  <ProgressPrimitive.Root
    ref={ref}
    className={cn(
      "relative h-4 w-full overflow-hidden rounded-full bg-secondary",
      className
    )}
    {...props}
  >
    <ProgressPrimitive.Indicator
      className="h-full w-full flex-1 bg-primary transition-all"
      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
    />
  </ProgressPrimitive.Root>
))
Progress.displayName = ProgressPrimitive.Root.displayName

export { Progress }


--- START: /src/components/ui/LanguageToggle.tsx ---
"use client"

import { useStore } from '@/app/lib/store';
import { Button } from '@/components/ui/button';
import { Languages } from 'lucide-react';

export function LanguageToggle() {
  const { language, toggleLanguage } = useStore();
  
  return (
    <Button 
      variant="ghost" 
      size="sm" 
      onClick={toggleLanguage}
      className="text-[10px] font-headline font-bold tracking-widest uppercase text-primary hover:bg-primary/10"
    >
      <Languages className="h-4 w-4 mr-2" />
      {language === 'ar' ? 'English' : 'العربية'}
    </Button>
  );
}


--- START: /src/components/ui/toast.tsx ---
"use client"

import * as React from "react"
import * as ToastPrimitives from "@radix-ui/react-toast"
import { cva, type VariantProps } from "class-variance-authority"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const ToastProvider = ToastPrimitives.Provider

const ToastViewport = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Viewport>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Viewport
    ref={ref}
    className={cn(
      "fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]",
      className
    )}
    {...props}
  />
))
ToastViewport.displayName = ToastPrimitives.Viewport.displayName

const toastVariants = cva(
  "group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full",
  {
    variants: {
      variant: {
        default: "border bg-background text-foreground",
        destructive:
          "destructive group border-destructive bg-destructive text-destructive-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Toast = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &
    VariantProps<typeof toastVariants>
>(({ className, variant, ...props }, ref) => {
  return (
    <ToastPrimitives.Root
      ref={ref}
      className={cn(toastVariants({ variant }), className)}
      {...props}
    />
  )
})
Toast.displayName = ToastPrimitives.Root.displayName

const ToastAction = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Action>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Action
    ref={ref}
    className={cn(
      "inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive",
      className
    )}
    {...props}
  />
))
ToastAction.displayName = ToastPrimitives.Action.displayName

const ToastClose = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Close>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Close
    ref={ref}
    className={cn(
      "absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600",
      className
    )}
    toast-close=""
    {...props}
  >
    <X className="h-4 w-4" />
  </ToastPrimitives.Close>
))
ToastClose.displayName = ToastPrimitives.Close.displayName

const ToastTitle = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Title>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Title
    ref={ref}
    className={cn("text-sm font-semibold", className)}
    {...props}
  />
))
ToastTitle.displayName = ToastPrimitives.Title.displayName

const ToastDescription = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Description>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Description
    ref={ref}
    className={cn("text-sm opacity-90", className)}
    {...props}
  />
))
ToastDescription.displayName = ToastPrimitives.Description.displayName

type ToastProps = React.ComponentPropsWithoutRef<typeof Toast>

type ToastActionElement = React.ReactElement<typeof ToastAction>

export {
  type ToastProps,
  type ToastActionElement,
  ToastProvider,
  ToastViewport,
  Toast,
  ToastTitle,
  ToastDescription,
  ToastClose,
  ToastAction,
}


--- START: /src/components/ui/ThemeToggle.tsx ---
"use client"

import { useStore } from '@/app/lib/store';
import { cn } from '@/lib/utils';
import { Sun, Moon } from 'lucide-react';

export function ThemeToggle() {
  const { theme, toggleTheme, language } = useStore();
  
  return (
    <button 
      onClick={toggleTheme}
      className="w-full h-14 glass-card rounded-2xl flex items-center justify-between px-6 hover:border-primary transition-all group"
    >
      <div className="flex items-center gap-4">
        {theme === 'dark' ? (
          <Moon size={18} className="text-secondary" />
        ) : (
          <Sun size={18} className="text-primary" />
        )}
        <span className="text-[10px] font-headline font-bold uppercase tracking-widest">
          {language === 'ar' 
            ? (theme === 'dark' ? 'الوضع الليلي' : 'الوضع النهاري') 
            : (theme === 'dark' ? 'DARK PROTOCOL' : 'LIGHT PROTOCOL')}
        </span>
      </div>
      {/* Forced LTR direction for the toggle track to prevent RTL flip issues */}
      <div className="w-10 h-6 bg-muted rounded-full relative p-1 transition-colors group-hover:bg-primary/20 flex items-center" dir="ltr">
        <div className={cn(
          "w-4 h-4 rounded-full transition-all duration-300 shadow-sm",
          theme === 'dark' ? "bg-secondary translate-x-4" : "bg-primary translate-x-0"
        )} />
      </div>
    </button>
  );
}

--- START: /src/components/ui/skeleton.tsx ---
import { cn } from "@/lib/utils"

function Skeleton({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) {
  return (
    <div
      className={cn("animate-pulse rounded-md bg-muted", className)}
      {...props}
    />
  )
}

export { Skeleton }


--- START: /src/components/ui/textarea.tsx ---
import * as React from 'react';

import {cn} from '@/lib/utils';

const Textarea = React.forwardRef<HTMLTextAreaElement, React.ComponentProps<'textarea'>>(
  ({className, ...props}, ref) => {
    return (
      <textarea
        className={cn(
          'flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm',
          className
        )}
        ref={ref}
        {...props}
      />
    );
  }
);
Textarea.displayName = 'Textarea';

export {Textarea};


--- START: /src/components/ui/avatar.tsx ---
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

const Avatar = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",
      className
    )}
    {...props}
  />
))
Avatar.displayName = AvatarPrimitive.Root.displayName

const AvatarImage = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Image>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Image
    ref={ref}
    className={cn("aspect-square h-full w-full", className)}
    {...props}
  />
))
AvatarImage.displayName = AvatarPrimitive.Image.displayName

const AvatarFallback = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Fallback>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Fallback
    ref={ref}
    className={cn(
      "flex h-full w-full items-center justify-center rounded-full bg-muted",
      className
    )}
    {...props}
  />
))
AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName

export { Avatar, AvatarImage, AvatarFallback }


--- START: /src/components/ui/popover.tsx ---
"use client"

import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"

import { cn } from "@/lib/utils"

const Popover = PopoverPrimitive.Root

const PopoverTrigger = PopoverPrimitive.Trigger

const PopoverContent = React.forwardRef<
  React.ElementRef<typeof PopoverPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <PopoverPrimitive.Portal>
    <PopoverPrimitive.Content
      ref={ref}
      align={align}
      sideOffset={sideOffset}
      className={cn(
        "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </PopoverPrimitive.Portal>
))
PopoverContent.displayName = PopoverPrimitive.Content.displayName

export { Popover, PopoverTrigger, PopoverContent }


--- START: /src/components/ui/alert.tsx ---
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",
  {
    variants: {
      variant: {
        default: "bg-background text-foreground",
        destructive:
          "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Alert = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>
>(({ className, variant, ...props }, ref) => (
  <div
    ref={ref}
    role="alert"
    className={cn(alertVariants({ variant }), className)}
    {...props}
  />
))
Alert.displayName = "Alert"

const AlertTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h5
    ref={ref}
    className={cn("mb-1 font-medium leading-none tracking-tight", className)}
    {...props}
  />
))
AlertTitle.displayName = "AlertTitle"

const AlertDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm [&_p]:leading-relaxed", className)}
    {...props}
  />
))
AlertDescription.displayName = "AlertDescription"

export { Alert, AlertTitle, AlertDescription }


--- START: /src/components/ui/table.tsx ---
import * as React from "react"

import { cn } from "@/lib/utils"

const Table = React.forwardRef<
  HTMLTableElement,
  React.HTMLAttributes<HTMLTableElement>
>(({ className, ...props }, ref) => (
  <div className="relative w-full overflow-auto">
    <table
      ref={ref}
      className={cn("w-full caption-bottom text-sm", className)}
      {...props}
    />
  </div>
))
Table.displayName = "Table"

const TableHeader = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />
))
TableHeader.displayName = "TableHeader"

const TableBody = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tbody
    ref={ref}
    className={cn("[&_tr:last-child]:border-0", className)}
    {...props}
  />
))
TableBody.displayName = "TableBody"

const TableFooter = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tfoot
    ref={ref}
    className={cn(
      "border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",
      className
    )}
    {...props}
  />
))
TableFooter.displayName = "TableFooter"

const TableRow = React.forwardRef<
  HTMLTableRowElement,
  React.HTMLAttributes<HTMLTableRowElement>
>(({ className, ...props }, ref) => (
  <tr
    ref={ref}
    className={cn(
      "border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",
      className
    )}
    {...props}
  />
))
TableRow.displayName = "TableRow"

const TableHead = React.forwardRef<
  HTMLTableCellElement,
  React.ThHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <th
    ref={ref}
    className={cn(
      "h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",
      className
    )}
    {...props}
  />
))
TableHead.displayName = "TableHead"

const TableCell = React.forwardRef<
  HTMLTableCellElement,
  React.TdHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <td
    ref={ref}
    className={cn("p-4 align-middle [&:has([role=checkbox])]:pr-0", className)}
    {...props}
  />
))
TableCell.displayName = "TableCell"

const TableCaption = React.forwardRef<
  HTMLTableCaptionElement,
  React.HTMLAttributes<HTMLTableCaptionElement>
>(({ className, ...props }, ref) => (
  <caption
    ref={ref}
    className={cn("mt-4 text-sm text-muted-foreground", className)}
    {...props}
  />
))
TableCaption.displayName = "TableCaption"

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}


--- START: /src/components/ui/card.tsx ---
import * as React from "react"

import { cn } from "@/lib/utils"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-lg border bg-card text-card-foreground shadow-sm",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "text-2xl font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }


--- START: /src/components/ui/calendar.tsx ---
"use client"

import * as React from "react"
import { ChevronLeft, ChevronRight } from "lucide-react"
import { DayPicker } from "react-day-picker"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

export type CalendarProps = React.ComponentProps<typeof DayPicker>

function Calendar({
  className,
  classNames,
  showOutsideDays = true,
  ...props
}: CalendarProps) {
  return (
    <DayPicker
      showOutsideDays={showOutsideDays}
      className={cn("p-3", className)}
      classNames={{
        months: "flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",
        month: "space-y-4",
        caption: "flex justify-center pt-1 relative items-center",
        caption_label: "text-sm font-medium",
        nav: "space-x-1 flex items-center",
        nav_button: cn(
          buttonVariants({ variant: "outline" }),
          "h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100"
        ),
        nav_button_previous: "absolute left-1",
        nav_button_next: "absolute right-1",
        table: "w-full border-collapse space-y-1",
        head_row: "flex",
        head_cell:
          "text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]",
        row: "flex w-full mt-2",
        cell: "h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",
        day: cn(
          buttonVariants({ variant: "ghost" }),
          "h-9 w-9 p-0 font-normal aria-selected:opacity-100"
        ),
        day_range_end: "day-range-end",
        day_selected:
          "bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",
        day_today: "bg-accent text-accent-foreground",
        day_outside:
          "day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground",
        day_disabled: "text-muted-foreground opacity-50",
        day_range_middle:
          "aria-selected:bg-accent aria-selected:text-accent-foreground",
        day_hidden: "invisible",
        ...classNames,
      }}
      components={{
        IconLeft: ({ className, ...props }) => (
          <ChevronLeft className={cn("h-4 w-4", className)} {...props} />
        ),
        IconRight: ({ className, ...props }) => (
          <ChevronRight className={cn("h-4 w-4", className)} {...props} />
        ),
      }}
      {...props}
    />
  )
}
Calendar.displayName = "Calendar"

export { Calendar }


--- START: /src/components/ui/dialog.tsx ---
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Dialog = DialogPrimitive.Root

const DialogTrigger = DialogPrimitive.Trigger

const DialogPortal = DialogPrimitive.Portal

const DialogClose = DialogPrimitive.Close

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
  />
))
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    >
      {children}
      <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
))
DialogContent.displayName = DialogPrimitive.Content.displayName

const DialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-1.5 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
DialogHeader.displayName = "DialogHeader"

const DialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
DialogFooter.displayName = "DialogFooter"

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
DialogTitle.displayName = DialogPrimitive.Title.displayName

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DialogDescription.displayName = DialogPrimitive.Description.displayName

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogClose,
  DialogTrigger,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
}


--- START: /src/components/ui/accordion.tsx ---
"use client"

import * as React from "react"
import * as AccordionPrimitive from "@radix-ui/react-accordion"
import { ChevronDown } from "lucide-react"

import { cn } from "@/lib/utils"

const Accordion = AccordionPrimitive.Root

const AccordionItem = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>
>(({ className, ...props }, ref) => (
  <AccordionPrimitive.Item
    ref={ref}
    className={cn("border-b", className)}
    {...props}
  />
))
AccordionItem.displayName = "AccordionItem"

const AccordionTrigger = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Header className="flex">
    <AccordionPrimitive.Trigger
      ref={ref}
      className={cn(
        "flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180",
        className
      )}
      {...props}
    >
      {children}
      <ChevronDown className="h-4 w-4 shrink-0 transition-transform duration-200" />
    </AccordionPrimitive.Trigger>
  </AccordionPrimitive.Header>
))
AccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName

const AccordionContent = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Content
    ref={ref}
    className="overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down"
    {...props}
  >
    <div className={cn("pb-4 pt-0", className)}>{children}</div>
  </AccordionPrimitive.Content>
))

AccordionContent.displayName = AccordionPrimitive.Content.displayName

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }


--- START: /src/components/ui/form.tsx ---
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { Slot } from "@radix-ui/react-slot"
import {
  Controller,
  FormProvider,
  useFormContext,
  type ControllerProps,
  type FieldPath,
  type FieldValues,
} from "react-hook-form"

import { cn } from "@/lib/utils"
import { Label } from "@/components/ui/label"

const Form = FormProvider

type FormFieldContextValue<
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
> = {
  name: TName
}

const FormFieldContext = React.createContext<FormFieldContextValue>(
  {} as FormFieldContextValue
)

const FormField = <
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
>({
  ...props
}: ControllerProps<TFieldValues, TName>) => {
  return (
    <FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>
  )
}

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext)
  const itemContext = React.useContext(FormItemContext)
  const { getFieldState, formState } = useFormContext()

  const fieldState = getFieldState(fieldContext.name, formState)

  if (!fieldContext) {
    throw new Error("useFormField should be used within <FormField>")
  }

  const { id } = itemContext

  return {
    id,
    name: fieldContext.name,
    formItemId: `${id}-form-item`,
    formDescriptionId: `${id}-form-item-description`,
    formMessageId: `${id}-form-item-message`,
    ...fieldState,
  }
}

type FormItemContextValue = {
  id: string
}

const FormItemContext = React.createContext<FormItemContextValue>(
  {} as FormItemContextValue
)

const FormItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const id = React.useId()

  return (
    <FormItemContext.Provider value={{ id }}>
      <div ref={ref} className={cn("space-y-2", className)} {...props} />
    </FormItemContext.Provider>
  )
})
FormItem.displayName = "FormItem"

const FormLabel = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>
>(({ className, ...props }, ref) => {
  const { error, formItemId } = useFormField()

  return (
    <Label
      ref={ref}
      className={cn(error && "text-destructive", className)}
      htmlFor={formItemId}
      {...props}
    />
  )
})
FormLabel.displayName = "FormLabel"

const FormControl = React.forwardRef<
  React.ElementRef<typeof Slot>,
  React.ComponentPropsWithoutRef<typeof Slot>
>(({ ...props }, ref) => {
  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()

  return (
    <Slot
      ref={ref}
      id={formItemId}
      aria-describedby={
        !error
          ? `${formDescriptionId}`
          : `${formDescriptionId} ${formMessageId}`
      }
      aria-invalid={!!error}
      {...props}
    />
  )
})
FormControl.displayName = "FormControl"

const FormDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => {
  const { formDescriptionId } = useFormField()

  return (
    <p
      ref={ref}
      id={formDescriptionId}
      className={cn("text-sm text-muted-foreground", className)}
      {...props}
    />
  )
})
FormDescription.displayName = "FormDescription"

const FormMessage = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, children, ...props }, ref) => {
  const { error, formMessageId } = useFormField()
  const body = error ? String(error?.message ?? "") : children

  if (!body) {
    return null
  }

  return (
    <p
      ref={ref}
      id={formMessageId}
      className={cn("text-sm font-medium text-destructive", className)}
      {...props}
    >
      {body}
    </p>
  )
})
FormMessage.displayName = "FormMessage"

export {
  useFormField,
  Form,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
  FormField,
}


--- START: /src/components/ui/alert-dialog.tsx ---
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

const AlertDialog = AlertDialogPrimitive.Root

const AlertDialogTrigger = AlertDialogPrimitive.Trigger

const AlertDialogPortal = AlertDialogPrimitive.Portal

const AlertDialogOverlay = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
AlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName

const AlertDialogContent = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>
>(({ className, ...props }, ref) => (
  <AlertDialogPortal>
    <AlertDialogOverlay />
    <AlertDialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    />
  </AlertDialogPortal>
))
AlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName

const AlertDialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
AlertDialogHeader.displayName = "AlertDialogHeader"

const AlertDialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
AlertDialogFooter.displayName = "AlertDialogFooter"

const AlertDialogTitle = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold", className)}
    {...props}
  />
))
AlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName

const AlertDialogDescription = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
AlertDialogDescription.displayName =
  AlertDialogPrimitive.Description.displayName

const AlertDialogAction = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Action>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Action
    ref={ref}
    className={cn(buttonVariants(), className)}
    {...props}
  />
))
AlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName

const AlertDialogCancel = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Cancel
    ref={ref}
    className={cn(
      buttonVariants({ variant: "outline" }),
      "mt-2 sm:mt-0",
      className
    )}
    {...props}
  />
))
AlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}


--- START: /src/components/ui/toaster.tsx ---
"use client"

import { useToast } from "@/hooks/use-toast"
import {
  Toast,
  ToastClose,
  ToastDescription,
  ToastProvider,
  ToastTitle,
  ToastViewport,
} from "@/components/ui/toast"

export function Toaster() {
  const { toasts } = useToast()

  return (
    <ToastProvider>
      {toasts.map(function ({ id, title, description, action, ...props }) {
        return (
          <Toast key={id} {...props}>
            <div className="grid gap-1">
              {title && <ToastTitle>{title}</ToastTitle>}
              {description && (
                <ToastDescription>{description}</ToastDescription>
              )}
            </div>
            {action}
            <ToastClose />
          </Toast>
        )
      })}
      <ToastViewport />
    </ToastProvider>
  )
}


--- START: /src/components/ui/chart.tsx ---
"use client"

import * as React from "react"
import * as RechartsPrimitive from "recharts"

import { cn } from "@/lib/utils"

// Format: { THEME_NAME: CSS_SELECTOR }
const THEMES = { light: "", dark: ".dark" } as const

export type ChartConfig = {
  [k in string]: {
    label?: React.ReactNode
    icon?: React.ComponentType
  } & (
    | { color?: string; theme?: never }
    | { color?: never; theme: Record<keyof typeof THEMES, string> }
  )
}

type ChartContextProps = {
  config: ChartConfig
}

const ChartContext = React.createContext<ChartContextProps | null>(null)

function useChart() {
  const context = React.useContext(ChartContext)

  if (!context) {
    throw new Error("useChart must be used within a <ChartContainer />")
  }

  return context
}

const ChartContainer = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    config: ChartConfig
    children: React.ComponentProps<
      typeof RechartsPrimitive.ResponsiveContainer
    >["children"]
  }
>(({ id, className, children, config, ...props }, ref) => {
  const uniqueId = React.useId()
  const chartId = `chart-${id || uniqueId.replace(/:/g, "")}`

  return (
    <ChartContext.Provider value={{ config }}>
      <div
        data-chart={chartId}
        ref={ref}
        className={cn(
          "flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none",
          className
        )}
        {...props}
      >
        <ChartStyle id={chartId} config={config} />
        <RechartsPrimitive.ResponsiveContainer>
          {children}
        </RechartsPrimitive.ResponsiveContainer>
      </div>
    </ChartContext.Provider>
  )
})
ChartContainer.displayName = "Chart"

const ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {
  const colorConfig = Object.entries(config).filter(
    ([, config]) => config.theme || config.color
  )

  if (!colorConfig.length) {
    return null
  }

  return (
    <style
      dangerouslySetInnerHTML={{
        __html: Object.entries(THEMES)
          .map(
            ([theme, prefix]) => `
${prefix} [data-chart=${id}] {
${colorConfig
  .map(([key, itemConfig]) => {
    const color =
      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||
      itemConfig.color
    return color ? `  --color-${key}: ${color};` : null
  })
  .join("\n")}
}
`
          )
          .join("\n"),
      }}
    />
  )
}

const ChartTooltip = RechartsPrimitive.Tooltip

const ChartTooltipContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &
    React.ComponentProps<"div"> & {
      hideLabel?: boolean
      hideIndicator?: boolean
      indicator?: "line" | "dot" | "dashed"
      nameKey?: string
      labelKey?: string
    }
>(
  (
    {
      active,
      payload,
      className,
      indicator = "dot",
      hideLabel = false,
      hideIndicator = false,
      label,
      labelFormatter,
      labelClassName,
      formatter,
      color,
      nameKey,
      labelKey,
    },
    ref
  ) => {
    const { config } = useChart()

    const tooltipLabel = React.useMemo(() => {
      if (hideLabel || !payload?.length) {
        return null
      }

      const [item] = payload
      const key = `${labelKey || item.dataKey || item.name || "value"}`
      const itemConfig = getPayloadConfigFromPayload(config, item, key)
      const value =
        !labelKey && typeof label === "string"
          ? config[label as keyof typeof config]?.label || label
          : itemConfig?.label

      if (labelFormatter) {
        return (
          <div className={cn("font-medium", labelClassName)}>
            {labelFormatter(value, payload)}
          </div>
        )
      }

      if (!value) {
        return null
      }

      return <div className={cn("font-medium", labelClassName)}>{value}</div>
    }, [
      label,
      labelFormatter,
      payload,
      hideLabel,
      labelClassName,
      config,
      labelKey,
    ])

    if (!active || !payload?.length) {
      return null
    }

    const nestLabel = payload.length === 1 && indicator !== "dot"

    return (
      <div
        ref={ref}
        className={cn(
          "grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl",
          className
        )}
      >
        {!nestLabel ? tooltipLabel : null}
        <div className="grid gap-1.5">
          {payload.map((item, index) => {
            const key = `${nameKey || item.name || item.dataKey || "value"}`
            const itemConfig = getPayloadConfigFromPayload(config, item, key)
            const indicatorColor = color || item.payload.fill || item.color

            return (
              <div
                key={item.dataKey}
                className={cn(
                  "flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground",
                  indicator === "dot" && "items-center"
                )}
              >
                {formatter && item?.value !== undefined && item.name ? (
                  formatter(item.value, item.name, item, index, item.payload)
                ) : (
                  <>
                    {itemConfig?.icon ? (
                      <itemConfig.icon />
                    ) : (
                      !hideIndicator && (
                        <div
                          className={cn(
                            "shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]",
                            {
                              "h-2.5 w-2.5": indicator === "dot",
                              "w-1": indicator === "line",
                              "w-0 border-[1.5px] border-dashed bg-transparent":
                                indicator === "dashed",
                              "my-0.5": nestLabel && indicator === "dashed",
                            }
                          )}
                          style={
                            {
                              "--color-bg": indicatorColor,
                              "--color-border": indicatorColor,
                            } as React.CSSProperties
                          }
                        />
                      )
                    )}
                    <div
                      className={cn(
                        "flex flex-1 justify-between leading-none",
                        nestLabel ? "items-end" : "items-center"
                      )}
                    >
                      <div className="grid gap-1.5">
                        {nestLabel ? tooltipLabel : null}
                        <span className="text-muted-foreground">
                          {itemConfig?.label || item.name}
                        </span>
                      </div>
                      {item.value && (
                        <span className="font-mono font-medium tabular-nums text-foreground">
                          {item.value.toLocaleString()}
                        </span>
                      )}
                    </div>
                  </>
                )}
              </div>
            )
          })}
        </div>
      </div>
    )
  }
)
ChartTooltipContent.displayName = "ChartTooltip"

const ChartLegend = RechartsPrimitive.Legend

const ChartLegendContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> &
    Pick<RechartsPrimitive.LegendProps, "payload" | "verticalAlign"> & {
      hideIcon?: boolean
      nameKey?: string
    }
>(
  (
    { className, hideIcon = false, payload, verticalAlign = "bottom", nameKey },
    ref
  ) => {
    const { config } = useChart()

    if (!payload?.length) {
      return null
    }

    return (
      <div
        ref={ref}
        className={cn(
          "flex items-center justify-center gap-4",
          verticalAlign === "top" ? "pb-3" : "pt-3",
          className
        )}
      >
        {payload.map((item) => {
          const key = `${nameKey || item.dataKey || "value"}`
          const itemConfig = getPayloadConfigFromPayload(config, item, key)

          return (
            <div
              key={item.value}
              className={cn(
                "flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground"
              )}
            >
              {itemConfig?.icon && !hideIcon ? (
                <itemConfig.icon />
              ) : (
                <div
                  className="h-2 w-2 shrink-0 rounded-[2px]"
                  style={{
                    backgroundColor: item.color,
                  }}
                />
              )}
              {itemConfig?.label}
            </div>
          )
        })}
      </div>
    )
  }
)
ChartLegendContent.displayName = "ChartLegend"

// Helper to extract item config from a payload.
function getPayloadConfigFromPayload(
  config: ChartConfig,
  payload: unknown,
  key: string
) {
  if (typeof payload !== "object" || payload === null) {
    return undefined
  }

  const payloadPayload =
    "payload" in payload &&
    typeof payload.payload === "object" &&
    payload.payload !== null
      ? payload.payload
      : undefined

  let configLabelKey: string = key

  if (
    key in payload &&
    typeof payload[key as keyof typeof payload] === "string"
  ) {
    configLabelKey = payload[key as keyof typeof payload] as string
  } else if (
    payloadPayload &&
    key in payloadPayload &&
    typeof payloadPayload[key as keyof typeof payloadPayload] === "string"
  ) {
    configLabelKey = payloadPayload[
      key as keyof typeof payloadPayload
    ] as string
  }

  return configLabelKey in config
    ? config[configLabelKey]
    : config[key as keyof typeof config]
}

export {
  ChartContainer,
  ChartTooltip,
  ChartTooltipContent,
  ChartLegend,
  ChartLegendContent,
  ChartStyle,
}


--- START: /src/components/ui/sheet.tsx ---
"use client"

import * as React from "react"
import * as SheetPrimitive from "@radix-ui/react-dialog"
import { cva, type VariantProps } from "class-variance-authority"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Sheet = SheetPrimitive.Root

const SheetTrigger = SheetPrimitive.Trigger

const SheetClose = SheetPrimitive.Close

const SheetPortal = SheetPrimitive.Portal

const SheetOverlay = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
SheetOverlay.displayName = SheetPrimitive.Overlay.displayName

const sheetVariants = cva(
  "fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
  {
    variants: {
      side: {
        top: "inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",
        bottom:
          "inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",
        left: "inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",
        right:
          "inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm",
      },
    },
    defaultVariants: {
      side: "right",
    },
  }
)

interface SheetContentProps
  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,
    VariantProps<typeof sheetVariants> {}

const SheetContent = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Content>,
  SheetContentProps
>(({ side = "right", className, children, ...props }, ref) => (
  <SheetPortal>
    <SheetOverlay />
    <SheetPrimitive.Content
      ref={ref}
      className={cn(sheetVariants({ side }), className)}
      {...props}
    >
      {children}
      <SheetPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </SheetPrimitive.Close>
    </SheetPrimitive.Content>
  </SheetPortal>
))
SheetContent.displayName = SheetPrimitive.Content.displayName

const SheetHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
SheetHeader.displayName = "SheetHeader"

const SheetFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
SheetFooter.displayName = "SheetFooter"

const SheetTitle = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold text-foreground", className)}
    {...props}
  />
))
SheetTitle.displayName = SheetPrimitive.Title.displayName

const SheetDescription = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
SheetDescription.displayName = SheetPrimitive.Description.displayName

export {
  Sheet,
  SheetPortal,
  SheetOverlay,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
}


--- START: /src/components/ui/switch.tsx ---
"use client"

import * as React from "react"
import * as SwitchPrimitives from "@radix-ui/react-switch"

import { cn } from "@/lib/utils"

const Switch = React.forwardRef<
  React.ElementRef<typeof SwitchPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>
>(({ className, ...props }, ref) => (
  <SwitchPrimitives.Root
    className={cn(
      "peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",
      className
    )}
    {...props}
    ref={ref}
  >
    <SwitchPrimitives.Thumb
      className={cn(
        "pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0"
      )}
    />
  </SwitchPrimitives.Root>
))
Switch.displayName = SwitchPrimitives.Root.displayName

export { Switch }


--- START: /src/components/ui/scroll-area.tsx ---
"use client"

import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

const ScrollArea = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <ScrollAreaPrimitive.Root
    ref={ref}
    className={cn("relative overflow-hidden", className)}
    {...props}
  >
    <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">
      {children}
    </ScrollAreaPrimitive.Viewport>
    <ScrollBar />
    <ScrollAreaPrimitive.Corner />
  </ScrollAreaPrimitive.Root>
))
ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName

const ScrollBar = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>
>(({ className, orientation = "vertical", ...props }, ref) => (
  <ScrollAreaPrimitive.ScrollAreaScrollbar
    ref={ref}
    orientation={orientation}
    className={cn(
      "flex touch-none select-none transition-colors",
      orientation === "vertical" &&
        "h-full w-2.5 border-l border-l-transparent p-[1px]",
      orientation === "horizontal" &&
        "h-2.5 flex-col border-t border-t-transparent p-[1px]",
      className
    )}
    {...props}
  >
    <ScrollAreaPrimitive.ScrollAreaThumb className="relative flex-1 rounded-full bg-border" />
  </ScrollAreaPrimitive.ScrollAreaScrollbar>
))
ScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName

export { ScrollArea, ScrollBar }


--- START: /src/components/ui/badge.tsx ---
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive:
          "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
        outline: "text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  )
}

export { Badge, badgeVariants }


--- START: /src/components/ui/sidebar.tsx ---
"use client"

import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { VariantProps, cva } from "class-variance-authority"
import { PanelLeft } from "lucide-react"

import { useIsMobile } from "@/hooks/use-mobile"
import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Separator } from "@/components/ui/separator"
import { Sheet, SheetContent } from "@/components/ui/sheet"
import { Skeleton } from "@/components/ui/skeleton"
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip"

const SIDEBAR_COOKIE_NAME = "sidebar_state"
const SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7
const SIDEBAR_WIDTH = "16rem"
const SIDEBAR_WIDTH_MOBILE = "18rem"
const SIDEBAR_WIDTH_ICON = "3rem"
const SIDEBAR_KEYBOARD_SHORTCUT = "b"

type SidebarContext = {
  state: "expanded" | "collapsed"
  open: boolean
  setOpen: (open: boolean) => void
  openMobile: boolean
  setOpenMobile: (open: boolean) => void
  isMobile: boolean
  toggleSidebar: () => void
}

const SidebarContext = React.createContext<SidebarContext | null>(null)

function useSidebar() {
  const context = React.useContext(SidebarContext)
  if (!context) {
    throw new Error("useSidebar must be used within a SidebarProvider.")
  }

  return context
}

const SidebarProvider = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    defaultOpen?: boolean
    open?: boolean
    onOpenChange?: (open: boolean) => void
  }
>(
  (
    {
      defaultOpen = true,
      open: openProp,
      onOpenChange: setOpenProp,
      className,
      style,
      children,
      ...props
    },
    ref
  ) => {
    const isMobile = useIsMobile()
    const [openMobile, setOpenMobile] = React.useState(false)

    // This is the internal state of the sidebar.
    // We use openProp and setOpenProp for control from outside the component.
    const [_open, _setOpen] = React.useState(defaultOpen)
    const open = openProp ?? _open
    const setOpen = React.useCallback(
      (value: boolean | ((value: boolean) => boolean)) => {
        const openState = typeof value === "function" ? value(open) : value
        if (setOpenProp) {
          setOpenProp(openState)
        } else {
          _setOpen(openState)
        }

        // This sets the cookie to keep the sidebar state.
        document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`
      },
      [setOpenProp, open]
    )

    // Helper to toggle the sidebar.
    const toggleSidebar = React.useCallback(() => {
      return isMobile
        ? setOpenMobile((open) => !open)
        : setOpen((open) => !open)
    }, [isMobile, setOpen, setOpenMobile])

    // Adds a keyboard shortcut to toggle the sidebar.
    React.useEffect(() => {
      const handleKeyDown = (event: KeyboardEvent) => {
        if (
          event.key === SIDEBAR_KEYBOARD_SHORTCUT &&
          (event.metaKey || event.ctrlKey)
        ) {
          event.preventDefault()
          toggleSidebar()
        }
      }

      window.addEventListener("keydown", handleKeyDown)
      return () => window.removeEventListener("keydown", handleKeyDown)
    }, [toggleSidebar])

    // We add a state so that we can do data-state="expanded" or "collapsed".
    // This makes it easier to style the sidebar with Tailwind classes.
    const state = open ? "expanded" : "collapsed"

    const contextValue = React.useMemo<SidebarContext>(
      () => ({
        state,
        open,
        setOpen,
        isMobile,
        openMobile,
        setOpenMobile,
        toggleSidebar,
      }),
      [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]
    )

    return (
      <SidebarContext.Provider value={contextValue}>
        <TooltipProvider delayDuration={0}>
          <div
            style={
              {
                "--sidebar-width": SIDEBAR_WIDTH,
                "--sidebar-width-icon": SIDEBAR_WIDTH_ICON,
                ...style,
              } as React.CSSProperties
            }
            className={cn(
              "group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar",
              className
            )}
            ref={ref}
            {...props}
          >
            {children}
          </div>
        </TooltipProvider>
      </SidebarContext.Provider>
    )
  }
)
SidebarProvider.displayName = "SidebarProvider"

const Sidebar = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    side?: "left" | "right"
    variant?: "sidebar" | "floating" | "inset"
    collapsible?: "offcanvas" | "icon" | "none"
  }
>(
  (
    {
      side = "left",
      variant = "sidebar",
      collapsible = "offcanvas",
      className,
      children,
      ...props
    },
    ref
  ) => {
    const { isMobile, state, openMobile, setOpenMobile } = useSidebar()

    if (collapsible === "none") {
      return (
        <div
          className={cn(
            "flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground",
            className
          )}
          ref={ref}
          {...props}
        >
          {children}
        </div>
      )
    }

    if (isMobile) {
      return (
        <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>
          <SheetContent
            data-sidebar="sidebar"
            data-mobile="true"
            className="w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden"
            style={
              {
                "--sidebar-width": SIDEBAR_WIDTH_MOBILE,
              } as React.CSSProperties
            }
            side={side}
          >
            <div className="flex h-full w-full flex-col">{children}</div>
          </SheetContent>
        </Sheet>
      )
    }

    return (
      <div
        ref={ref}
        className="group peer hidden md:block text-sidebar-foreground"
        data-state={state}
        data-collapsible={state === "collapsed" ? collapsible : ""}
        data-variant={variant}
        data-side={side}
      >
        {/* This is what handles the sidebar gap on desktop */}
        <div
          className={cn(
            "duration-200 relative h-svh w-[--sidebar-width] bg-transparent transition-[width] ease-linear",
            "group-data-[collapsible=offcanvas]:w-0",
            "group-data-[side=right]:rotate-180",
            variant === "floating" || variant === "inset"
              ? "group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]"
              : "group-data-[collapsible=icon]:w-[--sidebar-width-icon]"
          )}
        />
        <div
          className={cn(
            "duration-200 fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] ease-linear md:flex",
            side === "left"
              ? "left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]"
              : "right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",
            // Adjust the padding for floating and inset variants.
            variant === "floating" || variant === "inset"
              ? "p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]"
              : "group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l",
            className
          )}
          {...props}
        >
          <div
            data-sidebar="sidebar"
            className="flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow"
          >
            {children}
          </div>
        </div>
      </div>
    )
  }
)
Sidebar.displayName = "Sidebar"

const SidebarTrigger = React.forwardRef<
  React.ElementRef<typeof Button>,
  React.ComponentProps<typeof Button>
>(({ className, onClick, ...props }, ref) => {
  const { toggleSidebar } = useSidebar()

  return (
    <Button
      ref={ref}
      data-sidebar="trigger"
      variant="ghost"
      size="icon"
      className={cn("h-7 w-7", className)}
      onClick={(event) => {
        onClick?.(event)
        toggleSidebar()
      }}
      {...props}
    >
      <PanelLeft />
      <span className="sr-only">Toggle Sidebar</span>
    </Button>
  )
})
SidebarTrigger.displayName = "SidebarTrigger"

const SidebarRail = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button">
>(({ className, ...props }, ref) => {
  const { toggleSidebar } = useSidebar()

  return (
    <button
      ref={ref}
      data-sidebar="rail"
      aria-label="Toggle Sidebar"
      tabIndex={-1}
      onClick={toggleSidebar}
      title="Toggle Sidebar"
      className={cn(
        "absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex",
        "[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize",
        "[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize",
        "group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar",
        "[[data-side=left][data-collapsible=offcanvas]_&]:-right-2",
        "[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",
        className
      )}
      {...props}
    />
  )
})
SidebarRail.displayName = "SidebarRail"

const SidebarInset = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"main">
>(({ className, ...props }, ref) => {
  return (
    <main
      ref={ref}
      className={cn(
        "relative flex min-h-svh flex-1 flex-col bg-background",
        "peer-data-[variant=inset]:min-h-[calc(100svh-theme(spacing.4))] md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow",
        className
      )}
      {...props}
    />
  )
})
SidebarInset.displayName = "SidebarInset"

const SidebarInput = React.forwardRef<
  React.ElementRef<typeof Input>,
  React.ComponentProps<typeof Input>
>(({ className, ...props }, ref) => {
  return (
    <Input
      ref={ref}
      data-sidebar="input"
      className={cn(
        "h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring",
        className
      )}
      {...props}
    />
  )
})
SidebarInput.displayName = "SidebarInput"

const SidebarHeader = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="header"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props}
    />
  )
})
SidebarHeader.displayName = "SidebarHeader"

const SidebarFooter = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="footer"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props}
    />
  )
})
SidebarFooter.displayName = "SidebarFooter"

const SidebarSeparator = React.forwardRef<
  React.ElementRef<typeof Separator>,
  React.ComponentProps<typeof Separator>
>(({ className, ...props }, ref) => {
  return (
    <Separator
      ref={ref}
      data-sidebar="separator"
      className={cn("mx-2 w-auto bg-sidebar-border", className)}
      {...props}
    />
  )
})
SidebarSeparator.displayName = "SidebarSeparator"

const SidebarContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="content"
      className={cn(
        "flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",
        className
      )}
      {...props}
    />
  )
})
SidebarContent.displayName = "SidebarContent"

const SidebarGroup = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="group"
      className={cn("relative flex w-full min-w-0 flex-col p-2", className)}
      {...props}
    />
  )
})
SidebarGroup.displayName = "SidebarGroup"

const SidebarGroupLabel = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & { asChild?: boolean }
>(({ className, asChild = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "div"

  return (
    <Comp
      ref={ref}
      data-sidebar="group-label"
      className={cn(
        "duration-200 flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opa] ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        "group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",
        className
      )}
      {...props}
    />
  )
})
SidebarGroupLabel.displayName = "SidebarGroupLabel"

const SidebarGroupAction = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button"> & { asChild?: boolean }
>(({ className, asChild = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      ref={ref}
      data-sidebar="group-action"
      className={cn(
        "absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 after:md:hidden",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  )
})
SidebarGroupAction.displayName = "SidebarGroupAction"

const SidebarGroupContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    data-sidebar="group-content"
    className={cn("w-full text-sm", className)}
    {...props}
  />
))
SidebarGroupContent.displayName = "SidebarGroupContent"

const SidebarMenu = React.forwardRef<
  HTMLUListElement,
  React.ComponentProps<"ul">
>(({ className, ...props }, ref) => (
  <ul
    ref={ref}
    data-sidebar="menu"
    className={cn("flex w-full min-w-0 flex-col gap-1", className)}
    {...props}
  />
))
SidebarMenu.displayName = "SidebarMenu"

const SidebarMenuItem = React.forwardRef<
  HTMLLIElement,
  React.ComponentProps<"li">
>(({ className, ...props }, ref) => (
  <li
    ref={ref}
    data-sidebar="menu-item"
    className={cn("group/menu-item relative", className)}
    {...props}
  />
))
SidebarMenuItem.displayName = "SidebarMenuItem"

const sidebarMenuButtonVariants = cva(
  "peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",
        outline:
          "bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]",
      },
      size: {
        default: "h-8 text-sm",
        sm: "h-7 text-xs",
        lg: "h-12 text-sm group-data-[collapsible=icon]:!p-0",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

const SidebarMenuButton = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button"> & {
    asChild?: boolean
    isActive?: boolean
    tooltip?: string | React.ComponentProps<typeof TooltipContent>
  } & VariantProps<typeof sidebarMenuButtonVariants>
>(
  (
    {
      asChild = false,
      isActive = false,
      variant = "default",
      size = "default",
      tooltip,
      className,
      ...props
    },
    ref
  ) => {
    const Comp = asChild ? Slot : "button"
    const { isMobile, state } = useSidebar()

    const button = (
      <Comp
        ref={ref}
        data-sidebar="menu-button"
        data-size={size}
        data-active={isActive}
        className={cn(sidebarMenuButtonVariants({ variant, size }), className)}
        {...props}
      />
    )

    if (!tooltip) {
      return button
    }

    if (typeof tooltip === "string") {
      tooltip = {
        children: tooltip,
      }
    }

    return (
      <Tooltip>
        <TooltipTrigger asChild>{button}</TooltipTrigger>
        <TooltipContent
          side="right"
          align="center"
          hidden={state !== "collapsed" || isMobile}
          {...tooltip}
        />
      </Tooltip>
    )
  }
)
SidebarMenuButton.displayName = "SidebarMenuButton"

const SidebarMenuAction = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button"> & {
    asChild?: boolean
    showOnHover?: boolean
  }
>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      ref={ref}
      data-sidebar="menu-action"
      className={cn(
        "absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 after:md:hidden",
        "peer-data-[size=sm]/menu-button:top-1",
        "peer-data-[size=default]/menu-button:top-1.5",
        "peer-data-[size=lg]/menu-button:top-2.5",
        "group-data-[collapsible=icon]:hidden",
        showOnHover &&
          "group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0",
        className
      )}
      {...props}
    />
  )
})
SidebarMenuAction.displayName = "SidebarMenuAction"

const SidebarMenuBadge = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    data-sidebar="menu-badge"
    className={cn(
      "absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground select-none pointer-events-none",
      "peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground",
      "peer-data-[size=sm]/menu-button:top-1",
      "peer-data-[size=default]/menu-button:top-1.5",
      "peer-data-[size=lg]/menu-button:top-2.5",
      "group-data-[collapsible=icon]:hidden",
      className
    )}
    {...props}
  />
))
SidebarMenuBadge.displayName = "SidebarMenuBadge"

const SidebarMenuSkeleton = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    showIcon?: boolean
  }
>(({ className, showIcon = false, ...props }, ref) => {
  // Random width between 50 to 90%.
  const width = React.useMemo(() => {
    return `${Math.floor(Math.random() * 40) + 50}%`
  }, [])

  return (
    <div
      ref={ref}
      data-sidebar="menu-skeleton"
      className={cn("rounded-md h-8 flex gap-2 px-2 items-center", className)}
      {...props}
    >
      {showIcon && (
        <Skeleton
          className="size-4 rounded-md"
          data-sidebar="menu-skeleton-icon"
        />
      )}
      <Skeleton
        className="h-4 flex-1 max-w-[--skeleton-width]"
        data-sidebar="menu-skeleton-text"
        style={
          {
            "--skeleton-width": width,
          } as React.CSSProperties
        }
      />
    </div>
  )
})
SidebarMenuSkeleton.displayName = "SidebarMenuSkeleton"

const SidebarMenuSub = React.forwardRef<
  HTMLUListElement,
  React.ComponentProps<"ul">
>(({ className, ...props }, ref) => (
  <ul
    ref={ref}
    data-sidebar="menu-sub"
    className={cn(
      "mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5",
      "group-data-[collapsible=icon]:hidden",
      className
    )}
    {...props}
  />
))
SidebarMenuSub.displayName = "SidebarMenuSub"

const SidebarMenuSubItem = React.forwardRef<
  HTMLLIElement,
  React.ComponentProps<"li">
>(({ ...props }, ref) => <li ref={ref} {...props} />)
SidebarMenuSubItem.displayName = "SidebarMenuSubItem"

const SidebarMenuSubButton = React.forwardRef<
  HTMLAnchorElement,
  React.ComponentProps<"a"> & {
    asChild?: boolean
    size?: "sm" | "md"
    isActive?: boolean
  }
>(({ asChild = false, size = "md", isActive, className, ...props }, ref) => {
  const Comp = asChild ? Slot : "a"

  return (
    <Comp
      ref={ref}
      data-sidebar="menu-sub-button"
      data-size={size}
      data-active={isActive}
      className={cn(
        "flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground",
        "data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",
        size === "sm" && "text-xs",
        size === "md" && "text-sm",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  )
})
SidebarMenuSubButton.displayName = "SidebarMenuSubButton"

export {
  Sidebar,
  SidebarContent,
  SidebarFooter,
  SidebarGroup,
  SidebarGroupAction,
  SidebarGroupContent,
  SidebarGroupLabel,
  SidebarHeader,
  SidebarInput,
  SidebarInset,
  SidebarMenu,
  SidebarMenuAction,
  SidebarMenuBadge,
  SidebarMenuButton,
  SidebarMenuItem,
  SidebarMenuSkeleton,
  SidebarMenuSub,
  SidebarMenuSubButton,
  SidebarMenuSubItem,
  SidebarProvider,
  SidebarRail,
  SidebarSeparator,
  SidebarTrigger,
  useSidebar,
}


--- START: /src/components/ui/menubar.tsx ---
"use client"

import * as React from "react"
import * as MenubarPrimitive from "@radix-ui/react-menubar"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

function MenubarMenu({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {
  return <MenubarPrimitive.Menu {...props} />
}

function MenubarGroup({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Group>) {
  return <MenubarPrimitive.Group {...props} />
}

function MenubarPortal({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {
  return <MenubarPrimitive.Portal {...props} />
}

function MenubarRadioGroup({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {
  return <MenubarPrimitive.RadioGroup {...props} />
}

function MenubarSub({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {
  return <MenubarPrimitive.Sub data-slot="menubar-sub" {...props} />
}

const Menubar = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Root
    ref={ref}
    className={cn(
      "flex h-10 items-center space-x-1 rounded-md border bg-background p-1",
      className
    )}
    {...props}
  />
))
Menubar.displayName = MenubarPrimitive.Root.displayName

const MenubarTrigger = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
      className
    )}
    {...props}
  />
))
MenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName

const MenubarSubTrigger = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <MenubarPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </MenubarPrimitive.SubTrigger>
))
MenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName

const MenubarSubContent = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
MenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName

const MenubarContent = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>
>(
  (
    { className, align = "start", alignOffset = -4, sideOffset = 8, ...props },
    ref
  ) => (
    <MenubarPrimitive.Portal>
      <MenubarPrimitive.Content
        ref={ref}
        align={align}
        alignOffset={alignOffset}
        sideOffset={sideOffset}
        className={cn(
          "z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          className
        )}
        {...props}
      />
    </MenubarPrimitive.Portal>
  )
)
MenubarContent.displayName = MenubarPrimitive.Content.displayName

const MenubarItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <MenubarPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
MenubarItem.displayName = MenubarPrimitive.Item.displayName

const MenubarCheckboxItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <MenubarPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <MenubarPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </MenubarPrimitive.ItemIndicator>
    </span>
    {children}
  </MenubarPrimitive.CheckboxItem>
))
MenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName

const MenubarRadioItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <MenubarPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <MenubarPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </MenubarPrimitive.ItemIndicator>
    </span>
    {children}
  </MenubarPrimitive.RadioItem>
))
MenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName

const MenubarLabel = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <MenubarPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
MenubarLabel.displayName = MenubarPrimitive.Label.displayName

const MenubarSeparator = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
MenubarSeparator.displayName = MenubarPrimitive.Separator.displayName

const MenubarShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn(
        "ml-auto text-xs tracking-widest text-muted-foreground",
        className
      )}
      {...props}
    />
  )
}
MenubarShortcut.displayname = "MenubarShortcut"

export {
  Menubar,
  MenubarMenu,
  MenubarTrigger,
  MenubarContent,
  MenubarItem,
  MenubarSeparator,
  MenubarLabel,
  MenubarCheckboxItem,
  MenubarRadioGroup,
  MenubarRadioItem,
  MenubarPortal,
  MenubarSubContent,
  MenubarSubTrigger,
  MenubarGroup,
  MenubarSub,
  MenubarShortcut,
}


--- START: /src/components/ui/select.tsx ---
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { Check, ChevronDown, ChevronUp } from "lucide-react"

import { cn } from "@/lib/utils"

const Select = SelectPrimitive.Root

const SelectGroup = SelectPrimitive.Group

const SelectValue = SelectPrimitive.Value

const SelectTrigger = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
      className
    )}
    {...props}
  >
    {children}
    <SelectPrimitive.Icon asChild>
      <ChevronDown className="h-4 w-4 opacity-50" />
    </SelectPrimitive.Icon>
  </SelectPrimitive.Trigger>
))
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName

const SelectScrollUpButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollUpButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronUp className="h-4 w-4" />
  </SelectPrimitive.ScrollUpButton>
))
SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName

const SelectScrollDownButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollDownButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronDown className="h-4 w-4" />
  </SelectPrimitive.ScrollDownButton>
))
SelectScrollDownButton.displayName =
  SelectPrimitive.ScrollDownButton.displayName

const SelectContent = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      className={cn(
        "relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        position === "popper" &&
          "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
        className
      )}
      position={position}
      {...props}
    >
      <SelectScrollUpButton />
      <SelectPrimitive.Viewport
        className={cn(
          "p-1",
          position === "popper" &&
            "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
        )}
      >
        {children}
      </SelectPrimitive.Viewport>
      <SelectScrollDownButton />
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
))
SelectContent.displayName = SelectPrimitive.Content.displayName

const SelectLabel = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Label
    ref={ref}
    className={cn("py-1.5 pl-8 pr-2 text-sm font-semibold", className)}
    {...props}
  />
))
SelectLabel.displayName = SelectPrimitive.Label.displayName

const SelectItem = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>

    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
))
SelectItem.displayName = SelectPrimitive.Item.displayName

const SelectSeparator = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
SelectSeparator.displayName = SelectPrimitive.Separator.displayName

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
  SelectScrollUpButton,
  SelectScrollDownButton,
}


--- START: /android/app/src/main/AndroidManifest.xml ---

<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android">

    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/AppTheme">

        <activity
            android:configChanges="orientation|keyboardHidden|keyboard|screenSize|locale|smallestScreenSize|screenLayout|uiMode|navigation"
            android:name=".MainActivity"
            android:label="@string/title_activity_main"
            android:theme="@style/AppTheme.NoActionBarLaunch"
            android:launchMode="singleTask"
            android:exported="true">

            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>

        </activity>

        <provider
            android:name="androidx.core.content.FileProvider"
            android:authorities="${applicationId}.fileprovider"
            android:exported="false"
            android:grantUriPermissions="true">
            <meta-data
                android:name="android.support.FILE_PROVIDER_PATHS"
                android:resource="@xml/file_paths"></meta-data>
        </provider>
    </application>

    <!-- Permissions Required for Flash Wallet -->
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.CAMERA" />
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.USE_BIOMETRIC" />
    <uses-permission android:name="android.permission.USE_FINGERPRINT" />
    
    <uses-feature android:name="android.hardware.camera" android:required="false" />
    <uses-feature android:name="android.hardware.fingerprint" android:required="false" />
</manifest>


--- START: /android/app/src/main/res/values/strings.xml ---
<?xml version='1.0' encoding='utf-8'?>
<resources>
    <string name="app_name">Flash Wallet</string>
    <string name="title_activity_main">Flash Wallet</string>
    <string name="package_name">com.flashwallet.eng</string>
    <string name="custom_url_scheme">com.flashwallet.eng</string>
</resources>


--- START: /android/app/src/main/res/values/styles.xml ---
<?xml version="1.0" encoding="utf-8"?>
<resources>

    <!-- Base application theme. -->
    <style name="AppTheme" parent="Theme.AppCompat.Light.DarkActionBar">
        <!-- Customize your theme here. -->
        <item name="colorPrimary">@color/colorPrimary</item>
        <item name="colorPrimaryDark">@color/colorPrimaryDark</item>
        <item name="colorAccent">@color/colorAccent</item>
    </style>

    <style name="AppTheme.NoActionBar" parent="Theme.AppCompat.DayNight.NoActionBar">
        <item name="windowActionBar">false</item>
        <item name="windowNoTitle">true</item>
        <item name="android:background">@null</item>
    </style>


    <style name="AppTheme.NoActionBarLaunch" parent="Theme.SplashScreen">
        <item name="android:background">@drawable/splash</item>
    </style>
</resources>

--- START: /android/app/src/main/res/values/ic_launcher_background.xml ---
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <color name="ic_launcher_background">#FFFFFF</color>
</resources>

--- START: /android/app/src/main/res/layout/activity_main.xml ---
<?xml version="1.0" encoding="utf-8"?>
<androidx.coordinatorlayout.widget.CoordinatorLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    tools:context=".MainActivity">

    <WebView
        android:layout_width="match_parent"
        android:layout_height="match_parent" />
</androidx.coordinatorlayout.widget.CoordinatorLayout>


--- START: /android/app/src/main/res/drawable/ic_launcher_background.xml ---
<?xml version="1.0" encoding="utf-8"?>
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    android:width="108dp"
    android:height="108dp"
    android:viewportHeight="108"
    android:viewportWidth="108">
    <path
        android:fillColor="#26A69A"
        android:pathData="M0,0h108v108h-108z" />
    <path
        android:fillColor="#00000000"
        android:pathData="M9,0L9,108"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,0L19,108"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M29,0L29,108"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M39,0L39,108"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M49,0L49,108"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M59,0L59,108"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M69,0L69,108"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M79,0L79,108"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M89,0L89,108"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M99,0L99,108"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,9L108,9"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,19L108,19"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,29L108,29"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,39L108,39"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,49L108,49"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,59L108,59"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,69L108,69"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,79L108,79"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,89L108,89"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,99L108,99"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,29L89,29"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,39L89,39"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,49L89,49"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,59L89,59"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,69L89,69"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,79L89,79"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M29,19L29,89"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M39,19L39,89"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M49,19L49,89"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M59,19L59,89"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M69,19L69,89"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
    <path
        android:fillColor="#00000000"
        android:pathData="M79,19L79,89"
        android:strokeColor="#33FFFFFF"
        android:strokeWidth="0.8" />
</vector>


--- START: /android/app/src/main/res/drawable-v24/ic_launcher_foreground.xml ---
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:aapt="http://schemas.android.com/aapt"
    android:width="108dp"
    android:height="108dp"
    android:viewportHeight="108"
    android:viewportWidth="108">
    <path
        android:fillType="evenOdd"
        android:pathData="M32,64C32,64 38.39,52.99 44.13,50.95C51.37,48.37 70.14,49.57 70.14,49.57L108.26,87.69L108,109.01L75.97,107.97L32,64Z"
        android:strokeColor="#00000000"
        android:strokeWidth="1">
        <aapt:attr name="android:fillColor">
            <gradient
                android:endX="78.5885"
                android:endY="90.9159"
                android:startX="48.7653"
                android:startY="61.0927"
                android:type="linear">
                <item
                    android:color="#44000000"
                    android:offset="0.0" />
                <item
                    android:color="#00000000"
                    android:offset="1.0" />
            </gradient>
        </aapt:attr>
    </path>
    <path
        android:fillColor="#FFFFFF"
        android:fillType="nonZero"
        android:pathData="M66.94,46.02L66.94,46.02C72.44,50.07 76,56.61 76,64L32,64C32,56.61 35.56,50.11 40.98,46.06L36.18,41.19C35.45,40.45 35.45,39.3 36.18,38.56C36.91,37.81 38.05,37.81 38.78,38.56L44.25,44.05C47.18,42.57 50.48,41.71 54,41.71C57.48,41.71 60.78,42.57 63.68,44.05L69.11,38.56C69.84,37.81 70.98,37.81 71.71,38.56C72.44,39.3 72.44,40.45 71.71,41.19L66.94,46.02ZM62.94,56.92C64.08,56.92 65,56.01 65,54.88C65,53.76 64.08,52.85 62.94,52.85C61.8,52.85 60.88,53.76 60.88,54.88C60.88,56.01 61.8,56.92 62.94,56.92ZM45.06,56.92C46.2,56.92 47.13,56.01 47.13,54.88C47.13,53.76 46.2,52.85 45.06,52.85C43.92,52.85 43,53.76 43,54.88C43,56.01 43.92,56.92 45.06,56.92Z"
        android:strokeColor="#00000000"
        android:strokeWidth="1" />
</vector>


--- START: /android/app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml ---
<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@color/ic_launcher_background"/>
    <foreground android:drawable="@mipmap/ic_launcher_foreground"/>
</adaptive-icon>

--- START: /android/app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml ---
<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@color/ic_launcher_background"/>
    <foreground android:drawable="@mipmap/ic_launcher_foreground"/>
</adaptive-icon>

--- START: /android/app/src/main/res/xml/file_paths.xml ---
<?xml version="1.0" encoding="utf-8"?>
<paths xmlns:android="http://schemas.android.com/apk/res/android">
    <external-path name="my_images" path="." />
    <cache-path name="my_cache_images" path="." />
</paths>
